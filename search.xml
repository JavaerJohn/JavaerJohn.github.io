<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>FastJsonã€JackJson ä»¥åŠ Gson çš„åŒºåˆ«</title>
      <link href="/2022/0632223.html"/>
      <url>/2022/0632223.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>FastJsonã€JackJson ä»¥åŠ Gson æ˜¯ Java ç”Ÿæ€åœˆä¸­ä¸‰ç§å¸¸ç”¨çš„ Json è§£æå™¨ï¼Œå®ƒä»¬å‡å¯å°† Java å¯¹è±¡åºåˆ—åŒ–ä¸º Json æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯å°† Json å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä»¬è®¨è®ºä¸€ä¸‹ä¸‰è€…åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œä¸­çš„ä¸€äº›åŒºåˆ«ã€‚ </p><blockquote><p>Spring Boot é»˜è®¤ä½¿ç”¨ JackJson ä½œä¸º Json è§£æå™¨ã€‚ </p></blockquote><h2 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h2><p>FastJson å’Œ JackJson ä¼šæ ¹æ® getter æ–¹æ³•ï¼ˆå¦‚ getXXXï¼‰æˆ– is æ–¹æ³•ï¼ˆå¦‚ isXXXï¼‰è·å–å±æ€§åï¼ˆXXXï¼‰ï¼Œç„¶åè°ƒç”¨ getter æ–¹æ³•æˆ– is æ–¹æ³•è·å–å±æ€§å€¼ï¼Œæœ€ç»ˆå°†å±æ€§å’Œå±æ€§å€¼æ·»åŠ åˆ° Json å­—ç¬¦ä¸²ä¸­ã€‚è€Œ Gson åˆ™æ˜¯é€šè¿‡éå†å®ä½“ç±»ä¸­çš„æ‰€æœ‰å±æ€§å¹¶ç›´æ¥è·å–å±æ€§å€¼ï¼ˆæœªè°ƒç”¨ getter æ–¹æ³•ï¼‰æ¥å®Œæˆåºåˆ—åŒ–æ“ä½œã€‚</p><blockquote><p>isXXX æ–¹æ³•ç”Ÿæ•ˆçš„å‰ææ¡ä»¶æ˜¯å…¶è¿”å›å€¼çš„ç±»å‹ä¸º boolean æˆ– Booleanã€‚</p></blockquote><p>å¼•å…¥ FashJson å’Œ Gson çš„ä¾èµ–ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.58<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.google.code.gson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.8.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºå®ä½“ç±» Userï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JsonProcessingException <span class="token punctuation">{</span>        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// FastJson åºåˆ—åŒ–</span>        String json1 <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"FastJson è§£æç»“æœ: "</span> <span class="token operator">+</span> json1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Gson åºåˆ—åŒ–</span>        Gson gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String json2 <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Gson è§£æç»“æœ: "</span> <span class="token operator">+</span> json2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// JackJson åºåˆ—åŒ–</span>        ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String json3 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JackJson è§£æç»“æœ: "</span> <span class="token operator">+</span> json3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">FastJson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token punctuation">}</span>Gson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token string">"id"</span>:1,<span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span>Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> com.fasterxml.jackson.databind.exc.InvalidDefinitionException: No serializer found <span class="token keyword">for</span> class com.example.test.User and no properties discovered to create BeanSerializer <span class="token punctuation">(</span>to avoid exception, disable SerializationFeature.FAIL_ON_EMPTY_BEANS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨ User ç±»ä¸­ï¼Œæˆ‘ä»¬å¹¶æœªæ·»åŠ ä»»ä½•çš„ getter æ–¹æ³•ï¼Œå› æ­¤ FastJson è¿”å›äº†ä¸€ä¸ª â€œç©ºä¸²â€ã€‚ç”±äº Gson ä¸ä¾èµ– getterï¼Œæ‰€ä»¥å®ƒå¯ä»¥è§£æå‡ºå®Œæ•´çš„å±æ€§ä»¥åŠå±æ€§å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè‹¥ JackJson æœªè·å–åˆ°ä»»ä½•å±æ€§ï¼ˆé€šè¿‡ getter æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆç¨‹åºå°†æŠ›å‡ºå¼‚å¸¸ã€‚æ ¹æ®æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…³é—­ <code>SerializationFeature.FAIL_ON_EMPTY_BEANS</code> æ¥å¿½ç•¥è¯¥å¼‚å¸¸ã€‚</p><p>å…³é—­ <code>SerializationFeature.FAIL_ON_EMPTY_BEANS</code>ï¼š</p><pre class="line-numbers language-java"><code class="language-java">ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>objectMapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span>SerializationFeature<span class="token punctuation">.</span>FAIL_ON_EMPTY_BEANS<span class="token punctuation">)</span><span class="token punctuation">;</span>String json3 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JackJson è§£æç»“æœ: "</span> <span class="token operator">+</span> json3<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">FastJson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token punctuation">}</span>Gson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token string">"id"</span>:1,<span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span>JackJson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æˆ‘ä»¬ä¸º User ç±»æ·»åŠ  getter æ–¹æ³•å’Œ is æ–¹æ³•ï¼Œå†æ¬¡æµ‹è¯•åºåˆ—åŒ–æ“ä½œï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> Integer <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> id<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">FastJson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token string">"id"</span>:1,<span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"JohnåŒå­¦"</span>,<span class="token string">"removed"</span>:false<span class="token punctuation">}</span>Gson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token string">"id"</span>:1,<span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span>JackJson è§£æç»“æœ: <span class="token punctuation">{</span><span class="token string">"id"</span>:1,<span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"JohnåŒå­¦"</span>,<span class="token string">"removed"</span>:false<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¯è§ï¼ŒFashJson å’Œ JackJson å‡è§£æå‡ºäº† removed å±æ€§ï¼Œè™½ç„¶è¯¥å±æ€§å¹¶æœªåœ¨ User ç±»ä¸­å®šä¹‰ï¼Œä½†ç”±äºæˆ‘ä»¬æ·»åŠ äº† isRemoved æ–¹æ³•ä¸”è¯¥æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸º booleanï¼Œå› æ­¤ removed ä¼šå‡ºç°åœ¨ Json ä¸²ä¸­ã€‚åè§‚ Gsonï¼Œå…¶ä»…ä¼šå°† User ç±»ä¸­å®šä¹‰çš„å±æ€§è¿›è¡Œåºåˆ—åŒ–ã€‚</p><h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h2><p>FastJson å’Œ JackJson ä¼šæ ¹æ® Json å­—ç¬¦ä¸²ä¸­çš„å±æ€§ï¼Œåœ¨å®ä½“ç±»ä¸­æŸ¥æ‰¾å¯¹åº”çš„ setter æ–¹æ³•æ¥ä¸ºè¯¥å±æ€§èµ‹å€¼ã€‚è‹¥æœªæŸ¥æ‰¾åˆ°å±æ€§å¯¹åº”çš„ setter æ–¹æ³•ï¼Œé‚£ä¹ˆ FastJson ä¼šå¿½ç•¥è¯¥å±æ€§ï¼ŒJackson åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒGson ä¼šæ ¹æ® Json ä¸²ä¸­çš„å±æ€§ä»¥åŠå±æ€§å€¼æ¥å¡«å……å®ä½“ç±»ä¸­å¯¹åº”çš„å±æ€§ã€‚</p><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JsonProcessingException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// FastJson ååºåˆ—åŒ–</span>        String json <span class="token operator">=</span> <span class="token string">"{\"id\":1,\"name\":\"JohnåŒå­¦\",\"removed\":false}"</span><span class="token punctuation">;</span>        User user1 <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"FastJson è§£æç»“æœ: "</span> <span class="token operator">+</span> user1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Gson ååºåˆ—åŒ–</span>        Gson gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User user2 <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Gson è§£æç»“æœ: "</span> <span class="token operator">+</span> user2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// JackJson ååºåˆ—åŒ–</span>        ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User user3 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JackJson è§£æç»“æœ: "</span> <span class="token operator">+</span> user3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">FastJson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span>Gson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span>Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field <span class="token string">"removed"</span> <span class="token punctuation">(</span>class com.example.test.User<span class="token punctuation">)</span>, not marked as ignorable <span class="token punctuation">(</span>2 known properties: <span class="token string">"id"</span>, <span class="token string">"name"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ Json ä¸²ä¸­æ·»åŠ äº†ä¸€ä¸ª User ç±»ä¸­æ²¡æœ‰çš„å±æ€§ï¼Œå³ removedã€‚FastJson å’Œ Gson å‡ä¼šå°†è¯¥å±æ€§å¿½ç•¥ï¼Œè€Œ JackJson åˆ™æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸æç¤º â€œremoved ä¸ºä¸èƒ½è¯†åˆ«çš„å±æ€§â€ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡é…ç½® ObjectMapper æ¥å¿½ç•¥è¯¥å¼‚å¸¸ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// JackJson ååºåˆ—åŒ–</span>ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>DeserializationFeature<span class="token punctuation">.</span>FAIL_ON_UNKNOWN_PROPERTIES<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>User user3 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JackJson è§£æç»“æœ: "</span> <span class="token operator">+</span> user3<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">FastJson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span>Gson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span>JackJson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è™½ç„¶ FastJson å’Œ JackJson åœ¨ååºåˆ—åŒ–æ—¶å‡ä¼šä¾èµ– setter æ–¹æ³•ï¼Œä½†äºŒè€…ä¹‹é—´ä¹Ÿå­˜åœ¨ä¸€äº›åŒºåˆ«ã€‚å¦‚æœæˆ‘ä»¬åœ¨å®ä½“ç±»ä¸­æœªæ·»åŠ æŸä¸ªå±æ€§çš„ setter æ–¹æ³•ï¼Œé‚£ä¹ˆ FastJson å°†ä¸ä¼šä¸ºè¯¥å±æ€§èµ‹å€¼ï¼Œè€Œ JackJson åˆ™ä¼šè¿›ä¸€æ­¥æŸ¥æ‰¾åŒåçš„å±æ€§ï¼Œæ¥ç€å®Œæˆèµ‹å€¼æ“ä½œã€‚ä¸‹é¢æˆ‘ä»¬æ³¨é‡Šæ‰ User ç±»ä¸­çš„ setName æ–¹æ³•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//    public void setName(String name) {</span><span class="token comment" spellcheck="true">//        this.name = name;</span><span class="token comment" spellcheck="true">//    }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å†æ¬¡æµ‹è¯•ååºåˆ—åŒ–æ“ä½œï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">FastJson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span>Gson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span>JackJson è§£æç»“æœ: User<span class="token punctuation">{</span>id<span class="token operator">=</span>1, name<span class="token operator">=</span><span class="token string">'JohnåŒå­¦'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Json </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>èŠä¸€èŠè¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨</title>
      <link href="/2022/054508.html"/>
      <url>/2022/054508.html</url>
      
        <content type="html"><![CDATA[<h2 id="è¿‡æ»¤å™¨-Filter"><a href="#è¿‡æ»¤å™¨-Filter" class="headerlink" title="è¿‡æ»¤å™¨ Filter"></a>è¿‡æ»¤å™¨ Filter</h2><blockquote><p>é¢è¯•å®˜ï¼šç”¨è¿‡è¿‡æ»¤å™¨å§ï¼Œä»‹ç»ä¸€ä¸‹è¿‡æ»¤å™¨ã€‚<br>JohnåŒå­¦ï¼ˆå¿ƒä¸­çªƒå–œï¼‰ï¼šç”¨è¿‡ï¼Œæˆ‘ç»å¸¸ç”¨å®ƒæ¥å‡€åŒ–æ°´ ğŸ˜â€¦<br>é¢è¯•å®˜ï¼šä»Šå¤©çš„é¢è¯•åˆ°æ­¤ç»“æŸï¼Œå›å»ç­‰é€šçŸ¥å§ã€‚<br>JohnåŒå­¦ï¼šğŸ™ƒâ€¦</p></blockquote><h3 id="Filter-åŸºæœ¬ä»‹ç»"><a href="#Filter-åŸºæœ¬ä»‹ç»" class="headerlink" title="Filter åŸºæœ¬ä»‹ç»"></a>Filter åŸºæœ¬ä»‹ç»</h3><p>è¿‡æ»¤å™¨ Filter æ˜¯ Sun å…¬å¸åœ¨ Servlet 2.3 è§„èŒƒä¸­æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œå…¶ä½œç”¨æ˜¯å¯¹å®¢æˆ·ç«¯å‘é€ç»™ Servlet çš„è¯·æ±‚ä»¥åŠå¯¹ Servlet è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”åšä¸€äº›å®šåˆ¶åŒ–çš„å¤„ç†ï¼Œä¾‹å¦‚æ ¡éªŒè¯·æ±‚çš„å‚æ•°ã€è®¾ç½®è¯·æ±‚/å“åº”çš„ Headerã€ä¿®æ”¹è¯·æ±‚/å“åº”çš„å†…å®¹ç­‰ã€‚</p><p>Filter å¼•å…¥äº†è¿‡æ»¤é“¾ï¼ˆFilter Chainï¼‰çš„æ¦‚å¿µï¼Œä¸€ä¸ª Web åº”ç”¨å¯ä»¥éƒ¨ç½²å¤šä¸ª Filterï¼Œè¿™äº› Filter ä¼šç»„æˆä¸€ç§é“¾å¼ç»“æ„ï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨åˆ°è¾¾ Servlet ä¹‹å‰ä¼šä¸€ç›´åœ¨è¿™ä¸ªé“¾ä¸Šä¼ é€’ï¼Œä¸åŒçš„ Filter è´Ÿè´£å¯¹è¯·æ±‚/å“åº”åšä¸åŒçš„å¤„ç†ã€‚ Filter çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/Filter%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82.jpg" alt></p><p>Filter çš„ä½œç”¨å¯è®¤ä¸ºæ˜¯å¯¹ Servlet åŠŸèƒ½çš„å¢å¼ºï¼Œå› ä¸º Filter å¯ä»¥å¯¹ç”¨æˆ·çš„è¯·æ±‚åšé¢„å¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹è¿”å›çš„å“åº”åšåå¤„ç†ï¼Œä¸”è¿™äº›å¤„ç†é€»è¾‘ä¸ Servlet çš„å¤„ç†é€»è¾‘æ˜¯åˆ†éš”å¼€çš„ï¼Œè¿™ä½¿å¾—ç¨‹åºä¸­å„éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œä»è€Œæé«˜äº†ç¨‹åºçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p><h3 id="åˆ›å»º-Filter"><a href="#åˆ›å»º-Filter" class="headerlink" title="åˆ›å»º Filter"></a>åˆ›å»º Filter</h3><p>åˆ›å»º Filter éœ€è¦å®ç° javax.servlet.Filter æ¥å£ï¼Œæˆ–è€…ç»§æ‰¿å®ç°äº† Filter æ¥å£çš„çˆ¶ç±»ã€‚Filter æ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><p>initï¼šåœ¨ Web ç¨‹åºå¯åŠ¨æ—¶è¢«è°ƒç”¨ï¼Œç”¨äºåˆå§‹åŒ– Filterã€‚</p></li><li><p>doFilterï¼šåœ¨å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°è¾¾æ—¶è¢«è°ƒç”¨ï¼ŒdoFilter æ–¹æ³•ä¸­å®šä¹‰äº† Filter çš„ä¸»è¦å¤„ç†é€»è¾‘ï¼ŒåŒæ—¶è¯¥æ–¹æ³•è¿˜è´Ÿè´£å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Filter æˆ– Servletã€‚</p></li><li><p>destroyï¼šåœ¨ Web ç¨‹åºå…³é—­æ—¶è¢«è°ƒç”¨ï¼Œç”¨äºé”€æ¯ä¸€äº›èµ„æºã€‚</p></li></ul><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡å®ç° Filter æ¥å£æ¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ Filterï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>FilterConfig filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>filterConfig<span class="token punctuation">.</span><span class="token function">getFilterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" è¢«åˆå§‹åŒ–"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest servletRequest<span class="token punctuation">,</span> ServletResponse servletResponse<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>        HttpServletRequest request <span class="token operator">=</span> <span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter æ‹¦æˆªåˆ°äº†è¯·æ±‚: "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter å¯¹è¯·æ±‚åšé¢„å¤„ç†..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter ä¿®æ”¹å“åº”çš„å†…å®¹..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter è¢«å›æ”¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>init æ–¹æ³•çš„ filterConfig å‚æ•°å°è£…äº†å½“å‰ Filter çš„é…ç½®ä¿¡æ¯ï¼Œåœ¨ Filter åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬å°† Filter çš„åç§°æ‰“å°åœ¨æ§åˆ¶å°ã€‚</p></li><li><p>doFilter æ–¹æ³•å®šä¹‰äº† Filter æ‹¦æˆªåˆ°ç”¨æˆ·è¯·æ±‚åçš„å¤„ç†é€»è¾‘ï¼Œ<code>filterChain.doFilter(servletRequest, servletResponse);</code> æŒ‡çš„æ˜¯å°†è¯·æ±‚ä¼ é€’ç»™ä¸€ä¸‹ä¸ª Filter æˆ– Servletï¼Œå¦‚æœä¸æ·»åŠ è¯¥è¯­å¥ï¼Œé‚£ä¹ˆè¯·æ±‚å°±ä¸ä¼šå‘åä¼ é€’ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šè¢«å¤„ç†ã€‚åœ¨è¯¥è¯­å¥ä¹‹åï¼Œå¯ä»¥æ·»åŠ å¯¹å“åº”çš„å¤„ç†é€»è¾‘ï¼ˆå¦‚æœè¦ä¿®æ”¹å“åº”çš„ Headerï¼Œå¯ç›´æ¥åœ¨è¯¥è¯­å¥ä¹‹å‰ä¿®æ”¹ï¼›å¦‚æœè¦ä¿®æ”¹å“åº”çš„å†…å®¹ï¼Œåˆ™éœ€è¦åœ¨è¯¥è¯­å¥ä¹‹åï¼Œä¸”éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª responseï¼‰ã€‚</p></li><li><p>destroy æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¾“å‡º â€œFilter è¢«å›æ”¶â€ çš„æç¤ºä¿¡æ¯ã€‚</p></li></ul><h3 id="é…ç½®-Filter"><a href="#é…ç½®-Filter" class="headerlink" title="é…ç½® Filter"></a>é…ç½® Filter</h3><p>Spring é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>@Configuration + @Bean + FilterRegistrationBean</code> å¯¹ Filter è¿›è¡Œé…ç½®ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> FilterRegistrationBean<span class="token operator">&lt;</span>TestFilter<span class="token operator">></span> <span class="token function">registryFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        FilterRegistrationBean<span class="token operator">&lt;</span>TestFilter<span class="token operator">></span> registration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"TestFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> registration<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼ŒsetFilter æ–¹æ³•ç”¨äºè®¾ç½® Filter çš„ç±»å‹ï¼›addUrlPatterns æ–¹æ³•ç”¨äºè®¾ç½®æ‹¦æˆªçš„è§„åˆ™ï¼›setName æ–¹æ³•ç”¨äºè®¾ç½® Filter çš„åç§°ï¼›setOrder æ–¹æ³•ç”¨äºè®¾ç½® Filter çš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><h3 id="æµ‹è¯•-Filter"><a href="#æµ‹è¯•-Filter" class="headerlink" title="æµ‹è¯• Filter"></a>æµ‹è¯• Filter</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„ Web æœåŠ¡ï¼Œæµ‹è¯• Filter æ˜¯å¦ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨å¤„ç†è¯·æ±‚..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¯·æ±‚å¤„ç†å®Œæˆ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"I'm fine, thank you."</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>localhost:8080/hello</code>ï¼Œç­‰å¾…è¯·æ±‚å¤„ç†å®Œæˆï¼Œç„¶åå…³é—­é¡¹ç›®ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶å°ä¾æ¬¡æ‰“å°äº†å¦‚ä¸‹ä¿¡æ¯ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/TestFilter.jpg" alt></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰çš„ TestFilter å®ç°äº†æ‹¦æˆªè¯·æ±‚ã€å¤„ç†å“åº”çš„ç›®æ ‡ã€‚</p><h3 id="åˆ›å»º-Filter-çš„å…¶å®ƒæ–¹å¼"><a href="#åˆ›å»º-Filter-çš„å…¶å®ƒæ–¹å¼" class="headerlink" title="åˆ›å»º Filter çš„å…¶å®ƒæ–¹å¼"></a>åˆ›å»º Filter çš„å…¶å®ƒæ–¹å¼</h3><p><strong>1. @WebFilter æ³¨è§£ + åŒ…æ‰«æ</strong></p><p>é™¤äº† FilterRegistrationBean å¤–ï¼ŒServlet 3.0 å¼•å…¥çš„æ³¨è§£ @WebFilter ä¹Ÿå¯ç”¨äºé…ç½® Filterã€‚æˆ‘ä»¬åªéœ€è¦åœ¨è‡ªå®šä¹‰çš„ Filter ç±»ä¸Šæ·»åŠ è¯¥æ³¨è§£ï¼Œå°±å¯ä»¥è®¾ç½® Filter çš„åç§°å’Œæ‹¦æˆªè§„åˆ™ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span>urlPatterns <span class="token operator">=</span> <span class="token string">"/*"</span><span class="token punctuation">,</span> filterName <span class="token operator">=</span> <span class="token string">"TestFilter"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äº@WebFilter å¹¶é Spring æä¾›ï¼Œå› æ­¤è‹¥è¦ä½¿è‡ªå®šä¹‰çš„ Filter ç”Ÿæ•ˆï¼Œè¿˜éœ€åœ¨é…ç½®ç±»ä¸Šæ·»åŠ  @ServletComponetScan æ³¨è§£ï¼Œå¹¶æŒ‡å®šæ‰«æçš„åŒ…ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token annotation punctuation">@ServletComponentScan</span><span class="token punctuation">(</span><span class="token string">"com.example.filter"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoApplication</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>DemoApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>@WebFilter æ³¨è§£å¹¶ä¸å…è®¸æˆ‘ä»¬è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºï¼Œä¸”åœ¨ Filter ç±»ä¸Šæ·»åŠ  @Order æ³¨è§£ä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚å¦‚æœé¡¹ç›®ä¸­æœ‰å¤šä¸ªè¢« @WebFilter ä¿®é¥°çš„ Filterï¼Œé‚£ä¹ˆè¿™äº› Filter çš„æ‰§è¡Œé¡ºåºç”±å…¶ â€œç±»åçš„å­—å…¸åºâ€ å†³å®š</strong>ï¼Œä¾‹å¦‚ç±»åä¸º â€œAxxâ€ çš„ Filter çš„æ‰§è¡Œé¡ºåºè¦å…ˆäºç±»åä¸º â€œBxxâ€ çš„ Filterã€‚</p><blockquote><p>æ·»åŠ äº† @WebFilter æ³¨è§£åå°±ä¸è¦å†æ·»åŠ  @Component æ³¨è§£äº†ï¼Œå¦‚æœéƒ½æ·»åŠ ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåˆ›å»ºä¸¤ä¸ª Filterã€‚</p></blockquote><p><strong>2. @Component æ³¨è§£</strong></p><p>Spring é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ  @Component æ³¨è§£å°†è‡ªå®šä¹‰çš„ Bean äº¤ç»™ Spring å®¹å™¨ç®¡ç†ã€‚åŒæ ·çš„ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ Filterï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ·»åŠ  @Component æ³¨è§£ä½¿å…¶ç”Ÿæ•ˆï¼Œè€Œä¸”è¿˜å¯ä»¥æ·»åŠ  @Order æ³¨è§£æ¥è®¾ç½®ä¸åŒ Filter çš„æ‰§è¡Œé¡ºåºã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤ç§é…ç½®æ–¹å¼ä¸€èˆ¬ä¸å¸¸ä½¿ç”¨ï¼Œå› ä¸ºå…¶æ— æ³•è®¾ç½® Filter çš„æ‹¦æˆªè§„åˆ™ï¼Œé»˜è®¤çš„æ‹¦æˆªè·¯å¾„ä¸º <code>/*</code>ã€‚è™½ç„¶ä¸èƒ½é…ç½®æ‹¦æˆªè§„åˆ™ï¼Œä½†æˆ‘ä»¬å¯ä»¥åœ¨ doFilter æ–¹æ³•ä¸­å®šä¹‰è¯·æ±‚çš„æ”¾è¡Œè§„åˆ™ï¼Œä¾‹å¦‚å½“è¯·æ±‚çš„ URL åŒ¹é…æˆ‘ä»¬è®¾ç½®çš„è§„åˆ™æ—¶ï¼Œç›´æ¥å°†è¯¥è¯·æ±‚æ”¾è¡Œï¼Œä¹Ÿå°±æ˜¯ç«‹å³æ‰§è¡Œ <code>filterChain.doFilter(servletRequest, servletResponse);</code>ã€‚</p><p><strong>3. ç»§æ‰¿ OncePerRequestFilter</strong></p><p>OncePerRequestFilter æ˜¯ä¸€ä¸ªç”± Spring æä¾›çš„æŠ½è±¡ç±»ï¼Œåœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç»§æ‰¿ OncePerRequestFilter çš„æ–¹å¼åˆ›å»º Filterï¼Œç„¶åé‡å†™ doFilterInternal æ–¹æ³•å®šä¹‰ Filter çš„å¤„ç†é€»è¾‘ï¼Œé‡å†™ shouldNotFilter æ–¹æ³•è®¾ç½® Filter çš„æ”¾è¡Œè§„åˆ™ã€‚å¯¹äºå¤šä¸ª Filter çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ  @Order æ³¨è§£è¿›è¡Œè®¾ç½®ã€‚å½“ç„¶ï¼Œè‹¥è¦ä½¿ Filter ç”Ÿæ•ˆï¼Œè¿˜éœ€æ·»åŠ  @Component æ³¨è§£å°†å…¶æ³¨å†Œåˆ° Spring å®¹å™¨ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CSpringFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¤„ç†é€»è¾‘</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">shouldNotFilter</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ”¾è¡Œè§„åˆ™</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®é™…ä¸Šï¼Œæ–¹å¼ 2 å’Œæ–¹å¼ 3 æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå› ä¸º OncePerRequestFilter åº•å±‚ä¹Ÿæ˜¯é€šè¿‡å®ç° Filter æ¥å£æ¥è¾¾åˆ°è¿‡æ»¤è¯·æ±‚/å“åº”çš„ç›®çš„ï¼Œåªä¸è¿‡ Spring åœ¨ OncePerRequestFilter ä¸­å¸®æˆ‘ä»¬å°è£…äº†è®¸å¤šåŠŸèƒ½ï¼Œå› æ­¤æ›´æ¨èé‡‡ç”¨æ­¤ç§æ–¹å¼åˆ›å»º Filterã€‚</p><h3 id="Filter-çš„ä¼˜å…ˆçº§"><a href="#Filter-çš„ä¼˜å…ˆçº§" class="headerlink" title="Filter çš„ä¼˜å…ˆçº§"></a>Filter çš„ä¼˜å…ˆçº§</h3><p>ä¸Šæ–‡ä¸­æåˆ°ï¼Œä½¿ç”¨é…ç½®ç±»æˆ–æ·»åŠ  @Order æ³¨è§£å¯ä»¥æ˜¾å¼çš„è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºï¼Œä¿®æ”¹ç±»åå¯ä»¥éšå¼çš„è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºã€‚å¦‚æœé¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ª Filterï¼Œä¸”è¿™äº› Filter ç”±ä¸åŒçš„æ–¹å¼åˆ›å»ºï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p><p>èƒ½å¤Ÿç¡®å®šçš„æ˜¯ï¼ŒSpring æ ¹æ® Filter çš„ order å†³å®šå…¶ä¼˜å…ˆçº§ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡é…ç½®ç±»æˆ–è€…é€šè¿‡ @Order æ³¨è§£è®¾ç½®äº† Filter çš„ orderï¼Œé‚£ä¹ˆ <strong>order å€¼è¶Šå°çš„ Filter çš„ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ— è®º Filter ç”±ä½•ç§æ–¹å¼åˆ›å»º</strong>ã€‚å¦‚æœå¤šä¸ª Filter çš„ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆæ‰§è¡Œé¡ºåºä¸ºï¼š</p><ol><li><p>é…ç½®ç±»ä¸­é…ç½®çš„ Filter ä¼˜å…ˆæ‰§è¡Œï¼Œå¦‚æœé…ç½®ç±»ä¸­å­˜åœ¨å¤šä¸ª Filterï¼Œé‚£ä¹ˆ Spring æŒ‰ç…§å…¶åœ¨é…ç½®ç±»ä¸­é…ç½®çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</p></li><li><p>@WebFilter æ³¨è§£ä¿®é¥°çš„ Filter ä¹‹åæ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨å¤šä¸ª Filterï¼Œé‚£ä¹ˆ Spring æŒ‰ç…§å…¶ç±»åçš„å­—å…¸åºä¾æ¬¡æ‰§è¡Œã€‚</p></li><li><p>@Component æ³¨è§£ä¿®é¥°çš„ Filter æœ€åæ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨å¤šä¸ª Filterï¼Œé‚£ä¹ˆ Spring æŒ‰ç…§å…¶ç±»åçš„å­—å…¸åºä¾æ¬¡æ‰§è¡Œã€‚</p></li></ol><p>æ³¨æ„ï¼Œä»¥ä¸Šä¼˜å…ˆçº§é¡ºåºä»…é€‚ç”¨äº order ç›¸åŒçš„ç‰¹æ®Šæƒ…å†µã€‚å¦‚æœæˆ‘ä»¬ä¸é…ç½® Filter çš„ orderï¼Œé‚£ä¹ˆ Spring é»˜è®¤å°†å…¶ order è®¾ç½®ä¸º <code>LOWEST_PRECEDENCE = Integer.MAX_VALUE</code>ï¼Œä¹Ÿå°±æ˜¯æœ€ä½ä¼˜å…ˆçº§ã€‚ç”±äºè¢« @WebFilter æ³¨è§£ä¿®é¥°çš„ Filter æ— æ³•æ˜¾å¼é…ç½®ä¼˜å…ˆçº§ï¼Œå› æ­¤å…¶ order ä¸º Integer.MAX_VALUEã€‚æœ¬æ–‡æ‰€è¯´çš„ Filter çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯ Filter å¯¹è¯·æ±‚åšé¢„å¤„ç†çš„ä¼˜å…ˆçº§ï¼Œå¯¹å“åº”åšåå¤„ç†çš„ä¼˜å…ˆçº§ä¸ä¹‹ç›¸åã€‚</p><blockquote><p>ä»¥ä¸Šç»“è®ºç”±ç¬”è€…ç»è¿‡æµ‹è¯•ä»¥åŠé˜…è¯»æºç å¾—å‡ºï¼Œå¦‚æœ‰ç†è§£é”™è¯¯ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ ğŸ˜ã€‚å…³äºæºç éƒ¨åˆ†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹ ServletContextInitializerBeans ç±»å’Œ AnnotationAwareOrderComparator ç±»çš„æºç ï¼Œç¬”è€…åœ¨è¿™é‡Œå°±ä¸å…·ä½“åˆ†æäº† ğŸ˜ˆã€‚</p></blockquote><!-- è¿™äº› Filter çš„åˆå§‹åŒ–é¡ºåºç”± filterNameï¼ˆé»˜è®¤ä¸ºç±»åçš„é¦–å­—æ¯å°å†™ï¼‰çš„ hash å€¼å†³å®š --><h3 id="Filter-çš„åº”ç”¨åœºæ™¯"><a href="#Filter-çš„åº”ç”¨åœºæ™¯" class="headerlink" title="Filter çš„åº”ç”¨åœºæ™¯"></a>Filter çš„åº”ç”¨åœºæ™¯</h3><p>Filter çš„å¸¸è§åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p><ul><li><p>è§£å†³è·¨åŸŸè®¿é—®ï¼šå‰åç«¯åˆ†ç¦»çš„é¡¹ç›®å¾€å¾€å­˜åœ¨è·¨åŸŸè®¿é—®çš„é—®é¢˜ï¼ŒFilter å…è®¸æˆ‘ä»¬åœ¨ response çš„ Header ä¸­è®¾ç½® â€œAccess-Control-Allow-Originâ€ã€â€Access-Control-Allow-Methodsâ€ ç­‰å¤´åŸŸï¼Œä»¥æ­¤è§£å†³è·¨åŸŸå¤±è´¥é—®é¢˜ã€‚</p></li><li><p>è®¾ç½®å­—ç¬¦ç¼–ç ï¼šå­—ç¬¦ç¼–ç  Filter å¯ä»¥åœ¨ request æäº¤åˆ° Servlet ä¹‹å‰æˆ–è€…åœ¨ response è¿”å›ç»™å®¢æˆ·ç«¯ä¹‹å‰ä¸ºè¯·æ±‚/å“åº”è®¾ç½®ç‰¹å®šçš„ç¼–ç æ ¼å¼ï¼Œä»¥è§£å†³è¯·æ±‚/å“åº”å†…å®¹ä¹±ç çš„é—®é¢˜ã€‚</p></li><li><p>è®°å½•æ—¥å¿—ï¼šæ—¥å¿—è®°å½• Filter å¯ä»¥åœ¨æ‹¦æˆªåˆ°è¯·æ±‚åï¼Œè®°å½•è¯·æ±‚çš„ IPã€è®¿é—®çš„ URLï¼Œæ‹¦æˆªåˆ°å“åº”åè®°å½•è¯·æ±‚çš„å¤„ç†æ—¶é—´ã€‚å½“ä¸éœ€è¦è®°å½•æ—¥å¿—æ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°† Filter çš„é…ç½®æ³¨é‡Šæ‰ã€‚</p></li><li><p>æ ¡éªŒæƒé™ï¼šWeb æœåŠ¡ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨å‘é€è¯·æ±‚æ—¶ä¼šæºå¸¦ cookie æˆ–è€… token è¿›è¡Œèº«ä»½è®¤è¯ï¼Œæƒé™æ ¡éªŒ Filter å¯ä»¥åœ¨ request æäº¤åˆ° Servlet ä¹‹å‰å¯¹ cookie æˆ– token è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœç”¨æˆ·æœªç™»å½•æˆ–è€…æƒé™ä¸å¤Ÿï¼Œé‚£ä¹ˆ Filter å¯ä»¥å¯¹è¯·æ±‚åšé‡å®šå‘æˆ–è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</p></li><li><p>æ›¿æ¢å†…å®¹ï¼šå†…å®¹æ›¿æ¢ Filter å¯ä»¥å¯¹ç½‘ç«™çš„å†…å®¹è¿›è¡Œæ§åˆ¶ï¼Œé˜²æ­¢è¾“å…¥/è¾“å‡ºéæ³•å†…å®¹å’Œæ•æ„Ÿä¿¡æ¯ã€‚ä¾‹å¦‚åœ¨è¯·æ±‚åˆ°è¾¾ Servlet ä¹‹å‰å¯¹è¯·æ±‚çš„å†…å®¹è¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢ XSS æ”»å‡»ï¼›åœ¨ Servlet å°†å†…å®¹è¾“å‡ºåˆ° response æ—¶ï¼Œä½¿ç”¨ response å°†å†…å®¹ç¼“å­˜èµ·æ¥ï¼Œç„¶ååœ¨ Filter ä¸­è¿›è¡Œæ›¿æ¢ï¼Œæœ€åå†è¾“å‡ºåˆ°å®¢æˆ·æµè§ˆå™¨ï¼ˆç”±äºé»˜è®¤çš„ response å¹¶ä¸èƒ½ä¸¥æ ¼çš„ç¼“å­˜è¾“å‡ºå†…å®¹ï¼Œå› æ­¤éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªå…·å¤‡ç¼“å­˜åŠŸèƒ½çš„ responseï¼‰ã€‚</p></li></ul><blockquote><p>Filter åº”ç”¨åœºæ™¯çš„ç›¸å…³å†…å®¹å‚è€ƒè‡ªã€ŠJava Web æ•´åˆå¼€å‘ä¹‹ç‹è€…å½’æ¥ã€‹ï¼Œå¥½ä¸­äºŒçš„ä¹¦å ğŸ¤£ï¼Œå…³äºè‡ªå®šä¹‰å…·å¤‡ç¼“å­˜åŠŸèƒ½çš„ response å¯å‚è€ƒè¯¥ä¹¦çš„ P175ã€‚</p></blockquote><h3 id="Filter-çš„å®ç°åŸç†"><a href="#Filter-çš„å®ç°åŸç†" class="headerlink" title="Filter çš„å®ç°åŸç†"></a>Filter çš„å®ç°åŸç†</h3><p>äº†è§£äº† Filter çš„ä½¿ç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ Filter çš„å®ç°åŸç†ã€‚ä¸Šæ–‡ä¸­æåˆ°ï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚ä¼šåœ¨è¿‡æ»¤é“¾ä¸Šä¾æ¬¡ä¼ é€’ï¼Œé“¾ä¸Šçš„æ¯ä¸ª Filter éƒ½ä¼šè°ƒç”¨ doFilter æ–¹æ³•å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚è¿™ä¸ªè¿‡ç¨‹èƒ½å¤Ÿæœ‰æ¡ä¸ç´Šçš„è¿›è¡Œï¼Œåº•å±‚ä¾é çš„æ˜¯å‡½æ•°çš„å›è°ƒæœºåˆ¶ã€‚</p><p><strong>1. å›è°ƒå‡½æ•°</strong></p><p>åœ¨ä»‹ç» Filter çš„å›è°ƒæœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹å›è°ƒå‡½æ•°çš„æ¦‚å¿µã€‚å¦‚æœå°†å‡½æ•°ï¼ˆC++ ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼ŒJava ä¸­çš„åŒ¿åå‡½æ•°ã€æ–¹æ³•å¼•ç”¨ç­‰ï¼‰ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸»æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±ç§°ä¸ºå›è°ƒå‡½æ•°ï¼Œä¸»æ–¹æ³•ä¼šåœ¨æŸä¸€æ—¶åˆ»è°ƒç”¨å›è°ƒå‡½æ•°ã€‚</p><blockquote><p>ä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨ â€œä¸»æ–¹æ³•â€ å’Œ â€œå‡½æ•°â€ æ¥åˆ†è¾¨ä¸»å‡½æ•°å’Œå›è°ƒå‡½æ•°ã€‚</p></blockquote><p>ä½¿ç”¨å›è°ƒå‡½æ•°çš„å¥½å¤„æ˜¯èƒ½å¤Ÿå®ç°å‡½æ•°é€»è¾‘çš„è§£è€¦ï¼Œä¸»æ–¹æ³•å†…å¯ä»¥å®šä¹‰é€šç”¨çš„å¤„ç†é€»è¾‘ï¼Œéƒ¨åˆ†ç‰¹å®šçš„æ“ä½œåˆ™äº¤ç»™å›è°ƒå‡½æ•°æ¥å®Œæˆã€‚ä¾‹å¦‚ Java ä¸­ Arrays ç±»çš„ <code>sort(T[] a, Comparator&lt;? super T&gt; c)</code> æ–¹æ³•å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ¯”è¾ƒå™¨æ¥è‡ªå®šä¹‰æ’åºè§„åˆ™ï¼Œè¿™ä¸ªæ¯”è¾ƒå™¨çš„ compare æ–¹æ³•å°±å±äºå›è°ƒå‡½æ•°ï¼Œsort æ–¹æ³•ä¼šåœ¨æ’åºæ—¶è°ƒç”¨ compare æ–¹æ³•ã€‚</p><p><strong>2. Filter çš„å›è°ƒæœºåˆ¶</strong></p><p>æ¥ä¸‹æ¥ä»‹ç» Filter çš„å›è°ƒæœºåˆ¶ï¼Œä¸Šæ–‡ä¸­æåˆ°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ xxFilter ç±»éœ€è¦å®ç° Filter æ¥å£ï¼Œä¸”éœ€è¦é‡å†™ doFilter æ–¹æ³•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest servletRequest<span class="token punctuation">,</span> ServletResponse servletResponse<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ...</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Filter æ¥å£çš„ doFilter æ–¹æ³•æ¥æ”¶ä¸€ä¸ª FilterChain ç±»å‹çš„å‚æ•°ï¼Œè¿™ä¸ª FilterChain å¯¹è±¡å¯è®¤ä¸ºæ˜¯ä¼ é€’ç»™ doFilter æ–¹æ³•çš„å›è°ƒå‡½æ•°ï¼Œä¸¥æ ¼æ¥è¯´åº”è¯¥æ˜¯è¿™ä¸ª FilterChain å¯¹è±¡çš„ doFilter æ–¹æ³•ï¼Œæ³¨æ„è¿™é‡Œæåˆ°äº†ä¸¤ä¸ª doFilter æ–¹æ³•ã€‚Filter æ¥å£çš„ doFilter æ–¹æ³•åœ¨æ‰§è¡Œç»“æŸæˆ–æ‰§è¡Œå®ŒæŸäº›æ­¥éª¤åä¼šè°ƒç”¨ FilterChain å¯¹è±¡çš„ doFilter æ–¹æ³•ï¼Œå³è°ƒç”¨å›è°ƒå‡½æ•°ã€‚</p><p>FilterChain å¯¹è±¡çš„å®é™…ç±»å‹ä¸º ApplicationFilterChainï¼Œå…¶ doFilter() æ–¹æ³•çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼ˆçœç•¥éƒ¨åˆ†ä»£ç ï¼‰ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationFilterChain</span> <span class="token keyword">implements</span> <span class="token class-name">FilterChain</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest request<span class="token punctuation">,</span> ServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token function">internalDoFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">internalDoFilter</span><span class="token punctuation">(</span>ServletRequest request<span class="token punctuation">,</span> ServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è·å–ç¬¬ pos ä¸ª filter, å³ xxFilter  </span>            ApplicationFilterConfig filterConfig <span class="token operator">=</span> filters<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                   Filter filter <span class="token operator">=</span> filterConfig<span class="token punctuation">.</span><span class="token function">getFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ...</span>            <span class="token comment" spellcheck="true">// è°ƒç”¨ xxFilter çš„ doFilter æ–¹æ³•</span>            filter<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯è§ï¼ŒApplicationFilterChain çš„ doFilter æ–¹æ³•é¦–å…ˆæ ¹æ®ç´¢å¼•æŸ¥è¯¢åˆ°æˆ‘ä»¬å®šä¹‰çš„ xxFilterï¼Œç„¶åè°ƒç”¨ xxFilter çš„ doFilter æ–¹æ³•ï¼Œåœ¨è°ƒç”¨æ—¶ï¼ŒApplicationFilterChain ä¼šå°†è‡ªå·±ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚xxFilter çš„ doFilter æ–¹æ³•æ‰§è¡Œå®ŒæŸäº›æ­¥éª¤åï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå³ ApplicationFilterChain çš„ doFilter æ–¹æ³•ï¼Œè¿™æ · ApplicationFilterChain å°±å¯ä»¥è·å–åˆ°ä¸‹ä¸€ä¸ª xxFilterï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ª xxFilter çš„ doFilter æ–¹æ³•ï¼Œå¦‚æ­¤å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰çš„ xxFilter å…¨éƒ¨è¢«è°ƒç”¨ã€‚æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6.jpg" alt></p><blockquote><p>xxFilter æ‰§è¡Œå›è°ƒå‡½æ•°çš„è¿‡ç¨‹å°±åƒæ˜¯ç»™äº† ApplicationFilterChain ä¸€ä¸ªé€šçŸ¥ï¼Œå³é€šçŸ¥ ApplicationFilterChain å¯ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ª xxFilter çš„å¤„ç†é€»è¾‘äº†ã€‚</p></blockquote><p>ç»¼ä¸Šï¼Œå¦‚æœæˆ‘ä»¬åœ¨é‡å†™è‡ªå®šä¹‰ Filter çš„ doFilter æ–¹æ³•æ—¶æ²¡æœ‰æ·»åŠ  <code>filterChain.doFilter(servletRequest, servletResponse);</code>ï¼Œé‚£ä¹ˆè¯¥ Filter ä¹‹åçš„å…¶å®ƒ Filter å’Œ Servlet å°±ä¸ä¼šè¢«è°ƒç”¨ã€‚</p><h2 id="æ‹¦æˆªå™¨-Interceptor"><a href="#æ‹¦æˆªå™¨-Interceptor" class="headerlink" title="æ‹¦æˆªå™¨ Interceptor"></a>æ‹¦æˆªå™¨ Interceptor</h2><h3 id="Interceptor-åŸºæœ¬ä»‹ç»"><a href="#Interceptor-åŸºæœ¬ä»‹ç»" class="headerlink" title="Interceptor åŸºæœ¬ä»‹ç»"></a>Interceptor åŸºæœ¬ä»‹ç»</h3><blockquote><p>æœ¬æ–‡æ‰€è¯´çš„æ‹¦æˆªå™¨æŒ‡çš„æ˜¯ Spring MVC ä¸­çš„æ‹¦æˆªå™¨ã€‚</p></blockquote><p>æ‹¦æˆªå™¨ Interceptor æ˜¯ Spring MVC ä¸­çš„é«˜çº§ç»„ä»¶ä¹‹ä¸€ï¼Œå…¶ä½œç”¨æ˜¯æ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†å‰ååšä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ï¼Œå¦‚æ ¡éªŒæƒé™ã€è®°å½•æ—¥å¿—ç­‰ã€‚è¿™ä¸€ç‚¹å’Œ Filter éå¸¸ç›¸ä¼¼ï¼Œä½†ä¸åŒçš„æ˜¯ï¼ŒFilter åœ¨è¯·æ±‚åˆ°è¾¾ Servlet ä¹‹å‰å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œè€Œ Interceptor åˆ™æ˜¯åœ¨è¯·æ±‚åˆ°è¾¾ Controller ä¹‹å‰å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå“åº”ä¹ŸåŒç†ã€‚</p><p>ä¸ Filter ä¸€æ ·ï¼ŒInterceptor ä¹Ÿå…·å¤‡é“¾å¼ç»“æ„ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¯ä»¥é…ç½®å¤šä¸ª Interceptorï¼Œå½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œæ¯ä¸ª Interceptor æ ¹æ®å…¶å£°æ˜çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</p><h3 id="åˆ›å»º-Interceptor"><a href="#åˆ›å»º-Interceptor" class="headerlink" title="åˆ›å»º Interceptor"></a>åˆ›å»º Interceptor</h3><p>åˆ›å»º Interceptor éœ€è¦å®ç° org.springframework.web.servlet.HandlerInterceptor æ¥å£ï¼ŒHandlerInterceptor æ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><p>preHandleï¼šåœ¨ Controller æ–¹æ³•æ‰§è¡Œå‰è¢«è°ƒç”¨ï¼Œå¯ä»¥å¯¹è¯·æ±‚åšé¢„å¤„ç†ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª boolean å˜é‡ï¼Œåªæœ‰å½“è¿”å›å€¼ä¸º true æ—¶ï¼Œç¨‹åºæ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</p></li><li><p>postHandleï¼šåœ¨ Controller æ–¹æ³•æ‰§è¡Œç»“æŸï¼ŒDispatcherServlet è¿›è¡Œè§†å›¾æ¸²æŸ“ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•å†…å¯ä»¥æ“ä½œ Controller å¤„ç†åçš„ ModelAndView å¯¹è±¡ã€‚</p></li><li><p>afterCompletionï¼šåœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†å®Œæˆï¼ˆåŒ…æ‹¬è§†å›¾æ¸²æŸ“ï¼‰åè¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨æ¥æ¸…ç†èµ„æºã€‚</p></li></ul><p>æ³¨æ„ï¼ŒpostHandle æ–¹æ³•å’Œ afterCompletion æ–¹æ³•æ‰§è¡Œçš„å‰ææ¡ä»¶æ˜¯ preHandle æ–¹æ³•çš„è¿”å›å€¼ä¸º trueã€‚</p><p>ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Interceptorï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Interceptor æ‹¦æˆªåˆ°äº†è¯·æ±‚: "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> ModelAndView modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Interceptor æ“ä½œ modelAndView..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> Exception ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Interceptor æ¸…ç†èµ„æº..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é…ç½®-Interceptor"><a href="#é…ç½®-Interceptor" class="headerlink" title="é…ç½® Interceptor"></a>é…ç½® Interceptor</h3><p>Interceptor éœ€è¦æ³¨å†Œåˆ° Spring å®¹å™¨æ‰èƒ½å¤Ÿç”Ÿæ•ˆï¼Œæ³¨å†Œçš„æ–¹æ³•æ˜¯åœ¨é…ç½®ç±»ä¸­å®ç° WebMvcConfigurer æ¥å£ï¼Œå¹¶é‡å†™ addInterceptors æ–¹æ³•:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestInterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> TestInterceptor testInterceptor<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span>InterceptorRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>testInterceptor<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼ŒaddInterceptor æ–¹æ³•ç”¨äºæ³¨å†Œ Interceptorï¼›addPathPatterns æ–¹æ³•ç”¨äºè®¾ç½®æ‹¦æˆªè§„åˆ™ï¼›excludePathPatterns æ–¹æ³•ç”¨äºè®¾ç½®æ”¾è¡Œè§„åˆ™ï¼Œorder æ–¹æ³•ç”¨äºè®¾ç½® Interceptor çš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><h3 id="æµ‹è¯•-Interceptor"><a href="#æµ‹è¯•-Interceptor" class="headerlink" title="æµ‹è¯• Interceptor"></a>æµ‹è¯• Interceptor</h3><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ Web æœåŠ¡ï¼Œæ¥æµ‹è¯• Interceptor æ˜¯å¦ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨å¤„ç†è¯·æ±‚..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¯·æ±‚å¤„ç†å®Œæˆ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"I'm fine, thank you."</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>localhost:8080/hello</code>ï¼Œè¯·æ±‚å¤„ç†å®Œæˆåï¼Œæ§åˆ¶å°æ‰“å°äº†å¦‚ä¸‹ä¿¡æ¯ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/TestInterceptor.jpg" alt></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒInterceptor æˆåŠŸæ‹¦æˆªåˆ°äº†è®¿é—® Controller çš„ <code>/hello</code> è¯·æ±‚å’Œè®¿é—®é™æ€èµ„æºçš„ <code>/favicon.ico</code> è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†å‰åæ‰§è¡Œäº†ç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚</p><p>å½“éœ€è¦è®¾ç½®å¤šä¸ª Interceptor æ—¶ï¼Œå¯ä»¥ç›´æ¥åœ¨é…ç½®ç±»ä¸­æ·»åŠ  Interceptor çš„é…ç½®è§„åˆ™ï¼Œä¾‹å¦‚å¢åŠ  TestInterceptor2ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestInterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> TestInterceptor testInterceptor<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> TestInterceptor2 testInterceptor2<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span>InterceptorRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>testInterceptor<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>testInterceptor2<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Interceptor çš„æ‰§è¡Œé¡ºåºç”±å…¶é…ç½®çš„ order å†³å®šï¼Œorder è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼Œæ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯ preHandle æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼ŒpostHandle å’Œ afterCompletion çš„æ‰§è¡Œé¡ºåºä¸ preHandle ç›¸å</strong>ï¼Œä¾‹å¦‚åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæ‰§è¡Œé¡ºåºä¸ºï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/%E5%A4%9A%E4%B8%AAInterceptor.jpg" alt></p><p>å¦‚æœæˆ‘ä»¬ä¸é…ç½® orderï¼Œé‚£ä¹ˆ Spring é»˜è®¤å°† order è®¾ç½®ä¸º 0ï¼ˆå¯ä»¥æŸ¥çœ‹ InterceptorRegistration ç±»çš„æºç ï¼‰ã€‚<strong>å¦‚æœä¸åŒçš„ Interceptor å…·æœ‰ç›¸åŒçš„ orderï¼Œé‚£ä¹ˆå…¶æ‰§è¡Œé¡ºåºä¸ºé…ç½®ç±»ä¸­çš„æ³¨å†Œé¡ºåº</strong>ã€‚</p><h3 id="Interceptor-çš„åº”ç”¨åœºæ™¯"><a href="#Interceptor-çš„åº”ç”¨åœºæ™¯" class="headerlink" title="Interceptor çš„åº”ç”¨åœºæ™¯"></a>Interceptor çš„åº”ç”¨åœºæ™¯</h3><p>Interceptor çš„åº”ç”¨åœºå¯ä»¥å‚è€ƒä¸Šæ–‡ä¸­ä»‹ç»çš„ Filter çš„åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥è¯´ Filter èƒ½åšåˆ°çš„äº‹ Interceptor éƒ½èƒ½åšã€‚ç”±äº Filter åœ¨ Servlet å‰åèµ·ä½œç”¨ï¼Œè€Œ Interceptor å¯ä»¥åœ¨ Controller æ–¹æ³•å‰åèµ·ä½œç”¨ï¼Œä¾‹å¦‚æ“ä½œ Controller å¤„ç†åçš„ ModelAndViewï¼Œå› æ­¤ Interceptor æ›´åŠ çµæ´»ï¼Œåœ¨ Spring é¡¹ç›®ä¸­ï¼Œå¦‚æœèƒ½ä½¿ç”¨ Interceptor çš„è¯å°½é‡ä½¿ç”¨ Interceptorã€‚</p><h3 id="Interceptor-çš„å®ç°åŸç†"><a href="#Interceptor-çš„å®ç°åŸç†" class="headerlink" title="Interceptor çš„å®ç°åŸç†"></a>Interceptor çš„å®ç°åŸç†</h3><p>äº†è§£äº† Interceptor çš„ä½¿ç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿæ¥åˆ†æä¸€ä¸‹ Interceptor çš„å®ç°åŸç†ã€‚Interceptor çš„è°ƒç”¨å‘ç”Ÿåœ¨ DispatcherServlet çš„ doDispatch æ–¹æ³•ä¸­ï¼ŒDispatcherServlet æ˜¯ Spring MVC ä¸­è¯·æ±‚çš„ç»Ÿä¸€å…¥å£ï¼Œå½“å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°è¾¾æ—¶ï¼ŒDispatcherServlet ä¼šè°ƒç”¨ doDispatch æ–¹æ³•å¤„ç†å½“å‰è¯·æ±‚ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doDispatch</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç </span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        ModelAndView mv <span class="token operator">=</span> null<span class="token punctuation">;</span>        Exception dispatchException <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            processedRequest <span class="token operator">=</span> <span class="token function">checkMultipart</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            multipartRequestParsed <span class="token operator">=</span> <span class="token punctuation">(</span>processedRequest <span class="token operator">!=</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚æŸ¥æ‰¾å¤„ç†é“¾ HandlerExecutionChain</span>            mappedHandler <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">noHandlerFound</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// è·å–é€‚é…å™¨ HandlerAdapter, HandlerAdapter ç”¨äºå¤„ç†è¯·æ±‚</span>            HandlerAdapter ha <span class="token operator">=</span> <span class="token function">getHandlerAdapter</span><span class="token punctuation">(</span>mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç </span>            <span class="token comment" spellcheck="true">// ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„ preHandle æ–¹æ³•</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedHandler<span class="token punctuation">.</span><span class="token function">applyPreHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æ‰§è¡Œ Controller æ–¹æ³•, è¿”å› ModelAndView</span>            mv <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">applyDefaultViewName</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„ postHandle æ–¹æ³•, é¡ºåºå’Œ preHandle æ–¹æ³•ç›¸å</span>            mappedHandler<span class="token punctuation">.</span><span class="token function">applyPostHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            dispatchException <span class="token operator">=</span> ex<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>            dispatchException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NestedServletException</span><span class="token punctuation">(</span><span class="token string">"Handler dispatch failed"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è¿›è¡Œè§†å›¾æ¸²æŸ“, ç»“æŸåæ‰§è¡Œæ‹¦æˆªå™¨çš„ afterCompletion æ–¹æ³•</span>        <span class="token function">processDispatchResult</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> mv<span class="token punctuation">,</span> dispatchException<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”Ÿå¼‚å¸¸, é‚£ä¹ˆæ‰§è¡Œæ‹¦æˆªå™¨çš„ afterCompletion æ–¹æ³•å¹¶æŠ›å‡ºå¼‚å¸¸</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">NestedServletException</span><span class="token punctuation">(</span><span class="token string">"Handler processing failed"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><p>é¦–å…ˆè·å–å½“å‰è¯·æ±‚å¯¹åº”çš„å¤„ç†é“¾ HandlerExecutionChainï¼Œ<strong>HandlerExecutionChain ä¸­åŒ…å«äº†å½“å‰è¯·æ±‚åŒ¹é…çš„ Interceptor åˆ—è¡¨</strong>ã€‚</p></li><li><p>ç„¶åæ ¹æ® HandlerExecutionChain è·å–é€‚é…å™¨ HandlerAdapterï¼ŒHandlerAdapter ç”¨äºå¤„ç†å½“å‰è¯·æ±‚ã€‚</p></li><li><p>ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰ Interceptor çš„ preHandle æ–¹æ³•ï¼Œå¦‚æœæŸä¸ª preHandle æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆç¨‹åºå°†ä¸å†å‘ä¸‹æ‰§è¡Œã€‚</p></li><li><p>è°ƒç”¨ HandlerAdapter å¤„ç†è¯·æ±‚ï¼Œè¿”å› ModelAndViewã€‚</p></li><li><p>è¯·æ±‚å¤„ç†å®Œæˆåï¼Œä¾æ¬¡æ‰§è¡Œæ‰€æœ‰ Interceptor çš„ postHandle æ–¹æ³•ï¼Œæ‰§è¡Œçš„é¡ºåºä¸ preHandle æ–¹æ³•ç›¸åã€‚</p></li><li><p>è¿›è¡Œè§†å›¾æ¸²æŸ“ï¼Œæ¸²æŸ“ç»“æŸåæ‰§è¡Œæ‰€æœ‰ Interceptor çš„ afterCompletion æ–¹æ³•ï¼Œæ‰§è¡Œé¡ºåºä¸ postHandle æ–¹æ³•ç›¸åŒã€‚</p></li><li><p>å¦‚æœä»¥ä¸Šæ“ä½œå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆæ‰§è¡Œæ‰€æœ‰ Interceptor çš„ afterCompletion æ–¹æ³•å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</p></li></ol><blockquote><p>ç”±ä¸Šè¿°è¿‡ç¨‹æˆ‘ä»¬å¾—çŸ¥ï¼Œå¦‚æœ Controller æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆ postHandle æ–¹æ³•å°†ä¸ä¼šæ‰§è¡Œï¼ŒafterCompletion æ–¹æ³•åˆ™ä¸€å®šæ‰§è¡Œã€‚</p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹ getHandler æ–¹æ³•ï¼ˆDispatcherServlet ç±»ä¸­å®šä¹‰çš„ï¼‰èƒŒåçš„é€»è¾‘ï¼Œçœ‹çœ‹ Interceptor æ˜¯å¦‚ä½•åŠ è½½åˆ°ï¼ˆæˆ–è€…è¯´æ˜¯å°è£…åˆ°ï¼‰HandlerExecutionChain ä¸­çš„ã€‚getHandler æ–¹æ³•é¦–å…ˆéå†æ‰€æœ‰çš„ HandlerMappingï¼Œç„¶åæ‰¾åˆ°åŒ¹é…å½“å‰è¯·æ±‚çš„ HandlerMappingï¼Œå¹¶è°ƒç”¨è¯¥ HandlerMapping çš„ getHandler æ–¹æ³•è·å– HandlerExecutionChainï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/handlerMapping%E8%8E%B7%E5%8F%96handler.png" alt></p><p>æ­¤å¤„çš„ â€œåŒ¹é…å½“å‰è¯·æ±‚çš„ HandlerMappingâ€ æŒ‡çš„æ˜¯ RequestMappingHandlerMappingï¼Œå…¶åœ¨ WebMvcConfigurationSupport ç±»ä¸­å®Œæˆåˆå§‹åŒ–ï¼Œä¸”åˆå§‹åŒ–æ—¶ä¼šåŠ è½½ Interceptorï¼ŒåŠ è½½çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/RequestMappingHandlerMapping%E5%8A%A0%E8%BD%BD%E6%8B%A6%E6%88%AA%E5%99%A8.png" alt></p><ol><li><p>RequestMappingHandlerMapping åœ¨åŠ è½½ Interceptor ä¹‹å‰éœ€è¦å…ˆè°ƒç”¨ getInterceptors æ–¹æ³•è·å– Interceptorã€‚</p></li><li><p>getInterceptors æ–¹æ³•éœ€è¦è°ƒç”¨ addInterceptors æ–¹æ³•å°† Interceptor å°è£…åˆ° registryï¼ˆInterceptorRegistry å¯¹è±¡ï¼‰ä¸­ã€‚</p></li><li><p>addInterceptors æ–¹æ³•æ²¿è°ƒç”¨é“¾å‘ä¸‹å¯è¿½è¸ªåˆ° WebMvcConfigurerComposite ç±»çš„ addInterceptors æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œæˆ‘ä»¬åœ¨é…ç½®ç±»ä¸­é‡å†™çš„ addInterceptors æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‰€æœ‰ Interceptor éƒ½ä¼šåŠ è½½åˆ° registry ä¸­ã€‚</p></li><li><p>å›åˆ° getInterceptors æ–¹æ³•ï¼Œæ‰§è¡Œ <code>registry.getInterceptors();</code> å°±å¯ä»¥ä» registry ä¸­è·å–åˆ° Interceptor äº†ã€‚</p></li></ol><p>ä»¥ä¸Šæ˜¯ RequestMappingHandlerMapping åŠ è½½ Interceptor çš„è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­åˆ†æ RequestMappingHandlerMapping çš„ getHandler æ–¹æ³•ï¼Œäº†è§£ Interceptor æ˜¯å¦‚ä½•ä» RequestMappingHandlerMapping åŠ è½½åˆ° HandlerExecutionChain ä¸­çš„ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/%E6%8B%A6%E6%88%AA%E5%99%A8%E5%8A%A0%E8%BD%BD%E5%88%B0HandlerExecutionChain.png" alt></p><ol><li><p>RequestMappingHandlerMapping çš„ getHandler æ–¹æ³•åœ¨å…¶çˆ¶ç±» AbstractHandlerMapping ä¸­å®šä¹‰ï¼ŒgetHandler æ–¹æ³•ä¼šè°ƒç”¨ getHandlerExecutionChain æ–¹æ³•è·å– HandlerExecutionChainã€‚</p></li><li><p>getHandlerExecutionChain æ–¹æ³•ä¸­æœ‰ä¸€æ®µä»£ç çš„å¤„ç†é€»è¾‘æ˜¯éå†å½“å‰ HandlerMappingï¼ˆRequestMappingHandlerMappingï¼‰åŠ è½½çš„ Interceptorï¼Œå¦‚æœæŸä¸ª Interceptor ä¸å½“å‰è¯·æ±‚åŒ¹é…ï¼Œé‚£ä¹ˆå°†å…¶æ·»åŠ åˆ° HandlerExecutionChainã€‚MappedInterceptor æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ Interceptor çš„ç±»å‹ï¼Œregistry åœ¨åŠ è½½ Interceptor æ—¶ä¼šå°†å…¶å°è£…ä¸º MappedInterceptor å¯¹è±¡ã€‚</p></li></ol><p>HandlerExecutionChain åŠ è½½åˆ° Interceptor åï¼Œå°±å¯ä»¥è°ƒç”¨ preHandle ç­‰æ–¹æ³•å¯¹è¯·æ±‚/å“åº”è¿›è¡Œå¤„ç†ã€‚</p><blockquote><p>ä¹‹æ‰€ä»¥èŠ±è´¹è¾ƒå¤šçš„ç¯‡å¹…åˆ†æ Interceptor çš„å®ç°åŸç†ï¼Œæ˜¯å› ä¸ºè®¸å¤šæ–‡ç« éƒ½æœ‰è®²åˆ° Interceptor æ˜¯åŸºäº Java çš„åå°„æœºåˆ¶ï¼ˆåŠ¨æ€ä»£ç†ï¼‰æ¥å®ç°çš„ï¼Œç¬”è€…ä¹‹å‰åœ¨ä»‹ç» Interceptor æ—¶ä¹Ÿæ˜¯è¿™æ ·å†™çš„ ğŸ˜‚ï¼Œçœ‹äº†æºç åæ‰çŸ¥é“è¿™ç§è¯´æ³•æ˜¯ä¸æ­£ç¡®çš„ï¼Œæ„Ÿè°¢æ˜é‡‘ä¸Šçš„å°ä¼™ä¼´æŒ‡å‡ºæˆ‘æ–‡ç« çš„é”™è¯¯ä¹‹å¤„ ğŸ‘ã€‚</p></blockquote><h2 id="Filter-å’Œ-Interceptor-çš„åŒºåˆ«"><a href="#Filter-å’Œ-Interceptor-çš„åŒºåˆ«" class="headerlink" title="Filter å’Œ Interceptor çš„åŒºåˆ«"></a>Filter å’Œ Interceptor çš„åŒºåˆ«</h2><p><strong>1. è§„èŒƒä¸åŒ</strong></p><p>Filter åœ¨ Servlet è§„èŒƒä¸­å®šä¹‰ï¼Œä¾èµ–äº Servlet å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰ï¼›Interceptor ç”± Spring å®šä¹‰ï¼Œä¾èµ–äº Spring å®¹å™¨ï¼ˆIoC å®¹å™¨ï¼‰ã€‚</p><p><strong>2. é€‚ç”¨èŒƒå›´ä¸åŒ</strong></p><p>Filter ä»…å¯ç”¨äº Web ç¨‹åºï¼Œå› ä¸ºå…¶ä¾èµ–äº Servlet å®¹å™¨ï¼›Interceptor ä¸ä»…å¯ä»¥ç”¨äº Web ç¨‹åºï¼Œè¿˜å¯ä»¥ç”¨äº Applicationã€Swing ç­‰ç¨‹åºã€‚ </p><p><strong>3. è§¦å‘æ—¶æœºä¸åŒ</strong></p><p>Filter åœ¨è¯·æ±‚è¿›å…¥ Servlet å®¹å™¨ï¼Œä¸”åˆ°è¾¾ Servlet ä¹‹å‰å¯¹è¯·æ±‚åšé¢„å¤„ç†ï¼›åœ¨ Servlet å¤„ç†å®Œè¯·æ±‚åå¯¹å“åº”åšåå¤„ç†ã€‚</p><p>Interceptor åœ¨è¯·æ±‚è¿›å…¥ Servletï¼Œä¸”åˆ°è¾¾ Controller ä¹‹å‰å¯¹è¯·æ±‚åšé¢„å¤„ç†ï¼›åœ¨ Controller å¤„ç†å®Œè¯·æ±‚åå¯¹ ModelAndView åšåå¤„ç†ï¼Œåœ¨è§†å›¾æ¸²æŸ“å®Œæˆåå†åšä¸€äº›æ”¶å°¾å·¥ä½œã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†äºŒè€…çš„è§¦å‘æ—¶æœºï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Filter_Interceptor/%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E5%8E%9F%E7%90%86.jpg" alt></p><p>å½“ Filter å’Œ Interceptor åŒæ—¶å­˜åœ¨æ—¶ï¼ŒFilter å¯¹è¯·æ±‚çš„é¢„å¤„ç†è¦å…ˆäº Interceptor çš„ preHandle æ–¹æ³•ï¼›Filter å¯¹å“åº”çš„åå¤„ç†è¦åäº Interceptor çš„ postHandle æ–¹æ³•å’Œ afterCompletion æ–¹æ³•ã€‚</p><h2 id="å…³äº-Filter-å’Œ-Interceptor-çš„è¡¥å……è¯´æ˜"><a href="#å…³äº-Filter-å’Œ-Interceptor-çš„è¡¥å……è¯´æ˜" class="headerlink" title="å…³äº Filter å’Œ Interceptor çš„è¡¥å……è¯´æ˜"></a>å…³äº Filter å’Œ Interceptor çš„è¡¥å……è¯´æ˜</h2><p><strong>1. åœ¨ Filter å’Œ Interceptor æ³¨å…¥ Bean çš„æ³¨æ„äº‹é¡¹</strong></p><p>æœ‰äº›æ–‡ç« åœ¨ä»‹ç» Filter å’Œ Interceptor çš„åŒºåˆ«æ—¶å¼ºè°ƒ Filter ä¸èƒ½é€šè¿‡ IoC æ³¨å…¥ Beanï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨æœ¬æ–‡ä¸­çš„ç¬¬ä¸€ç§åˆ›å»º Filterï¼Œé‚£ä¹ˆç¡®å®ä¸èƒ½æ³¨å…¥æˆåŠŸï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// è‡ªå®šä¹‰çš„ Filter, æœªæ·»åŠ  @Component æ³¨è§£</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest servletRequest<span class="token punctuation">,</span> ServletResponse servletResponse<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>        HttpServletRequest request <span class="token operator">=</span> <span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span><span class="token punctuation">;</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// é…ç½®ç±»</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> FilterRegistrationBean<span class="token operator">&lt;</span>TestFilter<span class="token operator">></span> <span class="token function">registryFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        FilterRegistrationBean<span class="token operator">&lt;</span>TestFilter<span class="token operator">></span> registration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"TestFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> registration<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç æ‰§è¡Œåï¼ŒuserService è¾“å‡ºä¸º nullï¼Œå› ä¸ºæ³¨å†Œåˆ° IoC å®¹å™¨ä¸­çš„æ˜¯ new å‡ºæ¥çš„ä¸€ä¸ª TestFilter å¯¹è±¡ï¼ˆ<code>registration.setFilter(new TestFilter());</code>ï¼‰ï¼Œå¹¶ä¸æ˜¯ Spring è‡ªåŠ¨è£…é…çš„ã€‚è‹¥è¦ä½¿ userService æ³¨å…¥æˆåŠŸï¼Œå¯æ”¹ä¸ºå¦‚ä¸‹å†™æ³•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// è‡ªå®šä¹‰çš„ Filter, æœªæ·»åŠ  @Component æ³¨è§£</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest servletRequest<span class="token punctuation">,</span> ServletResponse servletResponse<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>        HttpServletRequest request <span class="token operator">=</span> <span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span><span class="token punctuation">;</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// é…ç½®ç±»</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> TestFilter testFilter<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> FilterRegistrationBean<span class="token operator">&lt;</span>TestFilter<span class="token operator">></span> <span class="token function">registryFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        FilterRegistrationBean<span class="token operator">&lt;</span>TestFilter<span class="token operator">></span> registration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span>testFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"TestFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registration<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> registration<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ç¬¬ä¸€ç§å†™æ³•çš„åŒºåˆ«åœ¨äºï¼ŒTestFilter ç±»ä¸Šæ·»åŠ äº† @Component æ³¨è§£ï¼Œä¸”é…ç½®ç±»ä¸­é€šè¿‡ @Autowired æ³¨å…¥ TestFilter å¯¹è±¡ã€‚é™¤äº†ä½¿ç”¨é…ç½®ç±»å¤–ï¼Œæœ¬æ–‡ä»‹ç»çš„å…¶å®ƒå‡ ç§æ–¹å¼ï¼ˆæ·»åŠ  @Component æ³¨è§£æˆ– @WebFilter æ³¨è§£ï¼‰éƒ½å¯ä»¥ç›´æ¥æ³¨å…¥ Beanã€‚</p><blockquote><p>æ‰€ä»¥è¿˜æ˜¯é‡‡ç”¨ç»§æ‰¿ OncePerRequestFilter çš„æ–¹å¼åˆ›å»º Filter æ¯”è¾ƒæ–¹ä¾¿ã€‚</p></blockquote><p>å¦å¤–ï¼Œä½¿ç”¨æœ¬æ–‡ä»‹ç»çš„åˆ›å»º Interceptor çš„å†™æ³•æ˜¯å¯ä»¥ç›´æ¥æ³¨å…¥ Bean çš„ï¼Œè¯¥å†™æ³•ä¹Ÿæ˜¯å…ˆåœ¨è‡ªå®šä¹‰çš„ Interceptor ä¸Šæ·»åŠ  @Component æ³¨è§£ï¼Œç„¶ååœ¨é…ç½®ç±»ä¸­ä½¿ç”¨ @Autowired æ³¨å…¥è‡ªå®šä¹‰çš„ Interceptorã€‚</p><p><strong>2. Interceptor å¯ä»¥æ‹¦æˆªé™æ€è¯·æ±‚</strong></p><p>æœ‰æ–‡ç« æåˆ° Interceptor ä¸èƒ½æ‹¦æˆªé™æ€è¯·æ±‚ï¼Œå…¶å®åœ¨ Spring 1.x çš„ç‰ˆæœ¬ä¸­ç¡®å®æ˜¯è¿™æ ·çš„ï¼Œä½† Spring 2.x å¯¹é™æ€èµ„æºä¹Ÿè¿›è¡Œäº†æ‹¦æˆªï¼Œä¾‹å¦‚ä¸Šæ–‡ä¸­æˆ‘ä»¬åœ¨æµ‹è¯• TestInterceptor æ˜¯å¦ç”Ÿæ•ˆæ—¶ï¼Œå‘ç°å…¶æ‹¦æˆªåˆ°äº† <code>/favicon.ico</code> è¯·æ±‚ï¼Œè¯¥è¯·æ±‚æ˜¯ä¸€ä¸ªç”±æµè§ˆå™¨è‡ªåŠ¨å‘é€çš„é™æ€è¯·æ±‚ã€‚</p><p><strong>3. Interceptor ä¸æ˜¯åŸºäº Java çš„åå°„æœºåˆ¶ï¼ˆåŠ¨æ€ä»£ç†ï¼‰æ¥å®ç°çš„</strong></p><p>è¯¦è§ä¸Šæ–‡ä¸­ Interceptor çš„å®ç°åŸç†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>ä¹¦ç±ï¼šã€ŠJava web æ•´åˆå¼€å‘ç‹è€…å½’æ¥ã€‹<br><a href="https://www.cnblogs.com/paddix/p/8365558.html" target="_blank" rel="noopener">Spring Boot å®æˆ˜ï¼šæ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨</a><br><a href="https://juejin.cn/post/6844904179958284301" target="_blank" rel="noopener">è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨çš„ 6 ä¸ªåŒºåˆ«ï¼Œåˆ«å†å‚»å‚»åˆ†ä¸æ¸…äº†</a></p>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MVC å’Œä¸‰å±‚æ¶æ„</title>
      <link href="/2022/051052.html"/>
      <url>/2022/051052.html</url>
      
        <content type="html"><![CDATA[<h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p>MVC æ˜¯ä¸€ç§åˆ†å±‚è®¾è®¡çš„è½¯ä»¶å¼€å‘æ¶æ„æ¨¡å¼ï¼Œå…¶å°†æ•´ä¸ªä¸šåŠ¡åº”ç”¨åˆ’åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ul><li><p>Viewï¼šè§†å›¾å±‚ï¼Œè´Ÿè´£ç•Œé¢çš„å±•ç¤ºï¼Œä¸ç”¨æˆ·ç›´æ¥äº¤äº’ã€‚ç”¨æˆ·å¯åœ¨è§†å›¾å±‚æ‰§è¡Œç›¸å…³çš„æ“ä½œï¼Œå¦‚æŸ¥çœ‹æ•°æ®æˆ–æäº¤è¡¨å•ç­‰ï¼ˆå‘é€è¯·æ±‚ï¼‰ï¼Œè§†å›¾å±‚ä¼šå‘ç”¨æˆ·å±•ç¤ºæ“ä½œçš„ç»“æœã€‚</p></li><li><p>Controllerï¼šæ§åˆ¶å™¨å±‚ï¼Œè´Ÿè´£æ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚å§”æ‰˜ç»™ Model å±‚å¤„ç†ã€‚æ¥æ”¶åˆ° Model å±‚å¤„ç†çš„ç»“æœåï¼ŒController ä¼šé€‰æ‹©åˆé€‚çš„è§†å›¾ï¼Œå¹¶å°†å¤„ç†ç»“æœäº¤ä»˜ç»™è¯¥è§†å›¾ã€‚å¯¹äºæŸäº›è¯·æ±‚ï¼ŒController è¿˜è´Ÿè´£åšè¯·æ±‚çš„è½¬å‘æˆ–é‡å®šå‘ã€‚</p></li><li><p>Modelï¼šæ¨¡å‹å±‚ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·çš„ä¸šåŠ¡è¯·æ±‚ä»¥åŠä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚å½“ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆåï¼ŒModel å±‚ä¼šå°†å¤„ç†çš„ç»“æœè¿”å›ç»™ Controllerã€‚</p></li></ul><p>MVC æ¨¡å¼ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/Web/MVC/MVC%E5%92%8C%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84.jpg" alt></p><p>MVC æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ol><li><p>ä½è€¦åˆï¼šé™ä½äº†å±‚ä¸å±‚ä¹‹é—´çš„ä¾èµ–ï¼Œå¼€å‘äººå‘˜å¯åªå…³æ³¨å…¶ä¸­çš„æŸä¸€å±‚ã€‚</p></li><li><p>é«˜å¤ç”¨ï¼šä¸åŒçš„è§†å›¾ã€æ§åˆ¶å™¨å¯å¤ç”¨åŒä¸€å¥—ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚</p></li><li><p>å¯ç»´æŠ¤ï¼šåˆ†ç¦»ä¸åŒçš„ç»„ä»¶æœ‰åˆ©äºæé«˜ç¨‹åºçš„å¯ç»´æŠ¤æ€§ã€‚</p></li></ol><p>MCV æ¨¡å¼çš„ç¼ºç‚¹ï¼š</p><ol><li><p>é«˜å¤æ‚åº¦ï¼šä¸¥æ ¼éµå®ˆ MVC æ¨¡å¼å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›å†—ä½™æ“ä½œï¼Œå°¤å…¶æ˜¯åœ¨å°å‹é¡¹ç›®ä¸­ã€‚</p></li><li><p>ä½æ•ˆç‡ï¼šç”±äº Model ç§°é‡ä¸åŒçš„æ¥å£è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œå› æ­¤è§†å›¾å¯èƒ½éœ€è¦å¤šæ¬¡è°ƒç”¨æ‰èƒ½è·å–åˆ°å…¨éƒ¨çš„æ•°æ®ã€‚å¯¹æœªå˜åŒ–æ•°æ®çš„ä¸å¿…è¦çš„é¢‘ç¹è®¿é—®ï¼Œä¹Ÿå°†é™ä½ç³»ç»Ÿæ€§èƒ½ã€‚</p></li></ol><h2 id="ä¸‰å±‚æ¶æ„"><a href="#ä¸‰å±‚æ¶æ„" class="headerlink" title="ä¸‰å±‚æ¶æ„"></a>ä¸‰å±‚æ¶æ„</h2><p>ä¸‰å±‚æ¶æ„æŒ‡çš„æ˜¯å°†è½¯ä»¶è®¾è®¡åˆ’åˆ†ä¸ºè¡¨ç°å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ä»¥åŠæ•°æ®è®¿é—®å±‚ï¼š</p><ul><li><p>è¡¨ç°å±‚ï¼šä¸ç”¨æˆ·ç›´æ¥äº¤äº’ï¼Œæä¾›å±•ç¤ºæ•°æ®çš„ç•Œé¢ã€‚åŒæ—¶è´Ÿè´£æ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†è¯·æ±‚ï¼Œè¯·æ±‚å¤„ç†å®Œæˆåå‘ç”¨æˆ·å±•ç¤ºå¤„ç†çš„ç»“æœã€‚</p></li><li><p>ä¸šåŠ¡é€»è¾‘å±‚ï¼šå®šä¹‰ä¸šåŠ¡çš„å¤„ç†é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ Service å±‚ã€‚</p></li><li><p>æ•°æ®è®¿é—®å±‚ï¼šæä¾›è®¿é—®å’Œæ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œå³ Dao å±‚ã€‚</p></li></ul><p>MVC ä¸­çš„ Model å°±æ˜¯ä¸‰å±‚æ¶æ„ä¸­çš„ä¸šåŠ¡é€»è¾‘å±‚å’Œæ•°æ®è®¿é—®å±‚ï¼›ä¸‰å±‚æ¶æ„ä¸­çš„è¡¨ç°å±‚å°±æ˜¯ MVC ä¸­çš„ View å’Œ Controllerã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java è¯­è¨€å®ç°ç®€æ˜“ç‰ˆæ‰«ç ç™»å½•</title>
      <link href="/2022/0410823.html"/>
      <url>/2022/0410823.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>ç›¸ä¿¡å¤§å®¶å¯¹äºŒç»´ç éƒ½ä¸é™Œç”Ÿï¼Œç”Ÿæ´»ä¸­åˆ°å¤„å……æ–¥ç€æ‰«ç ç™»å½•çš„åœºæ™¯ï¼Œå¦‚ç™»å½•ç½‘é¡µç‰ˆå¾®ä¿¡ã€æ”¯ä»˜å®ç­‰ã€‚æœ€è¿‘å­¦ä¹ äº†ä¸€ä¸‹æ‰«ç ç™»å½•çš„åŸç†ï¼Œæ„Ÿè§‰è›®æœ‰è¶£çš„ï¼Œäºæ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆæ‰«ç ç™»å½•çš„ Demoï¼Œä»¥æ­¤è®°å½•ä¸€ä¸‹å­¦ä¹ è¿‡ç¨‹ã€‚</p><blockquote><p>å®é™…ä¸Šæ˜¯é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°äº† ï¿£â–³ï¿£ï¼</p></blockquote><h2 id="åŸç†è§£æ"><a href="#åŸç†è§£æ" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h2><p><strong>1. èº«ä»½è®¤è¯æœºåˆ¶</strong></p><p>åœ¨ä»‹ç»æ‰«ç ç™»å½•çš„åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠä¸€èŠæœåŠ¡ç«¯çš„èº«ä»½è®¤è¯æœºåˆ¶ã€‚ä»¥æ™®é€šçš„ <code>è´¦å· + å¯†ç </code> ç™»å½•æ–¹å¼ä¸ºä¾‹ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°ç”¨æˆ·çš„ç™»å½•è¯·æ±‚åï¼Œé¦–å…ˆéªŒè¯è´¦å·ã€å¯†ç çš„åˆæ³•æ€§ã€‚å¦‚æœéªŒè¯é€šè¿‡ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¼šä¸ºç”¨æˆ·åˆ†é…ä¸€ä¸ª tokenï¼Œè¯¥ token ä¸ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ç›¸å…³è”ï¼Œå¯ä½œä¸ºç”¨æˆ·çš„ç™»å½•å‡­è¯ã€‚ä¹‹å PC ç«¯å†æ¬¡å‘é€è¯·æ±‚æ—¶ï¼Œéœ€è¦åœ¨è¯·æ±‚çš„ Header æˆ–è€… Query å‚æ•°ä¸­æºå¸¦ tokenï¼ŒæœåŠ¡ç«¯æ ¹æ® token ä¾¿å¯è¯†åˆ«å‡ºå½“å‰ç”¨æˆ·ã€‚token çš„ä¼˜ç‚¹æ˜¯æ›´åŠ æ–¹ä¾¿ã€å®‰å…¨ï¼Œå®ƒé™ä½äº†è´¦å·å¯†ç è¢«åŠ«æŒçš„é£é™©ï¼Œè€Œä¸”ç”¨æˆ·ä¸éœ€è¦é‡å¤åœ°è¾“å…¥è´¦å·å’Œå¯†ç ã€‚PC ç«¯é€šè¿‡è´¦å·å’Œå¯†ç ç™»å½•çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/PC%E7%AB%AF%E9%AA%8C%E8%AF%81.jpg" alt></p><p>æ‰«ç ç™»å½•æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§èº«ä»½è®¤è¯æ–¹å¼ï¼Œ<code>è´¦å· + å¯†ç </code> ç™»å½•ä¸æ‰«ç ç™»å½•çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…æ˜¯åˆ©ç”¨ PC ç«¯çš„è´¦å·å’Œå¯†ç ä¸º PC ç«¯ç”³è¯·ä¸€ä¸ª tokenï¼Œåè€…æ˜¯åˆ©ç”¨ <code>æ‰‹æœºç«¯çš„ token + è®¾å¤‡ä¿¡æ¯</code> ä¸º PC ç«¯ç”³è¯·ä¸€ä¸ª tokenã€‚è¿™ä¸¤ç§ç™»å½•æ–¹å¼çš„ç›®çš„ç›¸åŒï¼Œéƒ½æ˜¯ä¸ºäº†ä½¿ PC ç«¯è·å¾—æœåŠ¡ç«¯çš„ â€œæˆæƒâ€ï¼Œåœ¨ä¸º PC ç«¯ç”³è¯· token ä¹‹å‰ï¼ŒäºŒè€…éƒ½éœ€è¦å‘æœåŠ¡ç«¯è¯æ˜è‡ªå·±çš„èº«ä»½ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»è®©æœåŠ¡ç«¯çŸ¥é“å½“å‰ç”¨æˆ·æ˜¯è°ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰èƒ½ä¸ºå…¶ç”Ÿæˆ PC ç«¯ tokenã€‚ç”±äºæ‰«ç å‰æ‰‹æœºç«¯ä¸€å®šæ˜¯å¤„äºå·²ç™»å½•çŠ¶æ€çš„ï¼Œå› æ­¤æ‰‹æœºç«¯æœ¬èº«å·²ç»ä¿å­˜äº†ä¸€ä¸ª tokenï¼Œè¯¥ token å¯ç”¨äºæœåŠ¡ç«¯çš„èº«ä»½è¯†åˆ«ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæ‰‹æœºç«¯åœ¨éªŒè¯èº«ä»½æ—¶è¿˜éœ€è¦è®¾å¤‡ä¿¡æ¯å‘¢ï¼Ÿå®é™…ä¸Šï¼Œæ‰‹æœºç«¯çš„èº«ä»½è®¤è¯å’Œ PC ç«¯ç•¥æœ‰ä¸åŒï¼š</p><ol><li><p>æ‰‹æœºç«¯åœ¨ç™»å½•å‰ä¹Ÿéœ€è¦è¾“å…¥è´¦å·å’Œå¯†ç ï¼Œä½†ç™»å½•è¯·æ±‚ä¸­é™¤äº†è´¦å·å¯†ç å¤–è¿˜åŒ…å«ç€è®¾å¤‡ä¿¡æ¯ï¼Œä¾‹å¦‚è®¾å¤‡ç±»å‹ã€è®¾å¤‡ id ç­‰ã€‚</p></li><li><p>æ¥æ”¶åˆ°ç™»å½•è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¼šéªŒè¯è´¦å·å’Œå¯†ç ï¼ŒéªŒè¯é€šè¿‡åï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¸è®¾å¤‡ä¿¡æ¯å…³è”èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ªæ•°æ®ç»“æ„ structure ä¸­ã€‚</p></li><li><p>æœåŠ¡ç«¯ä¸ºæ‰‹æœºç«¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œå¹¶å°† token ä¸ç”¨æˆ·ä¿¡æ¯ã€è®¾å¤‡ä¿¡æ¯å…³è”èµ·æ¥ï¼Œå³ä»¥ token ä¸º keyï¼Œstructure ä¸º valueï¼Œå°†è¯¥é”®å€¼å¯¹æŒä¹…åŒ–ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¹‹åå°† token è¿”å›ç»™æ‰‹æœºç«¯ã€‚</p></li><li><p>æ‰‹æœºç«¯å‘é€è¯·æ±‚ï¼Œæºå¸¦ token å’Œè®¾å¤‡ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯æ ¹æ® token æŸ¥è¯¢å‡º structureï¼Œå¹¶éªŒè¯ structure ä¸­çš„è®¾å¤‡ä¿¡æ¯å’Œæ‰‹æœºç«¯çš„è®¾å¤‡ä¿¡æ¯æ˜¯å¦ç›¸åŒï¼Œä»¥æ­¤åˆ¤æ–­ç”¨æˆ·çš„æœ‰æ•ˆæ€§ã€‚</p></li></ol><p>æˆ‘ä»¬åœ¨ PC ç«¯ç™»å½•æˆåŠŸåï¼Œå¯ä»¥çŸ­æ—¶é—´å†…æ­£å¸¸æµè§ˆç½‘é¡µï¼Œä½†ä¹‹åè®¿é—®ç½‘ç«™æ—¶å°±è¦é‡æ–°ç™»é™†äº†ï¼Œè¿™æ˜¯å› ä¸º token æ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œè¾ƒé•¿çš„æœ‰æ•ˆæ—¶é—´ä¼šå¢å¤§ token è¢«åŠ«æŒçš„é£é™©ã€‚ä½†æ˜¯ï¼Œæ‰‹æœºç«¯å¥½åƒå¾ˆå°‘æœ‰è¿™ç§é—®é¢˜ï¼Œä¾‹å¦‚å¾®ä¿¡ç™»å½•æˆåŠŸåå¯ä»¥ä¸€ç›´ä½¿ç”¨ï¼Œå³ä½¿å…³é—­å¾®ä¿¡æˆ–é‡å¯æ‰‹æœºã€‚è¿™æ˜¯å› ä¸ºè®¾å¤‡ä¿¡æ¯å…·æœ‰å”¯ä¸€æ€§ï¼Œå³ä½¿ token è¢«åŠ«æŒäº†ï¼Œç”±äºè®¾å¤‡ä¿¡æ¯ä¸åŒï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•å‘æœåŠ¡ç«¯è¯æ˜è‡ªå·±çš„èº«ä»½ï¼Œè¿™æ ·å¤§å¤§æé«˜äº†å®‰å…¨ç³»æ•°ï¼Œå› æ­¤ token å¯ä»¥é•¿ä¹…ä½¿ç”¨ã€‚æ‰‹æœºç«¯é€šè¿‡è´¦å·å¯†ç ç™»å½•çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E6%89%8B%E6%9C%BA%E7%AB%AF%E9%AA%8C%E8%AF%81.jpg" alt></p><p><strong>2. æµç¨‹æ¦‚è¿°</strong></p><p>äº†è§£äº†æœåŠ¡ç«¯çš„èº«ä»½è®¤è¯æœºåˆ¶åï¼Œæˆ‘ä»¬å†èŠä¸€èŠæ‰«ç ç™»å½•çš„æ•´ä¸ªæµç¨‹ã€‚ä»¥ç½‘é¡µç‰ˆå¾®ä¿¡ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ PC ç«¯ç‚¹å‡»äºŒç»´ç ç™»å½•åï¼Œæµè§ˆå™¨é¡µé¢ä¼šå¼¹å‡ºäºŒç»´ç å›¾ç‰‡ï¼Œæ­¤æ—¶æ‰“å¼€æ‰‹æœºå¾®ä¿¡æ‰«æäºŒç»´ç ï¼ŒPC ç«¯éšå³æ˜¾ç¤º â€œæ­£åœ¨æ‰«ç â€ï¼Œæ‰‹æœºç«¯ç‚¹å‡»ç¡®è®¤ç™»å½•åï¼ŒPC ç«¯å°±ä¼šæ˜¾ç¤º â€œç™»é™†æˆåŠŸâ€ äº†ã€‚</p><p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯å¯ä»¥æ ¹æ®æ‰‹æœºç«¯çš„æ“ä½œæ¥å“åº” PC ç«¯ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯æ˜¯å¦‚ä½•å°†äºŒè€…å…³è”èµ·æ¥çš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯é€šè¿‡ â€œäºŒç»´ç â€ï¼Œä¸¥æ ¼æ¥è¯´æ˜¯é€šè¿‡äºŒç»´ç ä¸­çš„å†…å®¹ã€‚ä½¿ç”¨äºŒç»´ç è§£ç å™¨æ‰«æç½‘é¡µç‰ˆå¾®ä¿¡çš„äºŒç»´ç ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E4%BA%8C%E7%BB%B4%E7%A0%81%E8%A7%A3%E7%A0%81.png" alt></p><p>ç”±ä¸Šå›¾æˆ‘ä»¬å¾—çŸ¥ï¼ŒäºŒç»´ç ä¸­åŒ…å«çš„å…¶å®æ˜¯ä¸€ä¸ªç½‘å€ï¼Œæ‰‹æœºæ‰«æäºŒç»´ç åï¼Œä¼šæ ¹æ®è¯¥ç½‘å€å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ã€‚æ¥ç€ï¼Œæˆ‘ä»¬æ‰“å¼€ PC ç«¯æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E5%BE%AE%E4%BF%A1%E8%BD%AE%E8%AF%A2.png" alt></p><p>å¯è§ï¼Œåœ¨æ˜¾ç¤ºå‡ºäºŒç»´ç ä¹‹åï¼ŒPC ç«¯ä¸€ç›´éƒ½æ²¡æœ‰ â€œé—²ç€â€ï¼Œå®ƒé€šè¿‡è½®è¯¢çš„æ–¹å¼ä¸æ–­å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œä»¥è·çŸ¥æ‰‹æœºç«¯æ“ä½œçš„ç»“æœã€‚è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒPC ç«¯å‘é€çš„ URL ä¸­æœ‰ä¸€ä¸ªå‚æ•° uuidï¼Œå€¼ä¸º â€œAdv-NP1FYw==â€ï¼Œè¯¥ uuid ä¹Ÿå­˜åœ¨äºäºŒç»´ç åŒ…å«çš„ç½‘å€ä¸­ã€‚ç”±æ­¤æˆ‘ä»¬å¯ä»¥æ¨æ–­ï¼ŒæœåŠ¡ç«¯åœ¨ç”ŸæˆäºŒç»´ç ä¹‹å‰ä¼šå…ˆç”Ÿæˆä¸€ä¸ªäºŒç»´ç  idï¼ŒäºŒç»´ç  id ä¸äºŒç»´ç çš„çŠ¶æ€ã€è¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸€åŒå­˜å‚¨åœ¨æœåŠ¡ç«¯ã€‚æ‰‹æœºç«¯å¯ä»¥æ ¹æ®äºŒç»´ç  id æ“ä½œæœåŠ¡ç«¯äºŒç»´ç çš„çŠ¶æ€ï¼ŒPC ç«¯å¯ä»¥æ ¹æ®äºŒç»´ç  id å‘æœåŠ¡ç«¯è¯¢é—®äºŒç»´ç çš„çŠ¶æ€ã€‚</p><p>äºŒç»´ç æœ€åˆä¸º â€œå¾…æ‰«æâ€ çŠ¶æ€ï¼Œæ‰‹æœºç«¯æ‰«ç åæœåŠ¡ç«¯å°†å…¶çŠ¶æ€æ”¹ä¸º â€œå¾…ç¡®è®¤â€ çŠ¶æ€ï¼Œæ­¤æ—¶ PC ç«¯çš„è½®è¯¢è¯·æ±‚åˆ°è¾¾ï¼ŒæœåŠ¡ç«¯å‘å…¶è¿”å› â€œå¾…ç¡®è®¤â€ çš„å“åº”ã€‚æ‰‹æœºç«¯ç¡®è®¤ç™»å½•åï¼ŒäºŒç»´ç å˜æˆ â€œå·²ç¡®è®¤â€ çŠ¶æ€ï¼ŒæœåŠ¡ç«¯ä¸º PC ç«¯ç”Ÿæˆç”¨äºèº«ä»½è®¤è¯çš„ tokenï¼ŒPC ç«¯å†æ¬¡è¯¢é—®æ—¶ï¼Œå°±å¯ä»¥å¾—åˆ°è¿™ä¸ª tokenã€‚æ•´ä¸ªæ‰«ç ç™»å½•çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt></p><ol><li><p>PC ç«¯å‘é€ â€œæ‰«ç ç™»å½•â€ è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ç”ŸæˆäºŒç»´ç  idï¼Œå¹¶å­˜å‚¨äºŒç»´ç çš„è¿‡æœŸæ—¶é—´ã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚</p></li><li><p>PC ç«¯è·å–äºŒç»´ç å¹¶æ˜¾ç¤ºã€‚</p></li><li><p>PC ç«¯å¼€å§‹è½®è¯¢æ£€æŸ¥äºŒç»´ç çš„çŠ¶æ€ï¼ŒäºŒç»´ç æœ€åˆä¸º â€œå¾…æ‰«æâ€ çŠ¶æ€ã€‚</p></li><li><p>æ‰‹æœºç«¯æ‰«æäºŒç»´ç ï¼Œè·å–äºŒç»´ç  idã€‚</p></li><li><p>æ‰‹æœºç«¯å‘æœåŠ¡ç«¯å‘é€ â€œæ‰«ç â€ è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦äºŒç»´ç  idã€æ‰‹æœºç«¯ token ä»¥åŠè®¾å¤‡ä¿¡æ¯ã€‚</p></li><li><p>æœåŠ¡ç«¯éªŒè¯æ‰‹æœºç«¯ç”¨æˆ·çš„åˆæ³•æ€§ï¼ŒéªŒè¯é€šè¿‡åå°†äºŒç»´ç çŠ¶æ€ç½®ä¸º â€œå¾…ç¡®è®¤â€ï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯ä¸äºŒç»´ç å…³è”åœ¨ä¸€èµ·ï¼Œä¹‹åä¸ºæ‰‹æœºç«¯ç”Ÿæˆä¸€ä¸ªä¸€æ¬¡æ€§ tokenï¼Œè¯¥ token ç”¨ä½œç¡®è®¤ç™»å½•çš„å‡­è¯ã€‚</p></li><li><p>PC ç«¯è½®è¯¢æ—¶æ£€æµ‹åˆ°äºŒç»´ç çŠ¶æ€ä¸º â€œå¾…ç¡®è®¤â€ã€‚</p></li><li><p>æ‰‹æœºç«¯å‘æœåŠ¡ç«¯å‘é€ â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦ç€äºŒç»´ç  idã€ä¸€æ¬¡æ€§ token ä»¥åŠè®¾å¤‡ä¿¡æ¯ã€‚</p></li><li><p>æœåŠ¡ç«¯éªŒè¯ä¸€æ¬¡æ€§ tokenï¼ŒéªŒè¯é€šè¿‡åå°†äºŒç»´ç çŠ¶æ€ç½®ä¸º â€œå·²ç¡®è®¤â€ï¼Œå¹¶ä¸º PC ç«¯ç”Ÿæˆ PC ç«¯ tokenã€‚</p></li><li><p>PC ç«¯è½®è¯¢æ—¶æ£€æµ‹åˆ°äºŒç»´ç çŠ¶æ€ä¸º â€œå·²ç¡®è®¤â€ï¼Œå¹¶è·å–åˆ°äº† PC ç«¯ tokenï¼Œä¹‹å PC ç«¯ä¸å†è½®è¯¢ã€‚</p></li><li><p>PC ç«¯é€šè¿‡ PC ç«¯ token è®¿é—®æœåŠ¡ç«¯ã€‚</p></li></ol><p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæ‰‹æœºç«¯æ‰«ç åæœåŠ¡ç«¯ä¼šè¿”å›ä¸€ä¸ªä¸€æ¬¡æ€§ tokenï¼Œè¯¥ token ä¹Ÿæ˜¯ä¸€ç§èº«ä»½å‡­è¯ï¼Œä½†å®ƒåªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚ä¸€æ¬¡æ€§ token çš„ä½œç”¨æ˜¯ç¡®ä¿ â€œæ‰«ç è¯·æ±‚â€ ä¸ â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚ç”±åŒä¸€ä¸ªæ‰‹æœºç«¯å‘å‡ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰‹æœºç«¯ç”¨æˆ·ä¸èƒ½ â€œå¸®å…¶ä»–ç”¨æˆ·ç¡®è®¤ç™»å½•â€ã€‚</p><blockquote><p>å…³äºä¸€æ¬¡æ€§ token çš„çŸ¥è¯†æœ¬äººä¹Ÿä¸æ˜¯å¾ˆäº†è§£ï¼Œä½†å¯ä»¥æ¨æµ‹ï¼Œåœ¨æœåŠ¡ç«¯çš„ç¼“å­˜ä¸­ï¼Œä¸€æ¬¡æ€§ token æ˜ å°„çš„ value åº”è¯¥åŒ…å« â€œæ‰«ç â€ è¯·æ±‚ä¼ å…¥çš„äºŒç»´ç ä¿¡æ¯ã€è®¾å¤‡ä¿¡æ¯ä»¥åŠç”¨æˆ·ä¿¡æ¯ã€‚</p></blockquote><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p><strong>1. ç¯å¢ƒå‡†å¤‡</strong></p><ul><li><p>JDK 1.8ï¼šé¡¹ç›®ä½¿ç”¨ Java è¯­è¨€ç¼–å†™ã€‚</p></li><li><p>Mavenï¼šä¾èµ–ç®¡ç†ã€‚</p></li><li><p>Redisï¼šRedis æ—¢ä½œä¸ºæ•°æ®åº“å­˜å‚¨ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆä¸ºäº†ç®€åŒ–æ“ä½œæœªä½¿ç”¨ MySQLï¼‰ï¼Œä¹Ÿä½œä¸ºç¼“å­˜å­˜å‚¨äºŒç»´ç ä¿¡æ¯ã€token ä¿¡æ¯ç­‰ã€‚</p></li></ul><p><strong>2. ä¸»è¦ä¾èµ–</strong></p><ul><li><p>SpringBootï¼šé¡¹ç›®åŸºæœ¬ç¯å¢ƒã€‚</p></li><li><p>Hutoolï¼šå¼€æºå·¥å…·ç±»ï¼Œå…¶ä¸­çš„ QrCodeUtil å¯ç”¨äºç”ŸæˆäºŒç»´ç å›¾ç‰‡ã€‚</p></li><li><p>Thymeleafï¼šæ¨¡æ¿å¼•æ“ï¼Œç”¨äºé¡µé¢æ¸²æŸ“ã€‚</p></li></ul><p><strong>3. ç”ŸæˆäºŒç»´ç </strong></p><p>äºŒç»´ç çš„ç”Ÿæˆä»¥åŠäºŒç»´ç çŠ¶æ€çš„ä¿å­˜é€»è¾‘å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/getQrCodeImg"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token keyword">public</span> String <span class="token function">createQrCodeImg</span><span class="token punctuation">(</span>Model model<span class="token punctuation">)</span> <span class="token punctuation">{</span>   String uuid <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">createQrImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   String qrCode <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>QrCodeUtil<span class="token punctuation">.</span><span class="token function">generatePng</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8080/login/uuid="</span> <span class="token operator">+</span> uuid<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>   model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"QrCode"</span><span class="token punctuation">,</span> qrCode<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PC ç«¯è®¿é—® â€œç™»å½•â€ è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯è°ƒç”¨ createQrImg æ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ª uuid å’Œä¸€ä¸ª LoginTicket å¯¹è±¡ï¼ŒLoginTicket å¯¹è±¡ä¸­å°è£…äº†ç”¨æˆ·çš„ userId å’ŒäºŒç»´ç çš„çŠ¶æ€ã€‚ç„¶åæœåŠ¡ç«¯å°† uuid ä½œä¸º keyï¼ŒLoginTicket å¯¹è±¡ä½œä¸º value å­˜å…¥åˆ° Redis æœåŠ¡å™¨ä¸­ï¼Œå¹¶è®¾ç½®æœ‰æ•ˆæ—¶é—´ä¸º 5 åˆ†é’Ÿï¼ˆäºŒç»´ç çš„æœ‰æ•ˆæ—¶é—´ï¼‰ï¼ŒcreateQrImg æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">createQrImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// uuid</span>   String uuid <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   LoginTicket loginTicket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// äºŒç»´ç æœ€åˆä¸º WAITING çŠ¶æ€</span>   loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>QrCodeStatusEnum<span class="token punctuation">.</span>WAITING<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// å­˜å…¥ redis</span>   String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>   cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">,</span> loginTicket<span class="token punctuation">,</span> LoginConstant<span class="token punctuation">.</span>WAIT_EXPIRED_SECONDS<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> uuid<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬åœ¨å‰ä¸€èŠ‚ä¸­æåˆ°ï¼Œæ‰‹æœºç«¯çš„æ“ä½œä¸»è¦å½±å“äºŒç»´ç çš„çŠ¶æ€ï¼ŒPC ç«¯è½®è¯¢æ—¶ä¹Ÿæ˜¯æŸ¥çœ‹äºŒç»´ç çš„çŠ¶æ€ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦åœ¨ LoginTicket å¯¹è±¡ä¸­å°è£… userId å‘¢ï¼Ÿè¿™æ ·åšæ˜¯ä¸ºäº†å°†äºŒç»´ç ä¸ç”¨æˆ·è¿›è¡Œå…³è”ï¼Œæƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬ç™»å½•ç½‘é¡µç‰ˆå¾®ä¿¡çš„åœºæ™¯ï¼Œæ‰‹æœºç«¯æ‰«ç åï¼ŒPC ç«¯å°±ä¼šæ˜¾ç¤ºç”¨æˆ·çš„å¤´åƒï¼Œè™½ç„¶æ‰‹æœºç«¯å¹¶æœªç¡®è®¤ç™»å½•ï¼Œä½† PC ç«¯è½®è¯¢æ—¶å·²ç»è·å–åˆ°äº†å½“å‰æ‰«ç çš„ç”¨æˆ·ï¼ˆä»…å¤´åƒä¿¡æ¯ï¼‰ã€‚å› æ­¤æ‰‹æœºç«¯æ‰«ç åï¼Œéœ€è¦å°†äºŒç»´ç ä¸ç”¨æˆ·ç»‘å®šåœ¨ä¸€èµ·ï¼Œä½¿ç”¨ LoginTicket å¯¹è±¡åªæ˜¯ä¸€ç§å®ç°æ–¹å¼ã€‚äºŒç»´ç ç”Ÿæˆåï¼Œæˆ‘ä»¬å°†å…¶çŠ¶æ€ç½®ä¸º â€œå¾…æ‰«æâ€ çŠ¶æ€ï¼ŒuserId ä¸åšå¤„ç†ï¼Œé»˜è®¤ä¸º nullã€‚</p><p><strong>4. æ‰«æäºŒç»´ç </strong></p><p>æ‰‹æœºç«¯å‘é€ â€œæ‰«ç â€ è¯·æ±‚æ—¶ï¼ŒQuery å‚æ•°ä¸­æºå¸¦ç€ uuidï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œè°ƒç”¨ scanQrCodeImg æ–¹æ³•ï¼Œæ ¹æ® uuid æŸ¥è¯¢å‡ºäºŒç»´ç å¹¶å°†å…¶çŠ¶æ€ç½®ä¸º â€œå¾…ç¡®è®¤â€ çŠ¶æ€ï¼Œæ“ä½œå®ŒæˆåæœåŠ¡ç«¯å‘æ‰‹æœºç«¯è¿”å› â€œæ‰«ç æˆåŠŸâ€ æˆ– â€œäºŒç»´ç å·²å¤±æ•ˆâ€ çš„ä¿¡æ¯ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/scan"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span><span class="token annotation punctuation">@ResponseBody</span><span class="token keyword">public</span> Response <span class="token function">scanQrCodeImg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>   JSONObject data <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">scanQrCodeImg</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createResponse</span><span class="token punctuation">(</span><span class="token string">"æ‰«ç æˆåŠŸ"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createErrorResponse</span><span class="token punctuation">(</span><span class="token string">"äºŒç»´ç å·²å¤±æ•ˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>scanQrCodeImg æ–¹æ³•çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> JSONObject <span class="token function">scanQrCodeImg</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// é¿å…å¤šä¸ªç§»åŠ¨ç«¯åŒæ—¶æ‰«æåŒä¸€ä¸ªäºŒç»´ç </span>   lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   JSONObject data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">try</span> <span class="token punctuation">{</span>      String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>      LoginTicket loginTicket <span class="token operator">=</span> <span class="token punctuation">(</span>LoginTicket<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// redis ä¸­ key è¿‡æœŸåä¹Ÿå¯èƒ½ä¸ä¼šç«‹å³åˆ é™¤</span>      Long expired <span class="token operator">=</span> cacheStore<span class="token punctuation">.</span><span class="token function">getExpireForSeconds</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">boolean</span> valid <span class="token operator">=</span> loginTicket <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>               QrCodeStatusEnum<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>WAITING <span class="token operator">&amp;&amp;</span>               expired <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>               expired <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>            User user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·æœªç™»å½•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ä¿®æ”¹æ‰«ç çŠ¶æ€</span>            loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>QrCodeStatusEnum<span class="token punctuation">.</span>SCANNED<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Condition condition <span class="token operator">=</span> CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>               condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å°†äºŒç»´ç ä¸ç”¨æˆ·è¿›è¡Œå…³è”</span>            loginTicket<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">,</span> loginTicket<span class="token punctuation">,</span> expired<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ç”Ÿæˆä¸€æ¬¡æ€§ token, ç”¨äºä¹‹åçš„ç¡®è®¤è¯·æ±‚</span>            String onceToken <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildOnceTokenKey</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> LoginConstant<span class="token punctuation">.</span>ONCE_TOKEN_EXPIRE_TIME<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"once_token"</span><span class="token punctuation">,</span> onceToken<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"valid"</span><span class="token punctuation">,</span> valid<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> data<span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><p>é¦–å…ˆæ ¹æ® uuid æŸ¥è¯¢ Redis ä¸­å­˜å‚¨çš„ LoginTicket å¯¹è±¡ï¼Œç„¶åæ£€æŸ¥äºŒç»´ç çš„çŠ¶æ€æ˜¯å¦ä¸º â€œå¾…æ‰«æâ€ çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå°†äºŒç»´ç çš„çŠ¶æ€æ”¹ä¸º â€œå¾…ç¡®è®¤â€ çŠ¶æ€ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆè¯¥äºŒç»´ç å·²è¢«æ‰«æè¿‡ï¼ŒæœåŠ¡ç«¯æç¤ºç”¨æˆ· â€œäºŒç»´ç å·²å¤±æ•ˆâ€ã€‚æˆ‘ä»¬è§„å®šï¼Œåªå…è®¸ç¬¬ä¸€ä¸ªæ‰‹æœºç«¯èƒ½å¤Ÿæ‰«ææˆåŠŸï¼ŒåŠ é”çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯ <code>æŸ¥è¯¢ + ä¿®æ”¹</code> æ“ä½œçš„åŸå­æ€§ï¼Œé¿å…ä¸¤ä¸ªæ‰‹æœºç«¯åŒæ—¶æ‰«ç ï¼Œä¸”åŒæ—¶æ£€æµ‹åˆ°äºŒç»´ç çš„çŠ¶æ€ä¸º â€œå¾…æ‰«æâ€ã€‚ </p></li><li><p>ä¸Šä¸€æ­¥æ“ä½œæˆåŠŸåï¼ŒæœåŠ¡ç«¯å°† LoginTicket å¯¹è±¡ä¸­çš„ userId ç½®ä¸ºå½“å‰ç”¨æˆ·ï¼ˆæ‰«ç ç”¨æˆ·ï¼‰çš„ userIdï¼Œä¹Ÿå°±æ˜¯å°†äºŒç»´ç ä¸ç”¨æˆ·ä¿¡æ¯ç»‘å®šåœ¨ä¸€èµ·ã€‚ç”±äº<strong>æ‰«ç è¯·æ±‚æ˜¯ç”±æ‰‹æœºç«¯å‘é€çš„</strong>ï¼Œå› æ­¤è¯¥è¯·æ±‚ä¸€å®šæ¥è‡ªäºä¸€ä¸ªæœ‰æ•ˆçš„ç”¨æˆ·ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­é…ç½®ä¸€ä¸ªæ‹¦æˆªå™¨ï¼ˆä¹Ÿå¯ä»¥æ˜¯è¿‡æ»¤å™¨ï¼‰ï¼Œå½“æ‹¦æˆªåˆ° â€œæ‰«ç â€ è¯·æ±‚åï¼Œæ ¹æ®è¯·æ±‚ä¸­çš„ tokenï¼ˆæ‰‹æœºç«¯å‘é€è¯·æ±‚æ—¶ä¸€å®šä¼šæºå¸¦ tokenï¼‰æŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ° ThreadLocal å®¹å™¨ï¼ˆhostHolderï¼‰ä¸­ï¼Œä¹‹åç»‘å®šä¿¡æ¯æ—¶å°±å¯ä»¥ä» ThreadLocal å®¹å™¨å°†ç”¨æˆ·ä¿¡æ¯æå–å‡ºæ¥ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ token æŒ‡çš„æ‰‹æœºç«¯ tokenï¼Œå®é™…ä¸­åº”è¯¥è¿˜æœ‰è®¾å¤‡ä¿¡æ¯ï¼Œä½†ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬å¿½ç•¥æ‰è®¾å¤‡ä¿¡æ¯ã€‚</p></li><li><p>ç”¨æˆ·ä¿¡æ¯ä¸äºŒç»´ç ä¿¡æ¯å…³è”åœ¨ä¸€èµ·åï¼ŒæœåŠ¡ç«¯ä¸ºæ‰‹æœºç«¯ç”Ÿæˆä¸€ä¸ªä¸€æ¬¡æ€§ tokenï¼Œå¹¶å­˜å‚¨åˆ° Redis æœåŠ¡å™¨ï¼Œå…¶ä¸­ key ä¸ºä¸€æ¬¡æ€§ token çš„å€¼ï¼Œvalue ä¸º uuidã€‚ä¸€æ¬¡æ€§ token ä¼šè¿”å›ç»™æ‰‹æœºç«¯ï¼Œä½œä¸º â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚çš„å‡­è¯ã€‚</p></li></ol><!-- ç”¨æˆ·ä¸‹æ¬¡å‘é€ "ç¡®è®¤ç™»å½•" çš„è¯·æ±‚æ—¶ï¼Œéœ€è¦æºå¸¦ä¸€æ¬¡æ€§ tokenï¼Œæ‹¦æˆªå™¨æ‹¦æˆªåˆ° `/login/confirm` è¯·æ±‚åï¼Œæ£€æŸ¥ä¸€æ¬¡æ€§ token å¯¹åº”çš„ uuid ä¸ Query å‚æ•°ä¸­çš„ uuid æ˜¯å¦ç›¸åŒï¼Œä»¥ç¡®ä¿æ‰«ç å’Œç¡®è®¤æ“ä½œæ¥è‡ªäºåŒä¸€ä¸ªæ‰‹æœºç«¯ã€‚ --><!-- å…³äºä¸€æ¬¡æ€§ token çš„çŸ¥è¯†æˆ‘ä¹Ÿä¸å¤ªäº†è§£ï¼Œä¸€æ¬¡æ€§ token å¯¹åº”çš„ value åº”è¯¥è®¾ç½®æˆä»€ä¹ˆæˆ‘ä¹Ÿä¸æ¸…æ¥šï¼Œè¿™é‡Œé€‰æ‹©å°† uuid ä½œä¸º valueï¼Œæ˜¯ä¸ºäº†ç¡®ä¿ "æ‰«ç " è¯·æ±‚ä¸ "ç¡®è®¤ç™»å½•" è¯·æ±‚æ¥è‡ªäºåŒä¸€ä¸ªæ‰‹æœºç«¯ã€‚ --><!-- 4. è¯·æ±‚çš„ URIï¼ˆåŒ…å«è¯·æ±‚çš„å‚æ•°ä¿¡æ¯ï¼Œä¾‹å¦‚ /login/confirm?uuid=uuidï¼‰ã€‚--><!-- ç”¨æˆ·ä¸‹æ¬¡å‘é€ "ç¡®è®¤ç™»å½•" çš„è¯·æ±‚æ—¶éœ€è¦æºå¸¦ä¸€æ¬¡æ€§ token --><!-- ä¸€æ¬¡æ€§ token ç”¨ä½œç¡®è®¤ç™»å½•çš„å‡­è¯   --><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå½“äºŒç»´ç çš„çŠ¶æ€è¢«ä¿®æ”¹åï¼Œæˆ‘ä»¬å”¤é†’äº†åœ¨ condition ä¸­é˜»å¡çš„çº¿ç¨‹ï¼Œè¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºäº†å®ç°é•¿è½®è¯¢æ“ä½œï¼Œä¸‹æ–‡ä¸­ä¼šä»‹ç»é•¿è½®è¯¢çš„è®¾è®¡æ€è·¯ã€‚</p><p><strong>5. ç¡®è®¤ç™»å½•</strong></p><p>æ‰‹æœºç«¯å‘é€ â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚æ—¶ï¼ŒQuery å‚æ•°ä¸­æºå¸¦ç€ uuidï¼Œä¸” Header ä¸­æºå¸¦ç€ä¸€æ¬¡æ€§ tokenï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œé¦–å…ˆéªŒè¯ä¸€æ¬¡æ€§ token çš„æœ‰æ•ˆæ€§ï¼Œå³æ£€æŸ¥ä¸€æ¬¡æ€§ token å¯¹åº”çš„ uuid ä¸ Query å‚æ•°ä¸­çš„ uuid æ˜¯å¦ç›¸åŒï¼Œä»¥ç¡®ä¿æ‰«ç æ“ä½œå’Œç¡®è®¤æ“ä½œæ¥è‡ªäºåŒä¸€ä¸ªæ‰‹æœºç«¯ï¼Œè¯¥éªŒè¯è¿‡ç¨‹å¯åœ¨æ‹¦æˆªå™¨ä¸­é…ç½®ã€‚éªŒè¯é€šè¿‡åï¼ŒæœåŠ¡ç«¯è°ƒç”¨ confirmLogin æ–¹æ³•ï¼Œå°†äºŒç»´ç çš„çŠ¶æ€ç½®ä¸º â€œå·²ç¡®è®¤â€ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/confirm"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span><span class="token annotation punctuation">@ResponseBody</span><span class="token keyword">public</span> Response <span class="token function">confirmLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">boolean</span> logged <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">confirmLogin</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>   String msg <span class="token operator">=</span> logged <span class="token operator">?</span> <span class="token string">"ç™»å½•æˆåŠŸ!"</span> <span class="token operator">:</span> <span class="token string">"äºŒç»´ç å·²å¤±æ•ˆ!"</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createResponse</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> logged<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>confirmLogin æ–¹æ³•çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">confirmLogin</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>   String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>   LoginTicket loginTicket <span class="token operator">=</span> <span class="token punctuation">(</span>LoginTicket<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">boolean</span> logged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   Long expired <span class="token operator">=</span> cacheStore<span class="token punctuation">.</span><span class="token function">getExpireForSeconds</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket <span class="token operator">==</span> null <span class="token operator">||</span> expired <span class="token operator">==</span> null <span class="token operator">||</span> expired <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      logged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>            loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>QrCodeStatusEnum<span class="token punctuation">.</span>CONFIRMED<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Condition condition <span class="token operator">=</span> CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>               condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">,</span> loginTicket<span class="token punctuation">,</span> expired<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>   <span class="token punctuation">}</span>   <span class="token keyword">return</span> logged<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥æ–¹æ³•ä¼šæ ¹æ® uuid æŸ¥è¯¢äºŒç»´ç æ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæœªè¿‡æœŸï¼Œé‚£ä¹ˆå°±ä¿®æ”¹äºŒç»´ç çš„çŠ¶æ€ã€‚</p><p><strong>6. PC ç«¯è½®è¯¢</strong></p><p>è½®è¯¢æ“ä½œæŒ‡çš„æ˜¯å‰ç«¯é‡å¤å¤šæ¬¡å‘åç«¯å‘é€ç›¸åŒçš„è¯·æ±‚ï¼Œä»¥è·çŸ¥æ•°æ®çš„å˜åŒ–ã€‚è½®è¯¢åˆ†ä¸ºé•¿è½®è¯¢å’ŒçŸ­è½®è¯¢ï¼š</p><ul><li><p>é•¿è½®è¯¢ï¼šæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åï¼Œå¦‚æœæœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±ç«‹å³è¿”å›ï¼Œå¦åˆ™çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾æˆ–è¶…æ—¶ï¼Œæµè§ˆå™¨æ”¶åˆ°å“åº”åç«‹å³é‡æ–°å‘é€ç›¸åŒçš„è¯·æ±‚ã€‚</p></li><li><p>çŸ­è½®è¯¢ï¼šæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åæ— è®ºæ˜¯å¦æœ‰æ•°æ®éƒ½ç«‹å³è¿”å›ï¼Œæµè§ˆå™¨æ”¶åˆ°å“åº”åé—´éš”ä¸€æ®µæ—¶é—´åé‡æ–°å‘é€ç›¸åŒçš„è¯·æ±‚ã€‚</p></li></ul><p>ç”±äºé•¿è½®è¯¢ç›¸æ¯”çŸ­è½®è¯¢èƒ½å¤Ÿå¾—åˆ°å®æ—¶çš„å“åº”ï¼Œä¸”æ›´åŠ èŠ‚çº¦èµ„æºï¼Œå› æ­¤é¡¹ç›®ä¸­æˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ ReentrantLock æ¥å®ç°é•¿è½®è¯¢ã€‚è½®è¯¢çš„ç›®çš„æ˜¯ä¸ºäº†æŸ¥çœ‹äºŒç»´ç çŠ¶æ€çš„å˜åŒ–ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/getQrCodeStatus"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token annotation punctuation">@ResponseBody</span><span class="token keyword">public</span> Response <span class="token function">getQrCodeStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String uuid<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>   JSONObject data <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">getQrCodeStatus</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createResponse</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>getQrCodeStatus æ–¹æ³•çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> JSONObject <span class="token function">getQrCodeStatus</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">,</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>   lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">try</span> <span class="token punctuation">{</span>      JSONObject data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>      LoginTicket loginTicket <span class="token operator">=</span> <span class="token punctuation">(</span>LoginTicket<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>      QrCodeStatusEnum statusEnum <span class="token operator">=</span> loginTicket <span class="token operator">==</span> null <span class="token operator">||</span> QrCodeStatusEnum<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>INVALID <span class="token operator">?</span>               QrCodeStatusEnum<span class="token punctuation">.</span>INVALID <span class="token operator">:</span> QrCodeStatusEnum<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStatus <span class="token operator">==</span> statusEnum<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Condition condition <span class="token operator">=</span> CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>               condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>LoginConstant<span class="token punctuation">.</span>POLL_WAIT_TIME<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// ç”¨æˆ·æ‰«ç åå‘ PC ç«¯è¿”å›å¤´åƒä¿¡æ¯</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>statusEnum <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>SCANNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"avatar"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// ç”¨æˆ·ç¡®è®¤åä¸º PC ç«¯ç”Ÿæˆ access_token</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>statusEnum <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>CONFIRMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>            String accessToken <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildAccessTokenKey</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">,</span> loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LoginConstant<span class="token punctuation">.</span>ACCESS_TOKEN_EXPIRE_TIME<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span> statusEnum<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> statusEnum<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> data<span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œå³ uuid å’Œ currentStatusï¼Œå…¶ä¸­ uuid ç”¨äºæŸ¥è¯¢äºŒç»´ç ï¼ŒcurrentStatus ç”¨äºç¡®è®¤äºŒç»´ç çŠ¶æ€æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆéœ€è¦ç«‹å³å‘ PC ç«¯åé¦ˆã€‚æˆ‘ä»¬è§„å®š PC ç«¯åœ¨è½®è¯¢æ—¶ï¼Œè¯·æ±‚çš„å‚æ•°ä¸­éœ€è¦æºå¸¦äºŒç»´ç å½“å‰çš„çŠ¶æ€ã€‚</p><ol><li><p>é¦–å…ˆæ ¹æ® uuid æŸ¥è¯¢å‡ºäºŒç»´ç çš„æœ€æ–°çŠ¶æ€ï¼Œå¹¶æ¯”è¾ƒå…¶æ˜¯å¦ä¸ currentStatus ç›¸åŒã€‚å¦‚æœç›¸åŒï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è€…è¶…æ—¶ã€‚</p></li><li><p>å¦‚æœäºŒç»´ç çŠ¶æ€ä¸º â€œå¾…ç¡®è®¤â€ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å‘ PC ç«¯è¿”å›æ‰«ç ç”¨æˆ·çš„å¤´åƒä¿¡æ¯ï¼ˆå¤„äº â€œå¾…ç¡®è®¤â€ çŠ¶æ€æ—¶ï¼ŒäºŒç»´ç å·²ä¸ç”¨æˆ·ä¿¡æ¯ç»‘å®šåœ¨ä¸€èµ·ï¼Œå› æ­¤å¯ä»¥æŸ¥è¯¢å‡ºç”¨æˆ·çš„å¤´åƒï¼‰ã€‚</p></li><li><p>å¦‚æœäºŒç»´ç çŠ¶æ€ä¸º â€œå·²ç¡®è®¤â€ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¸º PC ç«¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œåœ¨ä¹‹åçš„è¯·æ±‚ä¸­ï¼ŒPC ç«¯å¯é€šè¿‡è¯¥ token è¡¨æ˜è‡ªå·±çš„èº«ä»½ã€‚</p></li></ol><p>ä¸Šè¿°ä»£ç ä¸­çš„åŠ é”æ“ä½œæ˜¯ä¸ºäº†èƒ½å¤Ÿä»¤å½“å‰å¤„ç†è¯·æ±‚çš„çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå½“äºŒç»´ç çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å†å°†å…¶å”¤é†’ï¼Œå› æ­¤ä¸Šæ–‡ä¸­çš„æ‰«ç æ“ä½œå’Œç¡®è®¤ç™»å½•æ“ä½œå®Œæˆåï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªå”¤é†’çº¿ç¨‹çš„è¿‡ç¨‹ã€‚</p><!-- >åŠ é”å¯ä»¥ç¡®ä¿äºŒç»´ç çŠ¶æ€æ”¹å˜åï¼ŒPC ç«¯å¯ä»¥ç«‹å³å¾—åˆ°é€šçŸ¥ã€‚å› ä¸ºåŠ é”æ“ä½œåœ¨æŸ¥è¯¢æ“ä½œä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒäºŒç»´ç çŠ¶æ€çš„ä¿®æ”¹å’ŒæŸ¥è¯¢æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œè¿™é‡Œçš„æŸ¥è¯¢ä¸ä»…åŒ…å«ä» Redis ä¸­è·å– LoginTicketï¼Œè¿˜åŒ…æ‹¬æ¯”è¾ƒäºŒç»´ç çŠ¶æ€çš„æ¯”è¾ƒã€‚å¦‚æœå…ˆä¿®æ”¹å†æŸ¥ï¼Œé‚£ä¹ˆæŸ¥è¯¢æ—¶å¯ä»¥å‘ç°äºŒç»´ç çš„æœ€æ–°çŠ¶æ€å‘ç”Ÿäº†æ”¹å˜ï¼Œçº¿ç¨‹å°±ä¸ä¼šè¿›å…¥é˜»å¡ã€‚å¦‚æœå…ˆæŸ¥å†ä¿®æ”¹ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡ï¼Œä½†äºŒç»´ç çŠ¶æ€ä¿®æ”¹å®Œæˆåï¼Œçº¿ç¨‹ä¹Ÿå¯ä»¥ç«‹å³è¢«å”¤é†’ã€‚å¦‚æœåŠ é”æ“ä½œåœ¨æŸ¥è¯¢æ“ä½œä¹‹åï¼Œé‚£ä¹ˆæŸ¥è¯¢æ“ä½œæŸ¥å‡ºæ¥çš„äºŒç»´ç çŠ¶æ€å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œå› ä¸ºæ‰«ç æˆ–ç¡®è®¤æ“ä½œå¯èƒ½åœ¨æŸ¥è¯¢ç»“æŸåç«‹å³ä¿®æ”¹äºŒç»´ç çš„çŠ¶æ€ï¼Œè¿™æ · PC ç«¯å°±ä¸ä¼šå¾—åˆ°åŠæ—¶å“åº”ã€‚ --><p>å®é™…ä¸Šï¼ŒåŠ é”æ“ä½œè®¾è®¡å¾—ä¸å¤ªåˆç†ï¼Œå› ä¸ºæˆ‘ä»¬åªè®¾ç½®äº†ä¸€æŠŠé”ã€‚å› æ­¤å¯¹ä¸åŒäºŒç»´ç çš„æŸ¥è¯¢æˆ–ä¿®æ”¹æ“ä½œéƒ½ä¼šæŠ¢å åŒä¸€æŠŠé”ã€‚æŒ‰ç†æ¥è¯´ï¼Œä¸åŒäºŒç»´ç çš„æ“ä½œä¹‹é—´åº”è¯¥æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå³ä½¿åŠ é”ï¼Œä¹Ÿåº”è¯¥æ˜¯ä¸ºæ¯ä¸ªäºŒç»´ç å‡é…ä¸€æŠŠé”ï¼Œä½†è¿™æ ·åšä»£ç ä¼šæ›´åŠ å¤æ‚ï¼Œæˆ–è®¸æœ‰å…¶å®ƒæ›´å¥½çš„å®ç°é•¿è½®è¯¢çš„æ–¹å¼ï¼Ÿæˆ–è€…å¹²è„†ç›´æ¥çŸ­è½®è¯¢ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ WebSocket å®ç°é•¿è¿æ¥ã€‚</p><p><strong>7. æ‹¦æˆªå™¨é…ç½®</strong></p><p>é¡¹ç›®ä¸­é…ç½®äº†ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œä¸€ä¸ªç”¨äºç¡®è®¤ç”¨æˆ·çš„èº«ä»½ï¼Œå³éªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> HostHolder hostHolder<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> CacheStore cacheStore<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        String accessToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// access_token å­˜åœ¨</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            String userId <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildAccessTokenKey</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>            hostHolder<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> Exception ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        hostHolder<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœ token æœ‰æ•ˆï¼Œé‚£ä¹ˆæœåŠ¡ç«¯æ ¹æ® token è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° ThreadLocal å®¹å™¨ã€‚æ‰‹æœºç«¯å’Œ PC ç«¯çš„è¯·æ±‚éƒ½ç”±è¯¥æ‹¦æˆªå™¨å¤„ç†ï¼Œå¦‚ PC ç«¯çš„ â€œæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯â€ è¯·æ±‚ï¼Œæ‰‹æœºç«¯çš„ â€œæ‰«ç â€ è¯·æ±‚ã€‚ç”±äºæˆ‘ä»¬å¿½ç•¥äº†æ‰‹æœºç«¯éªŒè¯æ—¶æ‰€éœ€è¦çš„çš„è®¾å¤‡ä¿¡æ¯ï¼Œå› æ­¤ PC ç«¯å’Œæ‰‹æœºç«¯ token å¯ä»¥ä½¿ç”¨åŒä¸€å¥—éªŒè¯é€»è¾‘ã€‚</p><p>å¦ä¸€ä¸ªæ‹¦æˆªå™¨ç”¨äºæ‹¦æˆª â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚ï¼Œå³éªŒè¯ä¸€æ¬¡æ€§ token æ˜¯å¦æœ‰æ•ˆï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> CacheStore cacheStore<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String onceToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"once_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNoneEmpty</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            String onceTokenKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildOnceTokenKey</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">;</span>            String uuidFromCache <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>onceTokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>            String uuidFromRequest <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidFromCache<span class="token punctuation">,</span> uuidFromRequest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"éæ³•çš„ä¸€æ¬¡æ€§ token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ä¸€æ¬¡æ€§ token æ£€æŸ¥å®Œæˆåå°†å…¶åˆ é™¤</span>            cacheStore<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>onceTokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥æ‹¦æˆªå™¨ä¸»è¦æ‹¦æˆª â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ¬¡æ€§ token éªŒè¯é€šè¿‡åè¦ç«‹å³å°†å…¶åˆ é™¤ã€‚</p><blockquote><p>ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç®€åŒ–äº†è®¸å¤šæ“ä½œï¼Œä¾‹å¦‚ï¼š1. å¿½ç•¥æ‰äº†æ‰‹æœºç«¯çš„è®¾å¤‡ä¿¡æ¯ï¼›2. æ‰‹æœºç«¯ç¡®è®¤ç™»å½•åå¹¶æ²¡æœ‰ç›´æ¥ä¸ºç”¨æˆ·ç”Ÿæˆ PC ç«¯ tokenï¼Œè€Œæ˜¯åœ¨è½®è¯¢æ—¶ç”Ÿæˆã€‚</p></blockquote><h2 id="æ•ˆæœæ¼”ç¤º"><a href="#æ•ˆæœæ¼”ç¤º" class="headerlink" title="æ•ˆæœæ¼”ç¤º"></a>æ•ˆæœæ¼”ç¤º</h2><p><strong>1. å·¥å…·å‡†å¤‡</strong></p><ul><li><p>æµè§ˆå™¨ï¼šPC ç«¯æ“ä½œ</p></li><li><p>Postmanï¼šæ¨¡ä»¿æ‰‹æœºç«¯æ“ä½œã€‚</p></li></ul><p><strong>2. æ•°æ®å‡†å¤‡</strong></p><p>ç”±äºæˆ‘ä»¬æ²¡æœ‰å®ç°çœŸå®çš„æ‰‹æœºç«¯æ‰«ç çš„åŠŸèƒ½ï¼Œå› æ­¤ä½¿ç”¨ Postman æ¨¡ä»¿æ‰‹æœºç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦ç¡®ä¿æœåŠ¡ç«¯å­˜å‚¨ç€ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå³åœ¨ Test ç±»ä¸­æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   user<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   user<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span><span class="token string">"/avatar.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user:1"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰‹æœºç«¯å‘é€è¯·æ±‚æ—¶éœ€è¦æºå¸¦æ‰‹æœºç«¯ tokenï¼Œè¿™é‡Œæˆ‘ä»¬ä¸º useId ä¸º â€œ1â€ çš„ç”¨æˆ·ç”Ÿæˆä¸€ä¸ª tokenï¼ˆæ‰‹æœºç«¯ tokenï¼‰ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">loginByPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   String accessToken <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>   cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildAccessTokenKey</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰‹æœºç«¯ tokenï¼ˆaccessTokenï¼‰ä¸º â€œaae466837d0246d486f644a3bcfaa9e1â€ï¼ˆéšæœºå€¼ï¼‰ï¼Œä¹‹åå‘é€ â€œæ‰«ç â€ è¯·æ±‚æ—¶éœ€è¦æºå¸¦è¿™ä¸ª tokenã€‚</p><p><strong>3. æ‰«ç ç™»å½•æµç¨‹å±•ç¤º</strong></p><p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—® <code>localhost:8080/index</code>ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/index.jpg" alt></p><p>ç‚¹å‡»ç™»å½•ï¼Œå¹¶åœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰¾åˆ°äºŒç»´ç  idï¼ˆuuidï¼‰ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/uuid.jpg" alt></p><p>æ‰“å¼€ Postmanï¼Œå‘é€ <code>localhost:8080/login/scan</code> è¯·æ±‚ï¼ŒQuery å‚æ•°ä¸­æºå¸¦ uuidï¼ŒHeader ä¸­æºå¸¦æ‰‹æœºç«¯ tokenï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E6%89%AB%E7%A0%81%E8%AF%B7%E6%B1%82.jpg" alt></p><p>ä¸Šè¿°è¯·æ±‚è¿”å› â€œæ‰«ç æˆåŠŸâ€ çš„å“åº”ï¼ŒåŒæ—¶è¿˜è¿”å›äº†ä¸€æ¬¡æ€§ tokenã€‚æ­¤æ—¶ PC ç«¯æ˜¾ç¤ºå‡ºæ‰«ç ç”¨æˆ·çš„å¤´åƒï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E5%BE%85%E7%A1%AE%E8%AE%A4.jpg" alt></p><p>åœ¨ Postman ä¸­å‘é€ <code>localhost:8080/login/confirm</code> è¯·æ±‚ï¼ŒQuery å‚æ•°ä¸­æºå¸¦ uuidï¼ŒHeader ä¸­æºå¸¦ä¸€æ¬¡æ€§ tokenï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E7%A1%AE%E8%AE%A4%E8%AF%B7%E6%B1%82.jpg" alt></p><p>â€œç¡®è®¤ç™»å½•â€ è¯·æ±‚å‘é€å®Œæˆåï¼ŒPC ç«¯éšå³è·å–åˆ° PC ç«¯ tokenï¼Œå¹¶æˆåŠŸæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F.jpg" alt></p><p><strong>ç»“è¯­</strong></p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†æ‰«ç ç™»å½•çš„åŸç†ï¼Œå¹¶å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆæ‰«ç ç™»å½•çš„ Demoã€‚å…³äºåŸç†éƒ¨åˆ†çš„ç†è§£é”™è¯¯ä»¥åŠä»£ç ä¸­çš„ä¸è¶³ä¹‹å¤„æ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ï¼ˆâŒ’.ï¼ï¼‰ï¼Œæºç è§<a href="https://github.com/JavaerJohn/loginByQrCode" target="_blank" rel="noopener">æ‰«ç ç™»å½•</a>ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·çš„è¯ç»™ä¸ª Star å§~ã€‚</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://juejin.cn/post/6940976355097985032#heading-1" target="_blank" rel="noopener">äºŒç»´ç æ‰«ç ç™»å½•æ˜¯ä»€ä¹ˆåŸç† </a><br><a href="https://juejin.cn/post/6844904111398191117?utm_source=gold_browser_extension" target="_blank" rel="noopener">èŠä¸€èŠäºŒç»´ç æ‰«æç™»å½•åŸç† </a></p><!-- ### æµç¨‹ç®€è¿°1. PC ç«¯æ‰“å¼€äºŒç»´ç ç™»å½•é¡µé¢ login.html;2. login.html è°ƒç”¨åç«¯æ¥å£ createQrCodeImgï¼Œè¯¥æ¥å£ç”Ÿæˆä¸€ä¸ªéšæœºçš„ uuidï¼Œuuid å¯çœ‹åšæ˜¯æœ¬é¡µé¢çš„å”¯ä¸€æ ‡è¯†ï¼ŒåŒæ—¶è¯¥æ¥å£è¿˜ä¼šåˆ›å»ºä¸€ä¸ª LoginTicket å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­å°è£…äº†å¦‚ä¸‹ä¿¡æ¯ï¼š   - uuidï¼šé¡µé¢çš„å”¯ä¸€æ ‡è¯†ï¼›   - userIdï¼šç”¨æˆ· idï¼›   - statusï¼šæ‰«ç çŠ¶æ€ï¼Œ0 è¡¨ç¤ºç­‰å¾…æ‰«ç ï¼Œ1 è¡¨ç¤ºç­‰å¾…ç¡®è®¤ï¼Œ2 è¡¨ç¤ºå·²ç¡®è®¤ã€‚ 3. å°†ä¸Šè¿° uuid ä½œä¸º keyã€LoginTicket å¯¹è±¡ä½œä¸º value å­˜å‚¨åœ¨ Redis æœåŠ¡å™¨ä¸­ï¼ˆæˆ–å…¶ä»–æ•°æ®åº“ï¼‰ï¼Œè®¾ç½®å…¶è¿‡æœŸæ—¶é—´ä¸º 5 åˆ†é’Ÿï¼Œè¡¨ç¤º 5 åˆ†é’ŸåäºŒç»´ç å¤±æ•ˆã€‚4. ç”ŸæˆäºŒç»´ç å›¾ç‰‡ï¼ŒäºŒç»´ç ä¸­å°è£…çš„ä¿¡æ¯ä¸ºä¸€ä¸ª URLï¼Œç±»ä¼¼äº `http://localhost:8080/login/scan/uuid=1be1cf4a5ceb4d73a8f2104ffe5fba0c`ã€‚5. PC ç«¯æ˜¾ç¤ºäºŒç»´ç ï¼› 6. PC ç«¯é¡µé¢ä¸æ–­è½®è¯¢ï¼ˆå¤šä¹…è½®è¯¢ä¸€æ¬¡è‡ªè¡Œè®¾ç½®ï¼‰æ£€æŸ¥æ‰«ç çš„è¿›åº¦ï¼Œå³ LoginTicket å¯¹è±¡çš„çŠ¶æ€ã€‚å¦‚æœä¸º 0 æˆ–ä¸º 1ï¼Œç»§ç»­è½®è¯¢ï¼›å¦‚æœä¸º 2ï¼Œåœæ­¢è½®è¯¢ï¼ˆå·²ç¡®è®¤ç™»å½•ï¼‰ï¼›7. æ‰‹æœºç«¯æ‰«æäºŒç»´ç ï¼›8. æ‰‹æœºç«¯ï¼ˆæºå¸¦ç”¨æˆ·çš„ tokenï¼Œè¯¥ token ä¸ºæ‰‹æœºç«¯ tokenï¼‰è®¿é—®äºŒç»´ç ä¸­çš„ç›®æ ‡ç½‘å€ï¼Œæ‰‹æœºç«¯æœåŠ¡å™¨é¦–å…ˆéªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆåˆ™å°† LoginTicket å¯¹è±¡çš„ status æ›´æ–°ä¸º 1ï¼›9. æ‰‹æœºç«¯æœåŠ¡å™¨è¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®è®¤ç™»å½•ï¼›10. ç”¨æˆ·é€‰æ‹©ç¡®è®¤ç™»å½•ï¼Œæ‰‹æœºç«¯æœåŠ¡å™¨å°† LoginTicket å¯¹è±¡çš„ status æ›´æ–°ä¸º 2ï¼Œå¹¶å°† userId è®¾ç½®ä¸ºå½“å‰ç”¨æˆ·çš„ idï¼›11. PC ç«¯æ£€æµ‹åˆ°ç”¨æˆ·ç¡®è®¤ç™»å½•åï¼Œä¸ºç”¨æˆ·ç”Ÿæˆ tokenï¼ˆæ­¤ token ä¸º PC ç«¯çš„ tokenï¼‰ï¼Œå¹¶å°† token è¿”å›ç»™å‰ç«¯ï¼›12. å‰ç«¯è·å–åˆ° token åå°±å¯ä»¥æ‰§è¡Œå…¶ä»–æ“ä½œã€‚### æµç¨‹å›¾æ€»ä½“æµç¨‹å¦‚ä¸‹ï¼š![æ‰«ç ç™»å½•æµç¨‹å›¾](./QrCodeLogin.jpg) --><!-- ## å®ç° --><!-- ### ç¯å¢ƒå‡†å¤‡1. JDK 1.8ï¼›2. maven 3.3.6ï¼›3. Springboot 2.xxï¼›4. Redisã€‚### å®ä½“å¯¹è±¡LoginTicket ç±»å®šä¹‰å¦‚ä¸‹ï¼š```Java@Datapublic class LoginTicket {   private String userId;   private String uuid;   private int status;}```User ç±»ç®€å•å°è£…ç”¨æˆ·çš„ id å’Œ nameï¼š```Java@Datapublic class User {   private String userId;   private String userName;}```### ç™»å½•æ¥å£1. è·å–äºŒç»´ç ```Java@RequestMapping(path = "/getQrCodeImg", method = RequestMethod.GET)public String createQrCodeImg(Model model) {   // ç”Ÿæˆuuidå’ŒloginTicketå¯¹è±¡å¹¶å­˜å…¥Redis   String uuid = loginService.createQrImg();   // ä½¿ç”¨QrCodeUtilç”ŸæˆäºŒç»´ç    String QrCode = Base64.encodeBase64String(QrCodeUtil.generatePng(loginURL + uuid, 300, 300));   // è¿”å›uuidå’ŒäºŒç»´ç    model.addAttribute("uuid", uuid);   model.addAttribute("QrCode", QrCode);   return "login";}```å½“è®¿é—® "localhost:8080/login/getQrCodeImg" æ—¶ï¼ŒPC ç«¯æœåŠ¡å™¨ä¼šç”Ÿæˆä¸€ä¸ª uuid å’Œä¸€ä¸ª LoginTicket å¯¹è±¡ï¼Œç„¶åå°† uuid ä½œä¸º keyï¼ŒLoginTicket å¯¹è±¡ä½œä¸º value å­˜å…¥åˆ° Redis æœåŠ¡å™¨ä¸­ï¼ˆè®¾ç½®å…¶è¿‡æœŸæ—¶é—´ä¸º 5 åˆ†é’Ÿï¼‰ã€‚æ¥ç€å°†è¯¥ uuid æ‹¼æ¥åˆ° URL ä¸­ï¼ˆæ­¤ URL å³ä¸ºæ‰‹æœºç«¯æ‰«ç åæ‰€è®¿é—®çš„ç½‘å€ï¼‰ï¼Œå¹¶ä½¿ç”¨å¼€æºå·¥å…·ç±» Hutool ä¸­çš„ QrCodeUtil ç”ŸæˆäºŒç»´ç å›¾ç‰‡ã€‚>å…³äº Hutool çš„ä½¿ç”¨å¯ä»¥å‚è€ƒ https://hutool.cn/ ã€‚ --><!-- 2. æ‰«æäºŒç»´ç ```Java@RequestMapping(path = "/scan/{uuid}/{userId}", method = RequestMethod.GET)public String scanQrCodeImg(Model model, @PathVariable("uuid") String uuid, @PathVariable("userId") String userId) {   // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æˆåŠŸæ‰«ç    boolean scanned = loginService.scanQrCodeImg(uuid, userId);   // è¿”å›æ‰«ç ä¿¡æ¯   model.addAttribute("scanned", scanned);   model.addAttribute("uuid", uuid);   model.addAttribute("userId", userId);   return "scan";}```äºŒç»´ç ä¸­å°è£…çš„ä¿¡æ¯æ˜¯ä¸€ä¸ª URLï¼Œæ‰‹æœºç«¯æ‰«æäºŒç»´ç æ—¶ï¼Œä¼šè®¿é—®è¯¥ URL æ‰€ä»£è¡¨çš„çš„ç½‘å€ã€‚æ­¤æ—¶è¯·æ±‚ä¸­ä¼šæºå¸¦æ‰‹æœºç«¯ç”¨æˆ·çš„ token å’Œ uuidï¼Œtoken ç”¨æ¥ç¡®è®¤ç”¨æˆ·çš„èº«ä»½ã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç®€åŒ–æ‰‹æœºç«¯çš„æ“ä½œï¼Œç›´æ¥ä¼ å…¥ userIdï¼Œåˆ©ç”¨ userId ä»£æ›¿ token æ¥è¯†åˆ«ç”¨æˆ·ã€‚æœåŠ¡å™¨ï¼ˆæ­¤å¤„ä¸ºæ‰‹æœºç«¯æœåŠ¡å™¨ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ PC ç«¯æœåŠ¡å™¨æ¨¡æ‹Ÿæ‰‹æœºç«¯æœåŠ¡å™¨ï¼‰é¦–å…ˆæ ¹æ® userId æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•ï¼Œå¦‚æœ Redis ä¸­å­˜åœ¨è¯¥ç”¨æˆ·çš„ä¿¡æ¯ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·å·²ç»ç™»å½•ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•æˆ–äºŒç»´ç å·²ç»è¿‡æœŸï¼Œåˆ™æ‰«ç å¤±è´¥ï¼Œè¿”å› falseï¼›å¦åˆ™å°† LoginTicket å¯¹è±¡çš„çŠ¶æ€è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤ºå·²ç»æ‰«ç ï¼Œç­‰å¾…ç¡®è®¤ã€‚3. ç¡®è®¤ç™»å½•```Java@RequestMapping(path = "/confirm/{uuid}/{userId}", method = RequestMethod.GET)@ResponseBodypublic Response confirmLogin(@PathVariable("uuid") String uuid, @PathVariable("userId") String userId) {   // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æˆåŠŸç¡®è®¤   boolean logged = loginService.confirmLogin(uuid, userId);   String msg = logged ? "ç™»å½•æˆåŠŸ!" : "äºŒç»´ç å·²è¿‡æœŸ!";   return Response.createResponse(msg, logged);}```åŒæ‰«ç è¯·æ±‚ä¸€æ ·ï¼Œç¡®è®¤ç™»å½•æ—¶ä¹Ÿä½¿ç”¨ userId ä»£æ›¿ token è¿›è¡Œèº«ä»½è¯†åˆ«ã€‚æ‰‹æœºç«¯ï¼ˆåœ¨æµè§ˆå™¨ä¸­æ¨¡æ‹Ÿæ‰‹æœºç«¯æ“ä½œï¼‰å‘é€ç¡®è®¤è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥äºŒç»´ç æ˜¯å¦è¿‡æœŸï¼ˆæŒ‰ç†æ¥è¯´æ‰«ç åå†ç¡®è®¤ï¼ŒäºŒç»´ç åº”è¯¥ä¸ä¼šè¿‡æœŸï¼‰ã€‚å¦‚æœç¡®è®¤æˆåŠŸï¼Œé‚£ä¹ˆå°† LoginTicket å¯¹è±¡çš„çŠ¶æ€è®¾ç½®ä¸º 2ï¼Œå¹¶å°† userId ç½®ä¸ºå½“å‰ç”¨æˆ·çš„ idï¼ˆæˆ–è®¸ userId åœ¨ scan åœ¨æ‰«ç è¯·æ±‚å°±åº”è¯¥è®¾ç½®ä¸ºç”¨æˆ· idï¼Ÿï¼‰ã€‚4. è½®è¯¢```Java@RequestMapping(path = "/getQrCodeState/{uuid}", method = RequestMethod.GET)@ResponseBodypublic Response getQrCodeState(@PathVariable("uuid") String uuid) throws InterruptedException {   JSONObject data = new JSONObject();   // æ£€æŸ¥äºŒç»´ç æ˜¯å¦è¿‡æœŸ   String redisKey = CommonUtil.getTicketKey(uuid);   LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);   if (loginTicket == null) {      data.put("status", -1);      return Response.createResponse("äºŒç»´ç å·²è¿‡æœŸ!", data);   }   // æ£€æŸ¥status   int status = loginTicket.getStatus();   data.put("status", status);   if (status == 2) {      // ç”¨æˆ·å·²ç¡®è®¤ç™»å½•      String userId = loginTicket.getUserId();      User user = userService.getLoggedUser(userId);      if (user != null) {         // ç”Ÿæˆtoken         String token = TokenUtil.buildToken(userId, user.getUserName());         data.put("token", token);         return Response.createResponse(null, data);      }      return Response.createErrorResponse("æ— ç”¨æˆ·ä¿¡æ¯!");   }   // 2sè½®è¯¢ä¸€æ¬¡   Thread.sleep(2000);   String msg = status == 0 ? null : "å·²æ‰«æ, ç­‰å¾…ç¡®è®¤";   return Response.createResponse(msg, data);}```è½®è¯¢çš„é€»è¾‘å…¶å®å°±æ˜¯æ ¹æ® uuid æ£€æŸ¥ LoginTicket å¯¹è±¡çš„çŠ¶æ€ï¼Œå¦‚æœ LoginTicket å¯¹è±¡ä¸ºç©ºï¼Œè¡¨ç¤ºäºŒç»´ç å·²ç»è¿‡æœŸï¼›å¦‚æœ status ä¸º 0ï¼Œè¡¨ç¤ºç­‰å¾…æ‰«ç ï¼›å¦‚æœ status ä¸º 1ï¼Œè¡¨ç¤ºå·²æ‰«ç ï¼Œç­‰å¾…ç¡®è®¤ï¼›å¦‚æœ status ä¸º 2ï¼Œè¡¨ç¤ºå·²ç¡®è®¤ç™»å½•ã€‚å½“æ£€æµ‹åˆ°ç”¨æˆ·ç¡®è®¤ç™»å½•åï¼ŒæœåŠ¡å™¨ä¸ºç”¨æˆ·ç”Ÿæˆ tokenï¼ˆæ­¤ token ç”¨äº PC ç«¯æœåŠ¡å™¨è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼‰ï¼Œç„¶åå°† token è¿”å›ç»™å‰ç«¯ã€‚æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ç”Ÿæˆ token ä¹‹å‰ï¼Œè°ƒç”¨äº† UserService ä¸­çš„ getLoggedUser æ–¹æ³•æ¥æŸ¥è¯¢ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œåœ¨æ­¤ demo ä¸­ï¼Œä¸ºäº†ç®€åŒ–æ“ä½œï¼Œå‡¡æ˜¯éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯çš„åœ°æ–¹æˆ‘ä»¬éƒ½ä½¿ç”¨è¯¥æ–¹æ³•å»è·å–ï¼Œå¦‚å‰é¢æ‰‹æœºç«¯æœåŠ¡å™¨ï¼ˆå…¶å®ä¹Ÿæ˜¯åœ¨ PC ç«¯æ¨¡æ‹Ÿï¼‰æ ¹æ® token ï¼ˆä¸ºäº†ç®€åŒ–ï¼Œå®é™…ä¸Šä¸º userIdï¼‰æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ—¶ä¹Ÿè°ƒç”¨äº†è¯¥æ–¹æ³•ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæœ€åä¸€æ­¥çš„ token ä¹Ÿå¯ä»¥ä½¿ç”¨ cookie æ¥ä»£æ›¿ï¼Œè¿™æ ·ä¹Ÿè®¸ä¼šæ›´åŠ ç®€å•ï¼Œå› ä¸ºæƒ³å­¦ä¹ ä¸€ä¸‹ JWTï¼Œæ‰€ä»¥é‡‡ç”¨ tokenï¼ˆä½¿ç”¨ token è®¿é—®æ—¶ï¼Œtoken åº”è¯¥æ€æ ·ä¿å­˜å‘¢ï¼Œè‹¦æ¼!!!!!+10086ï¼‰ã€‚getLoggedUser æ–¹æ³•å…¶å®å°±æ˜¯æ£€æµ‹ Redis ä¸­æœ‰æ— ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š```Javapublic User getLoggedUser(String userId) {   String redisKey = CommonUtil.getUserKey(userId);   return (User) redisTemplate.opsForValue().get(redisKey);}```### Service å±‚Service å±‚å¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š```Java@Servicepublic class LoginService {   private final int WAIT_EXPIRED_SECONDS = 60 * 5;   private final int LOGIN_EXPIRED_SECONDS = 3600 * 24;   @Autowired   private RedisTemplate redisTemplate;   public String createQrImg() {      // ç”ŸæˆloginTicket      String uuid = CommonUtil.generateUUID();      LoginTicket loginTicket = new LoginTicket();      loginTicket.setUuid(uuid);      loginTicket.setStatus(0);      // å­˜å…¥redis      String redisKey = CommonUtil.getTicketKey(loginTicket.getUuid());      redisTemplate.opsForValue().set(redisKey, loginTicket, WAIT_EXPIRED_SECONDS, TimeUnit.SECONDS);      return uuid;   }   public boolean scanQrCodeImg(String uuid, String userId) {      String ticketKey = CommonUtil.getTicketKey(uuid);      String userKey = CommonUtil.getUserKey(userId);      LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(ticketKey);      User user = (User) redisTemplate.opsForValue().get(userKey);      // æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç™»å½•ä»¥åŠäºŒç»´ç æ˜¯å¦è¿‡æœŸ      if (user == null || loginTicket == null) {         return false;      } else {         // å°†statusç½®ä¸º1         loginTicket.setStatus(1);         redisTemplate.opsForValue().set(ticketKey, loginTicket, redisTemplate.getExpire(ticketKey, TimeUnit.SECONDS), TimeUnit.SECONDS);      }      return true;   }   public boolean confirmLogin(String uuid, String userId) {      String redisKey = CommonUtil.getTicketKey(uuid);      LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);      boolean logged = true;      if (loginTicket == null) {         logged = false;      } else {         // å°†userIdç½®ä¸ºç”¨æˆ·id, å¹¶å°†statusç½®ä¸º2         loginTicket.setUserId(userId);         loginTicket.setStatus(2);         redisTemplate.opsForValue().set(redisKey, loginTicket, LOGIN_EXPIRED_SECONDS, TimeUnit.SECONDS);      }      return logged;   }}```å‰ç«¯çš„å‡ ä¸ª xx.html æ–‡ä»¶çš„ä»£ç å†™å¾—ä¸å¤ªå¥½ï¼Œå¤§å®¶ç›´æ¥çœ‹æºç å§ï¼Œæºç æˆ‘ä¼šæ”¾åœ¨æ–‡æœ«ã€‚ --><!-- ## æ•ˆæœæ¼”ç¤ºæ‰§è¡Œç¨‹åºå‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Redis ä¸­å­˜å‚¨å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºç”¨æˆ·åœ¨æ‰‹æœºç«¯å·²ç»ç™»å½•ï¼Œå…¶ä¸­ key çš„æ ¼å¼ä¸º user:userIdï¼Œvalue ä¸º User å¯¹è±¡ã€‚æ¯”å¦‚åœ¨æ¼”ç¤ºå‰ï¼Œæˆ‘ä»¬åœ¨ Redis ä¸­å­˜å‚¨äº† userId ä¸º "1" çš„ç”¨æˆ· "JoinåŒå­¦"ã€‚æ¼”ç¤ºåŠ¨å›¾å¦‚ä¸‹ï¼š![æ‰«ç ç™»å½•æ¼”ç¤ºå›¾](./loginByQrCode.gif) --><!-- 1. å¯åŠ¨é¡¹ç›®ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® localhost:8080/indexï¼Œæ˜¾ç¤º 'é¦–é¡µ'ï¼›2. ç‚¹å‡» 'ç™»å½•'ï¼Œè¿›å…¥äºŒç»´ç ç™»å½•ç•Œé¢ï¼›3. ä½¿ç”¨å¼€å‘è€…å·¥å…·è·å–ç”Ÿæˆçš„ uuidï¼›4. æ¨¡ä»¿æ‰‹æœºç«¯ï¼Œåœ¨å¦å¤–ä¸€ä¸ªé¡µé¢ä¸­è®¿é—® localhost:8080/login/scan/uuid/userIdï¼Œæ³¨æ„ uuid ä¸ºæ­¥éª¤ 3 ä¸­è·å–çš„ uuidï¼ŒuserId æ‰€å¯¹åº”çš„ User éœ€è¦å­˜å‚¨åœ¨ Redis ä¸­ï¼ˆè¡¨ç¤ºæ‰‹æœºç«¯ç”¨æˆ·å·²ç™»å½•ï¼ŒRedis ä¸­çš„ key ä¸º userIdï¼Œvalue ä¸º User å¯¹è±¡ï¼‰ã€‚5. å¼¹å‡ºç¡®è®¤ç™»å½•çª—å£ï¼›6. æ­¤æ—¶é¦–é¡µä¸Šæ˜¾ç¤ºç­‰å¾…ç¡®è®¤ï¼›7. ç‚¹è§£ç¡®è®¤ç™»å½•8. ç™»é™†æˆåŠŸï¼›9. é¦–é¡µä¸Šæ˜¾ç¤ºç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ã€‚ --><!-- ## å¾…æ”¹è¿›1. æ•´ä¸ªæµç¨‹åº”è¯¥å­˜åœ¨æ‰‹æœºç«¯æœåŠ¡å™¨å’Œ PC ç«¯æœåŠ¡å™¨ï¼Œä½†ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬åˆ©ç”¨ PC ç«¯æ¨¡æ‹Ÿæ‰‹æœºç«¯ï¼Œæ¯”å¦‚æ‰«ç å’Œç¡®è®¤è¯·æ±‚åº”è¯¥ç”±æ‰‹æœºç«¯æœåŠ¡å™¨å¤„ç†ï¼Œè€Œç¨‹åºä¸­æˆ‘ä»¬ç›´æ¥åœ¨ PC ç«¯è®¿é—®å¯¹åº”çš„ Controllerï¼›2. æ£€æŸ¥æ‰«ç çŠ¶æ€æ—¶é‡‡ç”¨äº†è½®è¯¢çš„æ–¹å¼ï¼Œæˆ–è®¸å¯ä»¥é‡‡ç”¨ Websocketï¼›3. "æ‰‹æœºç«¯" éªŒè¯ "token" æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ userId æ¥ç®€åŒ–æ“ä½œï¼›4. æœ€åä¸€æ­¥æˆ‘ä»¬å°† token è¿”å›ç»™äº†å‰ç«¯ï¼Œå‰ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œéœ€è¦åœ¨ header ä¸­å­˜æ”¾ tokenï¼Œä½†é—®é¢˜æ˜¯ token åº”è¯¥å¦‚ä½•ä¿å­˜å‘¢ï¼Ÿä¹‹åéœ€è¦è§£å†³æ­¤é—®é¢˜ï¼›5. æœªå­¦ä¹ è¿‡å‰ç«¯ï¼Œæ‰€ä»¥ä»£ç ä¸æ€ä¹ˆè§„èŒƒã€‚### **æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæºç è§** -->]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿè®¾è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ©ç”¨ Nginx å®ç°åŠ¨é™åˆ†ç¦»</title>
      <link href="/2022/032508.html"/>
      <url>/2022/032508.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>åŠ¨é™åˆ†ç¦»æŒ‡çš„æ˜¯å°†åŠ¨æ€è¯·æ±‚å’Œé™æ€è¯·æ±‚åˆ†éš”å¼€ï¼Œç„¶ååˆ†åˆ«è·¯ç”±åˆ°ç›¸åº”çš„åç«¯æœåŠ¡å™¨ã€‚é€šå¸¸ç”¨æˆ·çš„è¯·æ±‚ä¸­ï¼Œä¸€éƒ¨åˆ†éœ€è¦åå°ç¨‹åºå¤„ç†ï¼Œä¾‹å¦‚æŸ¥è¯¢æ•°æ®åº“æˆ–è€…è¿›è¡Œä¸€äº›æ•°æ®è¿ç®—ï¼Œè¿™ç±»è¯·æ±‚æˆ‘ä»¬ç§°ä¹‹ä¸ºåŠ¨æ€è¯·æ±‚ï¼›è¿˜æœ‰ä¸€éƒ¨åˆ†ä¸éœ€è¦åå°ç¨‹åºå¤„ç†ï¼Œå¦‚è¯·æ±‚ cssã€htmlã€jsã€å›¾ç‰‡ç­‰é™æ€èµ„æºï¼Œè¿™ç±»è¯·æ±‚æˆ‘ä»¬ç§°ä¹‹ä¸ºé™æ€è¯·æ±‚ã€‚Nginx å®ç°åŠ¨é™åˆ†ç¦»çš„åŸºç¡€æ˜¯å®ƒå¯ä»¥æ ¹æ®é…ç½®å¯¹ä¸åŒçš„è¯·æ±‚åšä¸åŒçš„è½¬å‘ï¼ŒåŠ¨é™åˆ†ç¦»æœ‰åˆ©äºæé«˜æ•´ä¸ªæœåŠ¡å™¨ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.png" width="70%"></p><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>åœ¨æœ¬æœºï¼ˆLinux è™šæ‹Ÿæœºï¼‰ä¸­å®‰è£… Nginxï¼Œå¹¶ç¡®ä¿ Nginx å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ä¸ºäº†ä¾¿äºå®è·µï¼Œæˆ‘ä»¬åœ¨ä¸€å°æœºå™¨ä¸Šæ‰§è¡Œæ‰€æœ‰æ“ä½œï¼Œä¹Ÿå°±æ˜¯åœ¨æœ¬æœºä¸­éƒ¨ç½² Nginx å’Œå¤„ç†åŠ¨æ€è¯·æ±‚çš„åç«¯æœåŠ¡ï¼ŒåŒæ—¶æœ¬æœºä¹Ÿä¼šä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨å­˜æ”¾é™æ€æ–‡ä»¶ã€‚æ³¨æ„ï¼Œå®é™…ä¸­å¯ä½¿ç”¨ä¸åŒçš„æœºå™¨åˆ†å¼€éƒ¨ç½²ã€‚</p><p><strong>é™æ€èµ„æºå‡†å¤‡</strong></p><p>åœ¨æœ¬æœº <code>/usr/local/</code> ç›®å½•ä¸‹åˆ›å»º <code>/data/img</code> å’Œ <code>/data/html</code> æ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«å­˜æ”¾ test.png å’Œ test.htmlï¼š</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/test.png" width="70%"></p><p><strong>åç«¯æœåŠ¡</strong></p><p>å†™ä¸€ä¸ªç®€å•çš„ â€œHello Worldâ€ é¡¹ç›®å¹¶å¯åŠ¨ï¼Œç«¯å£ä¸º 8080ï¼š </p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token annotation punctuation">@RequestMapping</span><span class="token annotation punctuation">@Log</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®é™…åº”ç”¨ä¸­çš„åŠ¨æ€è¯·æ±‚é€šå¸¸ä¼šæ¶‰åŠç›¸å…³èµ„æºçš„è°ƒåº¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€åŒ–è¯¥è¿‡ç¨‹ï¼Œå‡è®¾åç«¯æœåŠ¡è¿›è¡Œäº†ä¸€ç³»åˆ—è¿ç®—ï¼Œæœ€åè¿”å›å­—ç¬¦ä¸² â€œHello, world!â€ã€‚</p><h2 id="é…ç½®-Nginx"><a href="#é…ç½®-Nginx" class="headerlink" title="é…ç½® Nginx"></a>é…ç½® Nginx</h2><p>æ‰“å¼€ nginx.conf é…ç½®æ–‡ä»¶ï¼Œåœ¨ server å—ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">server <span class="token punctuation">{</span>    listen       80<span class="token punctuation">;</span>    server_name  localhost<span class="token punctuation">;</span>    location / <span class="token punctuation">{</span>        root   html<span class="token punctuation">;</span>        index  index.html index.htm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">#æ‹¦æˆªåŠ¨æ€è¯·æ±‚</span>    location /hello <span class="token punctuation">{</span>        proxy_pass http://localhost:8080<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">#æ‹¦æˆªé™æ€è¯·æ±‚</span>    location /img <span class="token punctuation">{</span>        root /usr/local/data<span class="token punctuation">;</span>        autoindex on<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">#æ‹¦æˆªé™æ€è¯·æ±‚</span>    location /html <span class="token punctuation">{</span>        root /usr/local/data<span class="token punctuation">;</span>        autoindex on<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>åŠ¨æ€è¯·æ±‚</strong></p><p>æµè§ˆå™¨ä¸­è¾“å…¥ <code>localhost/hello</code> å¾—åˆ°å¦‚ä¸‹å“åº”ï¼š</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/%E5%8A%A8%E6%80%81%E8%AF%B7%E6%B1%82%E7%BB%93%E6%9E%9C.png" width="70%"></p><p>è¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šç«¯å£ï¼Œå› ä¸º HTTP çš„é»˜è®¤ç«¯å£å°±æ˜¯ 80ï¼Œè€Œ Nginx é…ç½®æ–‡ä»¶ä¸­ä¹Ÿç›‘å¬äº† 80 ç«¯å£ï¼ŒçœŸå®çš„è¯·æ±‚ä¸º  <code>localhost:8080/hello</code>ã€‚</p><p><strong>é™æ€è¯·æ±‚</strong></p><p>æµè§ˆå™¨ä¸­è¾“å…¥ <code>localhost/img</code>ï¼Œå¾—åˆ°å¦‚ä¸‹å“åº”ï¼š</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" width="70%"></p><p>ä¸Šå›¾ä¸­åˆ—ä¸¾å‡ºäº† <code>/img</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºé…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº† <code>autoindex on;</code>ï¼Œå®ƒè¡¨ç¤ºæ‰“å¼€ç›®å½•æµè§ˆåŠŸèƒ½ã€‚</p><p>æµè§ˆå™¨ä¸­è¾“å…¥ <code>localhost/img/test.png</code>ï¼Œå¾—åˆ°å¦‚ä¸‹å“åº”ï¼š</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/%E5%9B%BE%E7%89%87%E7%BB%93%E6%9E%9C.png" width="70%"></p><p>æµè§ˆå™¨ä¸­è¾“å…¥ <code>localhost/html/test.html</code>ï¼Œå¾—åˆ°å¦‚ä¸‹å“åº”ï¼š</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/html%E7%BB%93%E6%9E%9C.png" width="70%"></p><p>ä¸Šè¿°æ“ä½œä¸­ï¼Œæˆ‘ä»¬å®ç°äº†é™æ€è¯·æ±‚å’ŒåŠ¨æ€è¯·æ±‚çš„åˆ†ç¦»ï¼Œå½“è®¿é—®é™æ€èµ„æºï¼ˆå¦‚ html å’Œå›¾ç‰‡ï¼‰æ—¶ï¼Œè¯·æ±‚å¹¶ä¸ä¼šåˆ°è¾¾ â€œHello Worldâ€ åç«¯æœåŠ¡ï¼Œè€Œæ˜¯ä»é™æ€èµ„æºæœåŠ¡å™¨ï¼ˆè¿™é‡Œæ˜¯æœ¬æœºï¼‰ä¸­è·å–èµ„æºï¼Œå½“è®¿é—® <code>localhost/img/test.png</code> æ—¶ï¼ŒçœŸå®çš„è¯·æ±‚ä¸º <code>localhost:80/usr/data/img/test.png</code>ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥å°†è´Ÿè´£æ‹¦æˆªé™æ€è¯·æ±‚çš„ location å—å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æ‹¦æˆªé™æ€è¯·æ±‚</span>location ~ .*\.<span class="token punctuation">(</span>html<span class="token operator">|</span>htm<span class="token operator">|</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>bmp<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>    root /usr/local/data<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢è§£æä¸€ä¸‹ä¸Šè¿°é…ç½®ä¸­çš„åŒ¹é…è§„åˆ™ï¼š</p><ul><li><p><code>~</code>ï¼šè¡¨ç¤ºåŒ¹é…æ—¶åŒºåˆ†å¤§å°å†™ã€‚</p></li><li><p><code>.*</code>ï¼š<code>.</code> è¡¨ç¤ºåŒ¹é…é™¤æ¢è¡Œç¬¦ <code>\n</code> ä¹‹å¤–çš„ä»»ä½•å•å­—ç¬¦ï¼Œ<code>*</code> è¡¨ç¤ºé›¶æ¬¡æˆ–å¤šæ¬¡ï¼Œæ‰€ä»¥ <code>.*</code> è¡¨ç¤ºä»»æ„å­—ç¬¦å‡ºç°é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚</p></li><li><p><code>\.</code>ï¼šè¡¨ç¤ºåŒ¹é…å­—ç¬¦ <code>.</code>ã€‚</p></li></ul><p>ç»¼ä¸Šï¼Œè¯¥é…ç½®è¡¨ç¤ºåŒ¹é…ä»¥ <code>.html, Â·Â·Â·, .css</code> ä¸ºåç¼€çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å°† htmlã€jpg ç­‰é™æ€èµ„æºå­˜å…¥åˆ° <code>/usr/local/data</code> ä¸‹ï¼Œç„¶åé€šè¿‡æŒ‡å®šçš„ URL å°±å¯ä»¥è®¿é—®åˆ°è¿™äº›èµ„æºï¼Œå½“ç„¶ä¸åŒç±»å‹çš„èµ„æºä¹Ÿå¯ä»¥åˆ†å¼€å­˜æ”¾ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx å¿«é€Ÿå…¥é—¨</title>
      <link href="/2022/0347606.html"/>
      <url>/2022/0347606.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>Nginx æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç† Web æœåŠ¡å™¨ï¼ŒåŒæ—¶å®ƒæä¾›äº† IMAPã€POP3 ä»¥åŠ SMTP ç­‰æœåŠ¡ï¼Œå› æ­¤ä¹Ÿå¯ä½œä¸ºç”µå­é‚®ä»¶ä»£ç†æœåŠ¡å™¨ã€‚Nginx å ç”¨å†…å­˜å°‘ï¼Œå¹¶å‘èƒ½åŠ›å¼ºï¼Œç›®å‰å·²è¢«è®¸å¤šå›½å†…äº§å•†æ‰€ä½¿ç”¨ã€‚</p><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨-Nginx"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-Nginx" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ Nginx"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ Nginx</h2><p>ç½‘ç«™å»ºè®¾åˆæœŸï¼Œç”±äºç”¨æˆ·æ•°æ¯”è¾ƒå°‘ï¼Œå¹¶å‘é‡æ¯”è¾ƒä½ï¼Œä¸€å°æœåŠ¡å™¨åŸºæœ¬èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œé€šè¿‡éƒ¨ç½² Tomcat å°±èƒ½å°†æ•°æ®ä¿¡æ¯è¿”å›ç»™ç”¨æˆ·ã€‚</p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/%E5%8D%95%E7%94%A8%E6%88%B7.png" width="70%"><p>æ…¢æ…¢çš„ï¼Œéšç€ç”¨æˆ·æ•°ä¸æ–­å¢å¤§ï¼Œè¾ƒé«˜çš„å¹¶å‘é‡ä½¿å¾—æœåŠ¡å™¨ä¸Šå¤„ç†è¯·æ±‚çš„çº¿ç¨‹å’Œæ•°æ®åº“æ‰¿å—ç€å·¨å¤§å‹åŠ›ï¼Œè¿™å°†å¯¼è‡´è¯·æ±‚çš„å“åº”æ—¶é—´è¢«ä¸æ–­æ‹‰é•¿ï¼Œå¤§é‡æœåŠ¡è¶…æ—¶ï¼Œæœ€ç»ˆæœåŠ¡å™¨çš„å¯ç”¨è¿æ¥æ•°è¢«è€—å°½ï¼Œä¸å†æ¥æ”¶æ–°çš„è¯·æ±‚ã€‚</p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/%E5%A4%9A%E7%94%A8%E6%88%B7.png" width="70%"><p>ä¸€ä¸ªå¯è¡Œçš„è§£å†³åŠæ³•æ˜¯åšæ°´å¹³æ‰©å±•ï¼Œå¢åŠ å¤šå°æœåŠ¡å™¨ï¼Œè¿™æ ·ä¸åŒç”¨æˆ·çš„è¯·æ±‚å¯ä»¥ç”±ä¸åŒçš„æœåŠ¡å™¨å—ç†ï¼Œä»è€Œå¤§å¤§å‡å°äº†æ¯å°æœåŠ¡å™¨çš„å‹åŠ›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å„ä¸ªæœåŠ¡å™¨ä¹‹é—´å¯èƒ½å¹¶ä¸å…±äº«ç”¨æˆ·çš„ Session ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªä¸­é—´å±‚æœåŠ¡å™¨å°†ä¸€ä¸ªç”¨æˆ·çš„ä¸åŒè¯·æ±‚è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ä¸Šã€‚ä¸ä»…å¦‚æ­¤ï¼Œè¯¥ä¸­é—´å±‚æœåŠ¡å™¨è¿˜éœ€è¦ä½¿å¾—å„ä¸ªæœåŠ¡å™¨æ¥æ”¶çš„è¯·æ±‚é‡ä¿æŒå‡è¡¡ï¼Œä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚</p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/%E4%B8%AD%E9%97%B4%E5%B1%82%E6%9C%8D%E5%8A%A1%E5%99%A8.png" width="70%"><p>åŸºäºä¸Šè¿°è€ƒè™‘ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Nginx è¿›è¡Œè½¬å‘å’Œå¤„ç†è¯·æ±‚ã€‚Nginx é¦–å…ˆæ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚ï¼Œç„¶åæ ¹æ®ç”¨æˆ·çš„èº«ä»½ä»¥åŠæœåŠ¡å™¨çš„æ€§èƒ½å°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šï¼Œè¯¥è¿‡ç¨‹å¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œç”¨æˆ·å¹¶ä¸çŸ¥é“å…·ä½“æ˜¯å“ªå°æœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚ã€‚</p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/Nginx.png" width="70%"><h2 id="Nginx-ä¸»è¦åŠŸèƒ½"><a href="#Nginx-ä¸»è¦åŠŸèƒ½" class="headerlink" title="Nginx ä¸»è¦åŠŸèƒ½"></a>Nginx ä¸»è¦åŠŸèƒ½</h2><p>Nginx å¯ä»¥ä½œä¸ºåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œè¿˜å¯ä»¥ä½œä¸º HTTP æœåŠ¡å™¨å®ç° Web æœåŠ¡çš„åŠ¨é™åˆ†ç¦»ã€‚</p><h3 id="æ­£å‘ä»£ç†"><a href="#æ­£å‘ä»£ç†" class="headerlink" title="æ­£å‘ä»£ç†"></a>æ­£å‘ä»£ç†</h3><p>æ­£å‘ä»£ç†ç±»ä¼¼äºä¸€ä¸ªè·³æ¿æœºï¼Œä»£ç†å®¢æˆ·ç«¯è®¿é—®å¤–éƒ¨èµ„æºã€‚æ¯”å¦‚å›½å†…ç”¨æˆ·ç›´æ¥è®¿é—® Google æ—¶è¯·æ±‚ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯æŒ‚ä¸Š VPN åå°±å¯ä»¥æ­£å¸¸è®¿é—®äº†ã€‚è¿™é‡Œçš„ VPN å®é™…ä¸Šå°±æ˜¯æ­£å‘ä»£ç†æœåŠ¡å™¨ï¼Œç”¨æˆ·çš„è¯·æ±‚é¦–å…ˆå‘é€ç»™ä»£ç†æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨èƒ½å¤Ÿè®¿é—® Googleï¼Œä¹‹åä»£ç†æœåŠ¡å™¨æ¥æ”¶åˆ° Google çš„å“åº”å¹¶å°†è¯¥å“åº”è¿”å›ç»™ç”¨æˆ·ã€‚å¯¹äº Google æœåŠ¡å™¨æ¥è¯´ï¼Œå®ƒåªçŸ¥é“ä»£ç†æœåŠ¡å™¨å‘é€äº†å¤šä¸ªè¯·æ±‚ï¼Œè€Œå¹¶ä¸çŸ¥é“è¿™äº›è¯·æ±‚å…·ä½“æ¥è‡ªäºå“ªäº›ç”¨æˆ·ã€‚</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8.png" width="70%"></p><p>æ­£å‘ä»£ç†çš„ç”¨é€”ï¼š</p><ol><li><p>è®¿é—®åŸå…ˆæ— æ³•è®¿é—®çš„èµ„æºã€‚</p></li><li><p>ç”¨åšç¼“å­˜ï¼ŒåŠ å¿«èµ„æºçš„è®¿é—®ã€‚</p></li><li><p>å¯¹å®¢æˆ·ç«¯åšé‰´æƒã€‚</p></li><li><p>å®ç°åŒ¿åè®¿é—®ï¼Œå¯¹åç«¯æœåŠ¡å™¨éšè—çœŸå®çš„ IPã€‚</p></li></ol><h3 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h3><p>åå‘ä»£ç†æŒ‡çš„æ˜¯æŒ‡åˆ©ç”¨ä»£ç†æœåŠ¡å™¨æ¥å—ç”¨æˆ·çš„è¯·æ±‚ï¼Œä»£ç†æœåŠ¡å™¨å°†è¯·æ±‚è½¬å‘ç»™æŸä¸€ä¸ªå†…ç½‘æœåŠ¡å™¨ï¼Œå¹¶å°†å¾—åˆ°çš„å“åº”è¿”å›ç»™å¯¹åº”çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶æ•´ä¸ªåç«¯æœåŠ¡å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªä»£ç†æœåŠ¡å™¨ã€‚æ¯”å¦‚è®¿é—® Baiduï¼ŒBaidu çš„æœåŠ¡å®é™…ä¸Šæ˜¯éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ¯æ¬¡è®¿é—®çš„éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ www.<span></span>baidu<span></span>.comï¼Œè¿™é‡Œçš„ www.<span></span>baidu.<span></span>com å…¶å®å°±æ˜¯åå‘ä»£ç†æœåŠ¡å™¨ã€‚å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒåªçŸ¥é“è¯·æ±‚éƒ½æ˜¯å‘é€ç»™äº†ä»£ç†æœåŠ¡å™¨ï¼Œè€Œå¹¶ä¸çŸ¥é“å…·ä½“æ˜¯å“ªä¸€ä¸ªçœŸå®æœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚ï¼Œåç»­æ— è®ºåŠ¨æ€æ‰©å®¹å¤šå°‘å°æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ€»æ˜¯è®¿é—® www.<span></span>baidu.<span></span>comã€‚</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8.png" width="70%"></p><p>åå‘ä»£ç†çš„ç”¨é€”ï¼š</p><ol><li><p>éšè—åç«¯æœåŠ¡å™¨é›†ç¾¤çš„ IPï¼Œä¿è¯å†…ç½‘å®‰å…¨ã€‚é€šå¸¸åå‘ä»£ç†æœåŠ¡å™¨çš„ IP ä¼šä½œä¸ºå…¬ç½‘åœ°å€ä¾›ç”¨æˆ·è®¿é—®ï¼Œè€Œä»£ç†æœåŠ¡å™¨å’Œåç«¯æœåŠ¡å™¨ä½¿ç”¨å†…ç½‘è¿›è¡Œé€šä¿¡ã€‚</p></li><li><p>è´Ÿè½½å‡è¡¡ï¼Œåˆ©ç”¨åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥ä¼˜åŒ–å„ä¸ªåç«¯æœåŠ¡å™¨çš„è´Ÿè½½ã€‚</p></li></ol><p><strong>æ­£å‘ä»£ç†å’Œåå‘ä»£ç†å°ç»“</strong></p><ul><li><p>æ­£å‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ï¼Œå®ƒéšè—äº†çœŸå®çš„å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ä¸çŸ¥é“çœŸæ­£çš„å®¢æˆ·ç«¯æ˜¯è°ã€‚</p></li><li><p>åå‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯æœåŠ¡ç«¯ï¼Œå®ƒéšè—äº†çœŸå®çš„æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“å…·ä½“æ˜¯å“ªå°æœåŠ¡å™¨åšå‡ºçš„å›åº”ã€‚</p></li></ul><h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><p>é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚å¤©çŒ«åŒåä¸€å½“å¤©ï¼ŒæŸä¸ªæœåŠ¡çš„ç¬æ—¶è®¿é—®é‡åŠå…¶åºå¤§ï¼Œæ­¤æ—¶å³ä½¿å°†æœåŠ¡å™¨å‡çº§åˆ°ç°æœ‰çš„é¡¶çº§ç‰©ç†é…ç½®ï¼Œä¹Ÿå¯èƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥æ‹“å±•æœåŠ¡å™¨çš„æ•°é‡ï¼Œå°†æ•°æ®æµé‡åˆ†æ‘Šåˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå‡è½»æ¯å°æœåŠ¡å™¨çš„å‹åŠ›ï¼Œè¿™ç§åº”ç”¨å°±ç§°ä¸ºè´Ÿè½½å‡è¡¡ã€‚Nginx æ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥åˆ†ä¸ºå†…ç½®ç­–ç•¥å’Œæ‰©å±•ç­–ç•¥ï¼Œå…¶ä¸­å†…ç½®ç­–ç•¥å°±æ˜¯è½®è¯¢ï¼Œæ‰©å±•ç­–ç•¥éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹æ’ä»¶æ¥å®ç°ã€‚</p><p>å†…ç½®ç­–ç•¥æœ‰ï¼š</p><ol><li><p>è½®è¯¢ï¼šå°†è¯·æ±‚ä¾æ¬¡åˆ†å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœæŸä¸ªæœåŠ¡å™¨å®•æœºï¼ŒNginx å¯è‡ªåŠ¨å°†å…¶å‰”é™¤ã€‚</p></li><li><p>åŠ æƒè½®è¯¢ï¼šä¸ºæ¯å°æœåŠ¡å™¨éƒ½åˆ†é…ä¸€ä¸ªæƒé‡å€¼ï¼Œæƒé‡å€¼è¶Šé«˜çš„æœºå™¨è¢«åˆ†é…è¯·æ±‚é‡ä¹Ÿè¶Šå¤§ï¼ŒåŠ æƒè½®è¯¢å¤šç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚</p></li><li><p>ip_hashï¼šå¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„ IP è¿›è¡Œ Hash è¿ç®—ï¼Œç„¶åæ ¹æ® Hash ç»“æœå°†è¯·æ±‚åˆ†å‘ç»™å¯¹åº”çš„æœåŠ¡å™¨ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿç¡®ä¿åŒä¸€å®¢æˆ·ç«¯çš„ä¸åŒè¯·æ±‚æ€»æ˜¯ç”±ç›¸åŒçš„æœåŠ¡å™¨å¤„ç†ï¼Œä»è€Œè§£å†³äº† Session ä¸å…±äº«çš„é—®é¢˜ã€‚</p></li><li><p>æœ€å°‘è¿æ¥åˆ†é… least_connï¼šå°†è¯·æ±‚è½¬å‘ç»™è¿æ¥æ•°è¾ƒå°‘çš„åç«¯æœåŠ¡å™¨ï¼Œè½®è¯¢æ–¹æ¡ˆæ˜¯å°†è¯·æ±‚å¹³å‡åˆ†é…ç»™å„ä¸ªæœåŠ¡å™¨ï¼Œä½¿å®ƒä»¬çš„è´Ÿè½½å¤§è‡´ç›¸åŒã€‚ç„¶è€Œï¼ŒæŸäº›è¯·æ±‚å¤„ç†èµ·æ¥å¯èƒ½éå¸¸è€—æ—¶ï¼Œè¿™å¯èƒ½å¯¼è‡´å…¶æ‰€åœ¨åç«¯çš„è´Ÿè½½æ˜¾è‘—æé«˜ï¼Œæ­¤æ—¶ä½¿ç”¨ least_conn å°±å¯ä»¥è¾¾åˆ°æ›´å¥½çš„è´Ÿè½½å‡è¡¡æ•ˆæœã€‚</p></li></ol><p>æ‰©å±•ç­–ç•¥æœ‰ï¼š</p><ol><li><p>fairï¼šæŒ‰ç…§æœåŠ¡å™¨ç«¯çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚</p></li><li><p>url_hashï¼šå¯¹è®¿é—®çš„ URL è¿›è¡Œ Hash è¿ç®—ï¼Œç„¶åæ ¹æ® Hash çš„ç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œè¿™æ ·åŒä¸€ä¸ª URL æ€»ä¼šå®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ã€‚æ­¤ç§æ–¹å¼é€‚ç”¨äºåç«¯æœåŠ¡å™¨ä½œä¸ºç¼“å­˜æ—¶çš„æƒ…å†µï¼Œå› ä¸ºç¼“å­˜çš„å‘½ä¸­ç‡æ¯”è¾ƒé«˜ã€‚ </p></li></ol><h3 id="åŠ¨é™åˆ†ç¦»"><a href="#åŠ¨é™åˆ†ç¦»" class="headerlink" title="åŠ¨é™åˆ†ç¦»"></a>åŠ¨é™åˆ†ç¦»</h3><p>ç”±äº Nginx å¯ä»¥æ ¹æ®é…ç½®å¯¹ä¸åŒçš„è¯·æ±‚åšä¸åŒçš„è½¬å‘ï¼Œå› æ­¤å¯ç”¨æ¥å®ç°åŠ¨é™åˆ†ç¦»ã€‚åŠ¨é™åˆ†ç¦»æŒ‡çš„æ˜¯å°†åŠ¨æ€è¯·æ±‚ï¼ˆéœ€è¦åå°å¤„ç†çš„è¯·æ±‚ï¼‰å’Œé™æ€è¯·æ±‚ï¼ˆä¸éœ€è¦åå°å¤„ç†çš„è¯·æ±‚ï¼Œå¦‚è¯·æ±‚ cssã€htmlã€jsã€å›¾ç‰‡ç­‰é™æ€èµ„æºï¼‰åˆ†ç¦»å¼€ï¼Œç„¶åå°†é™æ€è¯·æ±‚å¯¹åº”çš„é™æ€èµ„æºç›´æ¥æ”¾åœ¨ Nginx ä¸Šåšç¼“å­˜ï¼Œæˆ–è€…æ”¾åœ¨æŒ‡å®šçš„æœåŠ¡å™¨ä¸Šï¼Œè€ŒåŠ¨æ€è¯·æ±‚ä»ç”±ç›¸åº”çš„åç«¯æœåŠ¡å™¨å¤„ç†ï¼Œè¿™æ ·å¯ä»¥ä½¿æ•´ä¸ªæœåŠ¡å™¨ç³»ç»Ÿçš„æ€§èƒ½ã€æ•ˆç‡æ›´é«˜ã€‚</p><h2 id="Nginx-é…ç½®"><a href="#Nginx-é…ç½®" class="headerlink" title="Nginx é…ç½®"></a>Nginx é…ç½®</h2><p><strong>åŸºç¡€é…ç½®æ–‡ä»¶</strong></p><p>nginx.conf æ˜¯ Nginx çš„åŸºç¡€é…ç½®æ–‡ä»¶ï¼Œå…¶é»˜è®¤å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/nginx.conf.png" width="70%"></p><p>è¯¥é…ç½®æ–‡ä»¶æ€»å…±åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šå…¨å±€å—ã€events å—ã€http å—ã€‚</p><ol><li><p>å…¨å±€å—ï¼šä»é…ç½®æ–‡ä»¶å¼€å§‹åˆ° events å—ä¹‹é—´çš„å†…å®¹ä¸ºå…¨å±€å—ï¼Œå…¨å±€å—ä¸­è®¾ç½®äº†ä¸€äº›å½±å“ Nginx æœåŠ¡å™¨æ•´ä½“è¿è¡Œæ€§èƒ½çš„é…ç½®æŒ‡ä»¤ï¼ŒåŒ…æ‹¬é…ç½®è¿è¡Œ Nginx çš„ç”¨æˆ·ï¼ˆç»„ï¼‰ï¼Œå…è®¸ç”Ÿæˆçš„ worker process æ•°ï¼Œè¿›ç¨‹ PID å­˜æ”¾è·¯å¾„ã€æ—¥å¿—çš„çº§åˆ«å’Œå­˜æ”¾è·¯å¾„ç­‰ã€‚ä¾‹å¦‚ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ï¼Œ<code>worker_processes 1;</code> è¡¨ç¤º Nginx å¹¶å‘å¤„ç†çš„è¿›ç¨‹æ•°ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œå¯æ”¯æŒçš„å¹¶å‘å¤„ç†é‡ä¹Ÿè¶Šå¤šã€‚</p></li><li><p>events å—ï¼š<code>events{}</code> æ‹¬å·æ‰€åŒ…å«çš„å†…å®¹ä¸º events å—ï¼Œevents å—æ¶‰åŠçš„æŒ‡ä»¤ä¸»è¦å½±å“ Nginx æœåŠ¡å™¨å’Œç”¨æˆ·ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œå¦‚ <code>worker_connections  1024;</code> è¡¨ç¤ºæ¯ä¸ª worker process æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ä¸º 1024ã€‚events å—ä¸­çš„é…ç½®å¯¹ Nginx çš„æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œå®é™…ä¸­åº”çµæ´»é…ç½®ã€‚</p></li><li><p>http å—ï¼š<code>https{}</code> æ‹¬å·æ‰€åŒ…å«çš„å†…å®¹ä¸º http å—ï¼Œhttp å—ä¸­ä¸»è¦ç”¨æ¥è®¾ç½®åå‘ä»£ç†ã€ç¼“å­˜ã€æ—¥å¿—å®šä¹‰ä»¥åŠç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ã€‚http å—åŒ…å« http å…¨å±€å—å’Œ server å—ã€‚</p></li></ol><ul><li><p>http å…¨å±€å—ï¼šhttp å…¨å±€å—é…ç½®çš„æŒ‡ä»¤åŒ…æ‹¬æ–‡ä»¶å¼•å…¥ã€mime-type å®šä¹‰ã€æ—¥å¿—è‡ªå®šä¹‰ã€è¿æ¥è¶…æ—¶æ—¶é—´ã€å•è¿æ¥è¯·æ±‚æ•°ä¸Šé™ç­‰ã€‚</p></li><li><p>server å—ï¼šserver å—ä¸è™šæ‹Ÿä¸»æœºè”ç³»ç´§å¯†ï¼Œæ¯ä¸ª http å—å¯ä»¥åŒ…å«å¤šä¸ª server å—ï¼Œè€Œæ¯ä¸ªserver å—å°±ç›¸å½“äºä¸€ä¸ªè™šæ‹Ÿä¸»æœºã€‚server å—ä¹Ÿåˆ†ä¸ºå…¨å±€ server å—å’Œ location å—ã€‚</p><ul><li><p>å…¨å±€ server å—ï¼šä¸»è¦é…ç½®è™šæ‹Ÿä¸»æœºçš„åç§°æˆ– IP åœ°å€ã€ç›‘å¬çš„ç«¯å£å·ç­‰ã€‚</p></li><li><p>location å—ï¼šä¸»è¦é…ç½®è¯·æ±‚çš„è·¯ç”±ï¼Œå„ç§é¡µé¢çš„å¤„ç†æƒ…å†µä»¥åŠæ•°æ®çš„ç¼“å­˜ç­‰ã€‚å½“è¯·æ±‚çš„è·¯å¾„æ»¡è¶³ location å—ä¸­è®¾å®šçš„è·¯å¾„åŒ¹é…è§„åˆ™æ—¶ï¼Œç¨‹åºå°±ä¼šè¿›å…¥ location å—æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œå¦‚è¯·æ±‚è·³è½¬ç­‰ã€‚ä¸‹å›¾ä¸­ï¼ŒNginx ä¼šç›‘å¬ä¸»æœº <code>localhost</code> çš„ <code>80</code> ç«¯å£ï¼ˆç”± server_name å’Œ listen é…ç½®ï¼‰ï¼Œå½“è®¿é—® <code>localhost:80</code> æ—¶ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ° <code>127.0.0.1:8080</code>ã€‚</p></li></ul></li></ul><p><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/Server.png" width="50%"></p><p><strong>location åŒ¹é…è§„åˆ™</strong></p><p>location å—ä¸­ <code>location</code> å…³é”®è¯åè·Ÿçš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼Œå…¶åŸºæœ¬è¯­æ³•ä¸º <code>location [=|~|~*|^~] uri {â€¦â€¦}</code>ã€‚å¦‚æœè¯·æ±‚çš„ URI åŒ¹é…è¯¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆå°±è¿›å…¥ location å—ã€‚</p><p><code>æ— ä»»ä½•ä¿®é¥°ç¬¦</code>è¡¨ç¤ºå‰ç¼€åŒ¹é…ï¼Œå½“è¯·æ±‚çš„ URI çš„å¼€å¤´ä¸ location åçš„ URI åŒ¹é…æ—¶ï¼Œåˆ™è¿›å…¥ location å—ï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">server <span class="token punctuation">{</span>ã€€ã€€server_name baidu.com<span class="token punctuation">;</span>ã€€ã€€location /hello <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€â€¦â€¦ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hello?a=1</span><span class="token comment" spellcheck="true">#http://baidu.com/hello/</span><span class="token comment" spellcheck="true">#http://baidu.com/helloo è™½ç„¶ /helloo ä¸ /hello åŒ¹é…, ä½†æœ€ç»ˆè®¿é—®çš„ä»ç„¶æ˜¯ http://çœŸå®æœåŠ¡å™¨IP:ç«¯å£/helloo</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚ä¸åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hell</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>=</code> è¡¨ç¤ºç²¾ç¡®åŒ¹é…ï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">server <span class="token punctuation">{</span>    server_name baidu.comã€€ã€€location <span class="token operator">=</span> /hello <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€â€¦â€¦ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hello?a=1</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡ä¸åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello/</span><span class="token comment" spellcheck="true">#http://baidu.com/helloo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>~</code> è¡¨ç¤ºåŒºåˆ†å¤§å°å†™çš„å‰ç¼€åŒ¹é…:</p><pre class="line-numbers language-bash"><code class="language-bash">server <span class="token punctuation">{</span>    server_name baidu.com<span class="token punctuation">;</span>ã€€ã€€location ~ /hello <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€â€¦â€¦ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hello?a=1</span><span class="token comment" spellcheck="true">#http://baidu.com/hello/</span><span class="token comment" spellcheck="true">#http://baidu.com/helloo</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡ä¸åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/Hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hellO</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">server <span class="token punctuation">{</span>    server_name baidu.com<span class="token punctuation">;</span>ã€€ã€€location ~ ^/hello$ <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€â€¦â€¦ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hello?a=1</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡ä¸åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello/</span><span class="token comment" spellcheck="true">#http://baidu.com/helloo</span><span class="token comment" spellcheck="true">#http://baidu.com/Hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hellO</span><span class="token comment" spellcheck="true">#$è¡¨ç¤ºåŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾ä½ç½®, å°±æ˜¯è¯´å¿…é¡»åœ¨å­—ç¬¦ä¸²çš„ç»“å°¾åŒ¹é…åˆ° $ å‰é¢çš„éƒ¨åˆ†æ‰è¡Œ, å› æ­¤ /hello èƒ½åŒ¹é…æˆåŠŸè€Œ /helloo å°±ä¸è¡Œ, ä¸ä¹‹ç±»ä¼¼, ^ åŒ¹é…å­—ç¬¦ä¸²å¼€å§‹çš„ä½ç½®</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>~*</code> è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™çš„å‰ç¼€åŒ¹é…:</p><pre class="line-numbers language-bash"><code class="language-bash">server <span class="token punctuation">{</span>    server_name baidu.com<span class="token punctuation">;</span>    location ~* /hello <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€â€¦â€¦ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#å¦‚ä¸‹è¯·æ±‚å‡åŒ¹é…ï¼š</span><span class="token comment" spellcheck="true">#http://baidu.com/hello</span><span class="token comment" spellcheck="true">#http://baidu.com/hello?a=1</span><span class="token comment" spellcheck="true">#http://baidu.com/helloo</span><span class="token comment" spellcheck="true">#http://baidu.com/HELLO </span><span class="token comment" spellcheck="true">#http://baidu.com/hello/</span><span class="token comment" spellcheck="true">#æ‰€ä»¥æ— ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ä¸ä¸åŒºåˆ†å¤§å°çš„å†™å‰ç¼€åŒ¹é…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>^~</code> çš„åŒ¹é…è§„åˆ™ä¸æ— ä¿®é¥°ç¬¦çš„æƒ…å†µç›¸ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼ŒåŒ¹é…æˆåŠŸä¹‹åï¼Œä¼šåœæ­¢æœç´¢åé¢çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚</p><p><strong>ä»¥ä¸ŠåŒ¹é…è§„åˆ™å‡æ˜¯åœ¨ Linux æ“ä½œç³»ç»Ÿä¸‹æµ‹è¯•å¾—å‡ºï¼Œå¯èƒ½ Windows å’Œ Mac OS ç³»ç»Ÿä¸‹è¯·æ±‚çš„ URL ä»ç„¶æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ã€‚å¦å¤–ï¼Œå¦‚æœ‰é”™è¯¯æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼</strong></p><p>Nginx åšè¯·æ±‚è½¬å‘æ—¶ï¼Œå¦‚æœè¯·æ±‚çš„ URI ä¸å¤šä¸ª location å—ä¸­å®šä¹‰çš„ URI åŒ¹é…ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•åšè·³è½¬å‘¢ï¼ŸNginx ä¸­è§„å®šäº†åŒ¹é…çš„ä¼˜å…ˆçº§ï¼š</p><ol><li><p>å¸¦æœ‰ â€œ=â€ çš„ç²¾ç¡®åŒ¹é…ã€‚</p></li><li><p>æ— ä¿®é¥°ç¬¦çš„ç²¾ç¡®åŒ¹é…ã€‚</p></li><li><p>å¸¦æœ‰ â€œ^~â€ ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ã€‚</p></li><li><p>æŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºè¿›è¡ŒåŒ¹é…ã€‚</p></li><li><p>å¸¦æœ‰ â€œ~â€œ æˆ–  â€œ~*â€ ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ã€‚</p></li><li><p>æ— ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ã€‚</p></li><li><p>é€šç”¨åŒ¹é… â€œ/â€œã€‚</p></li></ol><h2 id="Nginx-å¸¸ç”¨å‘½ä»¤"><a href="#Nginx-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="Nginx å¸¸ç”¨å‘½ä»¤"></a>Nginx å¸¸ç”¨å‘½ä»¤</h2><p>Nginx çš„å¯åŠ¨ã€åœæ­¢ã€æ›´æ–°é…ç½®æ–‡ä»¶åçš„é‡æ–°åŠ è½½å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/nginx/sbin/  <span class="token comment" spellcheck="true">#Linux ä¸‹ Nginx çš„é»˜è®¤å®‰è£…ç›®å½•</span>./nginx  <span class="token comment" spellcheck="true">#å¯åŠ¨</span>./nginx -s stop  <span class="token comment" spellcheck="true">#åœæ­¢</span>./nginx -s quit  <span class="token comment" spellcheck="true">#å®‰å…¨é€€å‡º</span>./nginx -s reload  <span class="token comment" spellcheck="true">#é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶, Nginx å¯åŠ¨åå¦‚æœä¿®æ”¹äº†é…ç½®æ–‡ä»¶, å¯æ‰§è¡Œè¯¥å‘½ä»¤é‡æ–°åŠ è½½</span><span class="token function">ps</span> aux<span class="token operator">|</span><span class="token function">grep</span> nginx  <span class="token comment" spellcheck="true">#æŸ¥çœ‹ Nginx è¿›ç¨‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Nginx-å®è·µ"><a href="#Nginx-å®è·µ" class="headerlink" title="Nginx å®è·µ"></a>Nginx å®è·µ</h2><p><strong>è®¾è®¡æ€è·¯</strong></p><p>é¦–å…ˆåœ¨ Windows ä¸»æœºä¸­å®‰è£… Nginxï¼Œç„¶åä½¿ç”¨ VirtualBox æˆ– VMware å¯åŠ¨ä¸¤å°è™šæ‹Ÿæœºï¼Œå¹¶å°†åç«¯æœåŠ¡éƒ¨ç½²åœ¨è¿™ä¸¤å°è™šæ‹Ÿæœºä¸­ã€‚æ­¤æ—¶ï¼Œéƒ¨ç½² Nginx çš„ Windows ä¸»æœºè´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œè€Œä¸¤å° Linux è™šæ‹Ÿæœºåˆ™å……å½“åç«¯æœåŠ¡å™¨ï¼Œå½“æœ‰è¯·æ±‚åˆ°è¾¾æ—¶ï¼ŒNginx æœåŠ¡å™¨æ ¹æ®é…ç½®å°†è¯¥è¯·æ±‚è·¯ç”±åˆ°çœŸå®çš„æœåŠ¡å™¨ï¼ˆè™šæ‹Ÿæœºï¼‰ä¸­ã€‚</p><p><strong>åç«¯æœåŠ¡</strong></p><p>å†™ä¸€ä¸ªç®€å•çš„ â€œHello Worldâ€ é¡¹ç›®ï¼š </p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token annotation punctuation">@RequestMapping</span><span class="token annotation punctuation">@Log</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"I'm fine, thank you."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†è¯¥é¡¹ç›®æ‰“æˆ jar åŒ…ï¼Œåˆ†åˆ«éƒ¨ç½²åœ¨ä¸¤å°è™šæ‹Ÿæœºä¸­ã€‚æ­£å¸¸æƒ…å†µä¸‹è¯¥æœåŠ¡ä¼šè¿”å› â€œHello, world!â€ å­—ç¬¦ä¸²ï¼Œå¹¶æ‰“å°æ—¥å¿— â€œIâ€™m fine, thank you.â€ï¼Œä¸ºäº†æ›´å¥½åœ°åŒºåˆ†è¯·æ±‚ç”±å“ªå°è™šæ‹Ÿæœºå¤„ç†ï¼Œæˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªæœåŠ¡ä¸­æ‰“å°çš„æ—¥å¿—ä¿®æ”¹ä¸º â€œAnd you?â€ã€‚</p><p><strong>Nginx é…ç½®</strong></p><p>æ¥ç€æ‰“å¼€ Nginx çš„é…ç½®æ–‡ä»¶ nginx.confï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">upstream nginxTest <span class="token punctuation">{</span>    server 192.168.3.118:8080 weight<span class="token operator">=</span>1<span class="token punctuation">;</span>    server 192.168.3.124:8080 weight<span class="token operator">=</span>1<span class="token punctuation">;</span><span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen       80<span class="token punctuation">;</span>    server_name  localhost<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">#charset koi8-r;</span>    <span class="token comment" spellcheck="true">#access_log  logs/host.access.log  main;</span>    location / <span class="token punctuation">{</span>        root   html<span class="token punctuation">;</span>        index  index.html index.htm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    location /hello <span class="token punctuation">{</span>        proxy_pass http://nginxTest<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">#è·¯ç”±åˆ° http://192.128.3.xxx:8080/hello</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>upstream å—ä¸­å®šä¹‰çš„æ˜¯è´Ÿè½½å‡è¡¡æœåŠ¡å™¨çš„åˆ—è¡¨ï¼Œweight è¡¨ç¤ºæ¯ä¸ª server çš„æƒé‡ã€‚</p><blockquote><p>å°çŸ¥è¯†ï¼šä¸Šè¿°é…ç½®æ–‡ä»¶çš„ 15 å’Œ 16 è¡Œè¡¨æ˜ï¼Œå½“è®¿é—® localhost:80 æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå…ˆè®¿é—® html/index.htmlï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™ç»§ç»­è®¿é—® html/index.htmã€‚</p></blockquote><p><strong>æµ‹è¯•</strong></p><p>åœ¨ Windows ä¸»æœºçš„æµè§ˆå™¨ä¸­è®¿é—® localhost:80/helloï¼Œå¾—åˆ°å“åº” â€œHello, world!â€ï¼Œå¤šæ¬¡è®¿é—®åå¯ä»¥å‘ç°ï¼Œä¸¤å° Linux è™šæ‹Ÿæœºå‡æ‰“å°å‡ºäº†ç›¸åº”çš„æ—¥å¿—ï¼š</p><p>ä¸»æœº 1ï¼š<br><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/Centos.png" width="70%"></p><p>ä¸»æœº 2ï¼š<br><img src="http://r9eatfbfc.hb-bkt.clouddn.com/Nginx%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/Ubuntu_result.png" width="70%"></p><p>è¿™è¯´æ˜è¯·æ±‚ä¼šè¢«éšæœºåˆ†é…ç»™ä¸¤å°ä¸»æœºï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸ºå®ƒä»¬è®¾ç½®äº†ç›¸åŒçš„æƒé‡ã€‚</p><p><strong>æ³¨æ„äº‹é¡¹</strong></p><p>ä¸Šè¿°æ“ä½œä¸­ï¼Œéœ€è¦ç¡®ä¿ Windows ä¸»æœºä¸ä¸¤å°è™šæ‹Ÿæœºå¯ä»¥ç›¸äº’ Ping é€šã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€å°ä¸»æœºï¼ˆWindows æˆ– Linuxï¼‰æ¥å®Œæˆæµ‹è¯•ï¼Œåªéœ€è¦åœ¨ä¸»æœºä¸Šå¯åŠ¨å¤šä¸ªåç«¯æœåŠ¡å¹¶åˆ†åˆ«è®¾ç½®ä¸åŒçš„æœåŠ¡ç«¯å£ï¼Œä¹‹ååœ¨ nginx.conf ä¸­é…ç½®ç›¸å…³çš„è·¯ç”±è§„åˆ™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatis å®ç°åˆ†é¡µæŸ¥è¯¢çš„ä¸‰ç§æ–¹å¼</title>
      <link href="/2022/0318336.html"/>
      <url>/2022/0318336.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆ†é¡µæŸ¥è¯¢æ˜¯è®¸å¤šç½‘ç«™éƒ½å…·å¤‡çš„ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ï¼Œå…¶ä½œç”¨æ˜¯å°†æŸ¥è¯¢åˆ°çš„ç»“æœé›†åšåˆ†é¡µå±•ç¤ºï¼Œä¾‹å¦‚æ¯é¡µæ˜¾ç¤º 100 æ¡æ•°æ®ã€‚å½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œåˆ†é¡µæŸ¥è¯¢å¯ä»¥å‡è½»æœåŠ¡ç«¯çš„æŸ¥è¯¢å‹åŠ›ä»¥åŠå‰ç«¯çš„æ¸²æŸ“å‹åŠ›ã€‚MyBatis æä¾›äº†ä¸‰ç§åˆ†é¡µæŸ¥è¯¢çš„æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¬ä¾æ¬¡ä»‹ç»å…¶å®ç°è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆåˆ›å»ºå®ä½“ç±» Userï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String address<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååˆ›å»º user è¡¨ï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>user_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€å‘ user è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/Page/user%E8%A1%A8%E6%95%B0%E6%8D%AE.jpg" alt></p><h2 id="Limit-åˆ†é¡µ"><a href="#Limit-åˆ†é¡µ" class="headerlink" title="Limit åˆ†é¡µ"></a>Limit åˆ†é¡µ</h2><p>Limit æ˜¯ MySQL æä¾›çš„åˆ†é¡µæŸ¥è¯¢åŠŸèƒ½ï¼Œå…¶è¯­æ³•ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">limit</span> ${<span class="token keyword">offset</span>}<span class="token punctuation">,</span> ${<span class="token keyword">rows</span>}<span class="token comment" spellcheck="true"># æˆ–</span><span class="token keyword">limit</span> ${<span class="token keyword">rows</span>} <span class="token keyword">offset</span> ${<span class="token keyword">offset</span>}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å‚æ•° offset å’Œ rows åˆ†åˆ«æŒ‡å®šæ£€ç´¢çš„åç§»é‡å’Œè®°å½•æ•°ï¼Œä¾‹å¦‚ <code>limit 1, 5</code> è¡¨ç¤ºæŸ¥è¯¢ä»ç¬¬äºŒè¡Œåˆ°ç¬¬å…­è¡Œçš„ 5 æ¡è®°å½•ã€‚</p><p>åˆ›å»º Page ç±»ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Page</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Integer RANGE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Integer DEFAULT_PAGE_INDEX <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Integer DEFAULT_PAGE_SIZE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ€»çš„è®°å½•æ•°</span>    <span class="token keyword">private</span> Integer count<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰é¡µç , é»˜è®¤ä¸º 1</span>    <span class="token keyword">private</span> Integer pageIndex <span class="token operator">=</span> DEFAULT_PAGE_INDEX<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ¯é¡µæ˜¾ç¤ºçš„è®°å½•æ•°, é»˜è®¤ä¸º 5</span>    <span class="token keyword">private</span> Integer pageSize <span class="token operator">=</span> DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ€»çš„é¡µæ•°</span>    <span class="token keyword">private</span> Integer total<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ•°æ®å†…å®¹</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>T<span class="token operator">></span> data<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ ¹æ®é¡µç è®¡ç®—åç§»é‡</span>    <span class="token keyword">public</span> Integer <span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>pageIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è®¡ç®—æ€»å…±çš„é¡µæ•°</span>    <span class="token keyword">public</span> Integer <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> total <span class="token operator">=</span> count <span class="token operator">/</span> pageSize<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">%</span> pageSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            total<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> total<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å‰ç«¯å±•ç¤ºçš„é¡µç èŒƒå›´</span>    <span class="token keyword">public</span> Integer <span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> from <span class="token operator">=</span> pageIndex <span class="token operator">-</span> RANGE<span class="token punctuation">;</span>        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Integer <span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> to <span class="token operator">=</span> pageIndex <span class="token operator">+</span> RANGE<span class="token punctuation">;</span>        <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Mapper æ¥å£ï¼š</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">findUserPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"condition"</span><span class="token punctuation">)</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> condition<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span> Integer start<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"pageSize"</span><span class="token punctuation">)</span> Integer pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserPage<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>condition.max_age !<span class="token punctuation">=</span> null and condition.max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token cdata">&lt;![CDATA[age &lt;= #{condition.max_age}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span>    limit #{start}, #{pageSize}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserCount<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    count(1)    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>condition.max_age !<span class="token punctuation">=</span> null and condition.max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token cdata">&lt;![CDATA[age &lt;= #{condition.max_age}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨ Limit å®ç°åˆ†é¡µæŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–æ·»åŠ ä¸€ä¸ªè¿”å›æ€»è®°å½•æ•°çš„ SQLï¼Œä»¥ä¾¿è®¡ç®—æ€»çš„é¡µç æ•°ã€‚</p><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Page<span class="token operator">&lt;</span>User<span class="token operator">></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    page<span class="token punctuation">.</span><span class="token function">setPageIndex</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    page<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUserPage</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    page<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUserCount</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"count"</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">"dEFAULT_PAGE_INDEX"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"dEFAULT_PAGE_SIZE"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"ShanXi"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"ç‹äº”"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"Hebei"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653235200000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653235200000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"æœ±å…­"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"Henan"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653321600000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653321600000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"å­™ä¸ƒ"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"from"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"pageIndex"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"pageSize"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"rANGE"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"start"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"to"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"total"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="RowBounds-åˆ†é¡µ"><a href="#RowBounds-åˆ†é¡µ" class="headerlink" title="RowBounds åˆ†é¡µ"></a>RowBounds åˆ†é¡µ</h2><p>RowBounds æ˜¯ MyBatis æä¾›çš„ä¸€ä¸ªåˆ†é¡µç±»ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬çœç•¥ limit å­å¥çš„ä¹¦å†™ï¼Œä½¿æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸šåŠ¡å±‚çš„åˆ†é¡µé€»è¾‘å³å¯ã€‚</p><p>Mapper æ¥å£ï¼š</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">findUserByRowBounds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"condition"</span><span class="token punctuation">)</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> condition<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"RowBounds"</span><span class="token punctuation">)</span> RowBounds rowBounds<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserByRowBounds<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>condition.max_age !<span class="token punctuation">=</span> null and condition.max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token cdata">&lt;![CDATA[age &lt;= #{condition.max_age}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    RowBounds rowBounds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RowBounds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUserByRowBounds</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> rowBounds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RowRounds ç±»çš„æ„é€ æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º offset å’Œ limitï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">RowBounds</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>limit <span class="token operator">=</span> limit<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>offset è¡¨ç¤ºæŸ¥è¯¢çš„åç§»é‡ï¼Œlimit è¡¨ç¤ºæŸ¥è¯¢çš„è®°å½•æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸ Limit æŸ¥è¯¢ä¸­çš„ä¸¤ä¸ªå‚æ•°çš„å«ä¹‰ç›¸åŒã€‚</p><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">Page<span class="token punctuation">{</span>count<span class="token operator">=</span>false, pageNum<span class="token operator">=</span>2, pageSize<span class="token operator">=</span>5, startRow<span class="token operator">=</span>1, endRow<span class="token operator">=</span>6, total<span class="token operator">=</span>-1, pages<span class="token operator">=</span>1, reasonable<span class="token operator">=</span>false, pageSizeZero<span class="token operator">=</span>false<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"Shanghai"</span>,<span class="token string">"age"</span>:27,<span class="token string">"createTime"</span>:1653148800000,<span class="token string">"id"</span>:2,<span class="token string">"updateTime"</span>:1653148800000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"å¼ ä¸‰"</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"Beijing"</span>,<span class="token string">"age"</span>:23,<span class="token string">"createTime"</span>:1653148800000,<span class="token string">"id"</span>:3,<span class="token string">"updateTime"</span>:1653148800000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"æå››"</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"ShanXi"</span>,<span class="token string">"age"</span>:21,<span class="token string">"createTime"</span>:1653148800000,<span class="token string">"id"</span>:4,<span class="token string">"updateTime"</span>:1653148800000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"ç‹äº”"</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"Hebei"</span>,<span class="token string">"age"</span>:12,<span class="token string">"createTime"</span>:1653235200000,<span class="token string">"id"</span>:5,<span class="token string">"updateTime"</span>:1653235200000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"æœ±å…­"</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"Henan"</span>,<span class="token string">"age"</span>:23,<span class="token string">"createTime"</span>:1653321600000,<span class="token string">"id"</span>:6,<span class="token string">"updateTime"</span>:1653321600000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"å­™ä¸ƒ"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>RowRounds ä¸€èˆ¬ä¸æ¨èä½¿ç”¨</strong>ï¼Œå› ä¸ºå®ƒå±äºé€»è¾‘åˆ†é¡µæŸ¥è¯¢ï¼Œå³ä¸€æ¬¡æ€§ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ‰€æœ‰çš„æ•°æ®å¹¶å°†å…¶å­˜å‚¨åœ¨æœåŠ¡å™¨å†…å­˜ï¼Œç„¶åä»ç»“æœé›†ä¸­æ£€ç´¢å‡ºåˆ†é¡µçš„æ•°æ®ã€‚æ­¤ç§æŸ¥è¯¢æ–¹å¼çš„æ‰§è¡Œæ•ˆç‡è¾ƒä½ï¼Œå†…å­˜å ç”¨ç‡è¾ƒé«˜ã€‚</p><blockquote><p>ç‰©ç†åˆ†é¡µæŒ‡çš„æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæŒ‡å®šåç§»é‡åçš„æŒ‡å®šæ¡æ•°æ®ã€‚</p></blockquote><h2 id="åˆ†é¡µæ’ä»¶-PageHelper"><a href="#åˆ†é¡µæ’ä»¶-PageHelper" class="headerlink" title="åˆ†é¡µæ’ä»¶ PageHelper"></a>åˆ†é¡µæ’ä»¶ PageHelper</h2><p>PageHelper æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„åˆ†é¡µæ’ä»¶ï¼Œå…¶å®ç°åŸç†æ˜¯é€šè¿‡æ‹¦æˆªå™¨å°† limit ä¿¡æ¯æ‹¼æ¥åˆ° SQL è¯­å¥ä¸­ï¼Œä»è€Œå®ç°åˆ†é¡µçš„åŠŸèƒ½ã€‚æ­¤å¤–ï¼ŒPageHelper ä¹Ÿå…å»äº† count è¯­å¥ï¼ˆæŸ¥è¯¢æ€»è®°å½•æ•°ï¼‰çš„ä¹¦å†™ã€‚</p><p>pom.xml æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.1.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é…ç½® MyBatis çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.github.pagehelper.PageInterceptor<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Mapper æ¥å£ï¼š</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">findUserByPageHelper</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"condition"</span><span class="token punctuation">)</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserByPageHelper<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>condition.max_age !<span class="token punctuation">=</span> null and condition.max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token cdata">&lt;![CDATA[age &lt;= #{condition.max_age}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    PageHelper<span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUserByPageHelper</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PageHelper çš„ startPage æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º pageNum å’Œ pageSizeï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>E<span class="token operator">></span> Page<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token function">startPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> DEFAULT_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>pageNum è¡¨ç¤ºé¡µç ï¼ŒpageSize è¡¨ç¤ºæ¯é¡µçš„è®°å½•æ•°ã€‚</p><blockquote><p>PageHelper ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ count è¯­å¥ã€‚</p></blockquote><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-bash"><code class="language-bash">Page<span class="token punctuation">{</span>count<span class="token operator">=</span>true, pageNum<span class="token operator">=</span>2, pageSize<span class="token operator">=</span>5, startRow<span class="token operator">=</span>5, endRow<span class="token operator">=</span>10, total<span class="token operator">=</span>7, pages<span class="token operator">=</span>2, reasonable<span class="token operator">=</span>false, pageSizeZero<span class="token operator">=</span>false<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"Henan"</span>,<span class="token string">"age"</span>:23,<span class="token string">"createTime"</span>:1653321600000,<span class="token string">"id"</span>:6,<span class="token string">"updateTime"</span>:1653321600000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"å­™ä¸ƒ"</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span><span class="token string">"address"</span><span class="token keyword">:</span><span class="token string">"Jiangsu"</span>,<span class="token string">"age"</span>:32,<span class="token string">"createTime"</span>:1652976000000,<span class="token string">"id"</span>:7,<span class="token string">"updateTime"</span>:1653667200000,<span class="token string">"userName"</span><span class="token keyword">:</span><span class="token string">"å‘¨å…«"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatis åŠ¨æ€ SQL</title>
      <link href="/2022/0346848.html"/>
      <url>/2022/0346848.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åŠ¨æ€ SQL æ˜¯ MyBatis çš„å¼ºå¤§ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¼ å…¥çš„å±æ€§å€¼è‡ªåŠ¨æ‹¼æ¥ SQL è¯­å¥ï¼ŒåŒæ—¶è¿˜å¯ä»¥ä¿®æ­£ SQL è¯­æ³•ï¼Œä¾‹å¦‚æ·»åŠ å¿…è¦çš„ç©ºæ ¼æˆ–åˆ é™¤å¤šä½™çš„é€—å·ã€‚åŠ¨æ€ SQL åœ¨å®é™…å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œæ˜¯å¿…é¡»è¦æŒæ¡çš„æŠ€èƒ½ä¹‹ä¸€ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€äº›ç®€å•çš„å®ä¾‹æ¥æ¼”ç¤ºåŠ¨æ€ SQL çš„åº”ç”¨ã€‚</p><p>é¦–å…ˆåˆ›å»ºå®ä½“ç±» Userï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String address<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååˆ›å»º user è¡¨ï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>user_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€å‘ user è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/DynamicSQL/user%E8%A1%A8%E6%95%B0%E6%8D%AE.jpg" alt></p><h2 id="if-æ ‡ç­¾"><a href="#if-æ ‡ç­¾" class="headerlink" title="if æ ‡ç­¾"></a>if æ ‡ç­¾</h2><p><code>&lt;if&gt;</code> æ ‡ç­¾ä¸»è¦ç”¨æ¥å®ç°æ¡ä»¶åˆ¤æ–­çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æ ¹æ®ä¸åŒçš„å…¥å‚æ‰§è¡Œä¸åŒçš„æŸ¥è¯¢ç­–ç•¥ã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    where 1=1    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id !<span class="token punctuation">=</span> null and user_id !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        and <span class="token cdata">&lt;![CDATA[id &lt;= #{user_id}]]></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>max_age !<span class="token punctuation">=</span> null and max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        and <span class="token cdata">&lt;![CDATA[age &lt;= #{max_age}]]></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Mapper æ¥å£ï¼š</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">findUser</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>&lt;if&gt;</code> æ ‡ç­¾åˆ¤æ–­ user_id å’Œ max_age æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœéƒ½ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæŸ¥è¯¢ id å°äºç­‰äº user_id ä¸” age å°äºç­‰äº max_age çš„ç”¨æˆ·ä¿¡æ¯ã€‚<code>&lt;![CDATA[xxx]]&gt;</code> çš„ä½œç”¨æ˜¯å°† xxx è½¬åŒ–ä¸ºçº¯æ–‡æœ¬æ ¼å¼ï¼Œå› ä¸º XML æ–‡ä»¶ä¼šå°† <code>&lt;</code> ç­‰å­—ç¬¦è¯†åˆ«ä¸ºè½¬ä¹‰å­—ç¬¦ï¼Œä¸ºäº†èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨è¿™äº›ç¬¦å·ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬åŒ–ä¸ºæ™®é€šå­—ç¬¦ã€‚</p><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>select æ“ä½œæ‰§è¡Œçš„ SQL è¯­å¥ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">and</span> age <span class="token operator">&lt;=</span> <span class="token number">25</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="where-æ ‡ç­¾"><a href="#where-æ ‡ç­¾" class="headerlink" title="where æ ‡ç­¾"></a>where æ ‡ç­¾</h2><p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¡ä»¶æŸ¥è¯¢è¯­å¥ä¸­æ·»åŠ äº† <code>where 1=1</code> è¿™æ ·çš„ä»£ç æ®µï¼Œå…¶ä½œç”¨æ˜¯ç»´æŠ¤ SQL è¯­æ³•çš„æ­£ç¡®æ€§ã€‚å¦‚æœæˆ‘ä»¬å°† <code>1=1</code> åˆ é™¤ï¼Œé‚£ä¹ˆå½“ user_id ä¸ºç©ºä¸” max_age ä¸ä¸ºç©ºæ—¶ï¼ŒSQL è¯­å¥å°±å˜æˆäº† <code>select ... where and age &lt;= 25</code>ï¼Œè¿™å°†å¯¼è‡´ç¨‹åºå‡ºé”™ã€‚æ­¤å¤–ï¼Œå¦‚æœ user_id å’Œ max_age å‡ä¸ºç©ºï¼Œé‚£ä¹ˆ SQL è¯­å¥å°†ä»¥ where ç»“å°¾ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚å¹¸è¿çš„æ˜¯ï¼ŒMyBatis æä¾›çš„ <code>&lt;where&gt;</code> æ ‡ç­¾å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨æ·»åŠ  <code>where 1=1</code> ä¹Ÿèƒ½ç¡®ä¿ SQL çš„æ­£ç¡®æ€§ã€‚</p><p>å°† mapper æ–‡ä»¶ä¿®æ”¹ä¸ºï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id !<span class="token punctuation">=</span> null and user_id !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token cdata">&lt;![CDATA[id &lt;= #{user_id}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>max_age !<span class="token punctuation">=</span> null and max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            and <span class="token cdata">&lt;![CDATA[age &lt;= #{max_age}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæˆ‘ä»¬å°† user_id å’Œ max_age ä¸­çš„æŸä¸€ä¸ªæˆ–ä¸¤ä¸ªè®¾ç½®ä¸ºç©ºï¼Œé‚£ä¹ˆç¨‹åºä»ç„¶èƒ½å¤Ÿæ­£ç¡®æŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œå› ä¸º <code>where</code> å…ƒç´ åªä¼šåœ¨å­å…ƒç´ æœ‰è¿”å›å†…å®¹çš„æƒ…å†µä¸‹æ‰æ’å…¥ <code>where</code> å­å¥ã€‚è‹¥å­å¥çš„å¼€å¤´ä¸º <code>and</code> æˆ– <code>or</code>ï¼Œ<code>where</code> å…ƒç´ ä¹Ÿä¼šå°†å®ƒä»¬å»é™¤ã€‚</p><h2 id="chooseã€whenã€otherwise-æ ‡ç­¾"><a href="#chooseã€whenã€otherwise-æ ‡ç­¾" class="headerlink" title="chooseã€whenã€otherwise æ ‡ç­¾"></a>chooseã€whenã€otherwise æ ‡ç­¾</h2><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æƒ³ä½¿ç”¨æ‰€æœ‰çš„æ¡ä»¶ï¼Œè€Œåªæ˜¯æƒ³ä»å¤šä¸ªæ¡ä»¶ä¸­é€‰æ‹©ä¸€ä¸ªä½¿ç”¨ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒMyBatis æä¾›äº† <code>choose</code> å…ƒç´ ï¼Œå®ƒæœ‰ç‚¹åƒ Java ä¸­çš„ switch è¯­å¥ã€‚</p><p>å°† mapper æ–‡ä»¶ä¿®æ”¹ä¸ºï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>choose</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id !<span class="token punctuation">=</span> null and user_id !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token cdata">&lt;![CDATA[id &lt;= #{user_id}]]></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>max_age !<span class="token punctuation">=</span> null and max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token cdata">&lt;![CDATA[age &lt;= #{max_age}]]></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>otherwise</span><span class="token punctuation">></span></span>                id = 1            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>otherwise</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>choose</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"Beijing"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"æå››"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"ShanXi"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"ç‹äº”"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>select æ“ä½œæ‰§è¡Œçš„ SQL è¯­å¥ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age <span class="token operator">&lt;=</span> <span class="token number">25</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç”±äºæˆ‘ä»¬ä»…ä¸º max_age å˜é‡èµ‹å€¼ï¼Œå› æ­¤åœ¨è¯¥å˜é‡ä¹‹åçš„æ‰€æœ‰ <code>when</code> å­å¥æˆ– <code>otherwise</code> å­å¥éƒ½ä¸ä¼šæ‰§è¡Œã€‚å¦‚æœ <code>&lt;when&gt;</code> æ ‡ç­¾ä¸­çš„æ¡ä»¶å‡ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆ MyBatis ä¼šæ ¹æ® <code>&lt;otherwise&gt;</code> æ ‡ç­¾è®¾ç½®çš„æ¡ä»¶æ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// map.put("max_age", 25);</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="set-æ ‡ç­¾"><a href="#set-æ ‡ç­¾" class="headerlink" title="set æ ‡ç­¾"></a>set æ ‡ç­¾</h2><p><code>&lt;set&gt;</code> æ ‡ç­¾ä¸€èˆ¬åœ¨ update æ“ä½œä¸­ä½¿ç”¨ï¼Œå®ƒä¸ <code>&lt;where&gt;</code> ä¸€æ ·æœ‰æ™ºèƒ½æ£€æµ‹çš„åŠŸèƒ½ï¼Œå½“å­å…ƒç´ æœ‰è¿”å›å†…å®¹æ—¶æ‰ä¼šæ’å…¥ <code>set</code> å­å¥ï¼Œå¹¶ä¸”å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å»é™¤å¤šä½™çš„é€—å·ï¼Œä¸‹é¢æµ‹è¯•ä¸€ä¸ª update æ“ä½œã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    update user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name !<span class="token punctuation">=</span> null and user_name !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            user_name = #{user_name},        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age !<span class="token punctuation">=</span> null and age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            age = #{age}        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">></span></span>    where id = #{user_id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Mapper æ¥å£ï¼š</p><pre class="line-numbers language-java"><code class="language-java">Integer <span class="token function">updateUser</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">,</span> <span class="token string">"ç‹èƒ–å­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ›´æ–°ç»“æœï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/DynamicSQL/user%E8%A1%A8%E6%9B%B4%E6%96%B0.jpg" alt></p><p>update æ“ä½œæ‰§è¡Œçš„ SQL ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> user_name <span class="token operator">=</span> <span class="token string">'ç‹èƒ–å­'</span> <span class="token keyword">where</span> user_id <span class="token operator">=</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯è§ï¼ŒMyBatis å¸®æˆ‘ä»¬æ’å…¥äº† <code>set</code> å…³é”®å­—ï¼Œå¹¶åˆ é™¤äº† <code>where</code> å…³é”®å­—å‰çš„é€—å·ã€‚</p><h2 id="trim-æ ‡ç­¾"><a href="#trim-æ ‡ç­¾" class="headerlink" title="trim æ ‡ç­¾"></a>trim æ ‡ç­¾</h2><p>MyBatis å®˜æ–¹æ–‡æ¡£å¯¹ <code>trim</code> çš„æè¿°ä¸º â€œå¯ä»¥ä½¿ç”¨ <code>trim</code> å…ƒç´ æ¥å®šåˆ¶ <code>where</code> å…ƒç´ çš„åŠŸèƒ½â€ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<code>where</code> å…ƒç´ ä¼šåœ¨å­å…ƒç´ è¿”å›éç©ºå†…å®¹æ—¶æ’å…¥ <code>where</code> å…³é”®å­—ï¼Œè€Œ <code>trim</code> å…ƒç´ ä¸ä»…å¯ä»¥æ’å…¥ <code>where</code> å…³é”®å­—ï¼Œå®ƒè¿˜å…è®¸æˆ‘ä»¬è‡ªå®šä¹‰æ’å…¥çš„å†…å®¹ã€‚æ­¤å¤–ï¼Œ<code>trim</code> å…ƒç´ ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ é™¤å¤šä½™çš„ç¬¦å·ï¼Œä¸”è¿™äº›ç¬¦å·æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ã€‚ä¸‹é¢ç”¨ä¸€ä¸ªç¤ºä¾‹æ¥æ¼”ç¤º <code>trim</code> å…ƒç´ çš„åŠŸèƒ½ã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>insertUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    insert into user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        gmt_create,        gmt_modified,        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name !<span class="token punctuation">=</span> null and user_name !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            user_name,        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age !<span class="token punctuation">=</span> null and age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            age,        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address !<span class="token punctuation">=</span> null and address !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            address        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>values(<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        UTC_TIMESTAMP(),        UTC_TIMESTAMP(),        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name !<span class="token punctuation">=</span> null and user_name !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            #{user_name},        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age !<span class="token punctuation">=</span> null and age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            #{age},        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address !<span class="token punctuation">=</span> null and address !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            #{address}        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Mapper æ¥å£ï¼š</p><pre class="line-numbers language-java"><code class="language-java">Integer <span class="token function">insertUser</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/DynamicSQL/user%E8%A1%A8%E6%96%B0%E5%A2%9E%E6%95%B0%E6%8D%AE.jpg" alt></p><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ prefix å’Œ suffix å±æ€§è®¾ç½® <code>trim</code> å­å¥çš„å‰ç¼€å’Œåç¼€ï¼Œé€šè¿‡ suffixOverrides å±æ€§è®¾ç½®éœ€è¦å»é™¤çš„å¤šä½™ç¬¦å·ã€‚insert æ“ä½œæ‰§è¡Œçš„ SQL è¯­å¥ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span> gmt_create<span class="token punctuation">,</span> gmt_modified<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> age <span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span> UTC_TIMESTAMP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UTC_TIMESTAMP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token number">12</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è™½ç„¶æˆ‘ä»¬å¹¶æœªä¼ å…¥ address å‚æ•°ï¼Œä½† MyBatis è¿˜æ˜¯å°† age åé¢å¤šä½™çš„é€—å·åˆ é™¤äº†ã€‚ç”±äº <code>trim</code> å…ƒç´ å¯ä»¥è‡ªå®šä¹‰ SQL å­å¥çš„å‰ç¼€ã€åç¼€ç­‰å†…å®¹ï¼Œå› æ­¤ <code>trim</code> æ¯” <code>where</code> æ›´åŠ çµæ´»ï¼Œä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ <code>trim</code> å…ƒç´ å®ç° <code>&lt;where&gt;</code> æ ‡ç­¾çš„åŠŸèƒ½ã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>where<span class="token punctuation">"</span></span> <span class="token attr-name">prefixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>and |or<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id !<span class="token punctuation">=</span> null and user_id !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token cdata">&lt;![CDATA[id &lt;= #{user_id}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>max_age !<span class="token punctuation">=</span> null and max_age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            and <span class="token cdata">&lt;![CDATA[age &lt;= #{max_age}]]></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é™¤äº† <code>&lt;where&gt;</code> æ ‡ç­¾ï¼Œ<code>trim</code> å…ƒç´ è¿˜å¯ä»¥å®ç° <code>&lt;set&gt;</code> æ ‡ç­¾çš„åŠŸèƒ½ã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    update user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>set<span class="token punctuation">"</span></span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name !<span class="token punctuation">=</span> null and user_name !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            user_name = #{user_name},        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age !<span class="token punctuation">=</span> null and age !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            age = #{age}        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>    where id = #{user_id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥å‘ç°ï¼Œ<code>where</code> å’Œ <code>set</code> å…¶å®éƒ½æ˜¯ <code>trim</code> çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚ä¸‹é¢é™„ä¸Š <code>trim</code> ä¸­å„ä¸ªå±æ€§çš„å«ä¹‰ï¼š</p><ul><li><p>prefixï¼šéœ€è¦å¢åŠ çš„å‰ç¼€ã€‚</p></li><li><p>prefixOverridesï¼šéœ€è¦å»é™¤çš„å¤šä½™å‰ç¼€ã€‚</p></li><li><p>suffixï¼šéœ€è¦å¢åŠ çš„åç¼€ã€‚</p></li><li><p>suffixOverridesï¼šéœ€è¦å»é™¤çš„å¤šä½™åç¼€ã€‚</p></li></ul><h2 id="foreach-æ ‡ç­¾"><a href="#foreach-æ ‡ç­¾" class="headerlink" title="foreach æ ‡ç­¾"></a>foreach æ ‡ç­¾</h2><p>å½“ SQL çš„å…¥å‚ä¸ºä¸€ä¸ªé›†åˆæˆ–æ•°ç»„æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>&lt;foreach&gt;</code> æ ‡ç­¾éå†é›†åˆæˆ–æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¹¶å°†å…¶æ‹¼æ¥ä¸ºç‰¹å®šçš„è¡¨è¾¾å¼ï¼Œä¸åŒçš„è¡¨è¾¾å¼ä¹‹é—´è¿˜å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„åˆ†éš”ç¬¦ã€‚ä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ <code>&lt;foreach&gt;</code> æ ‡ç­¾æŸ¥è¯¢ id ä¸º 1ã€2ã€3 çš„ç”¨æˆ·æ•°æ®ã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ids<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span>                    <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>or<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            id=#{id}        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ids"</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"Shanghai"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"å¼ ä¸‰"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"Beijing"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653148800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"æå››"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>select æ“ä½œæ‰§è¡Œçš„ SQL è¯­å¥ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token punctuation">(</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">or</span> id<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">or</span> id<span class="token operator">=</span><span class="token number">3</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>&lt;foreach&gt;</code> æ ‡ç­¾ä¹Ÿå¸¸å¸¸ä¸ <code>in</code> å…³é”®å­—æ­é…æ¥ä½¿ç”¨ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        id in        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ids<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span>                    <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            id        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>select æ“ä½œæ‰§è¡Œçš„ SQL è¯­å¥ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> id <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹é¢é™„ä¸Š <code>foreach</code> ä¸­å„ä¸ªå±æ€§çš„å«ä¹‰ï¼š</p><ul><li><p>collectionï¼šéå†çš„é›†åˆæˆ–æ•°ç»„ã€‚</p></li><li><p>itemï¼šé›†åˆæˆ–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚</p></li><li><p>openï¼š<code>foreach</code> å­å¥çš„å¼€å¤´ã€‚</p></li><li><p>closeï¼š<code>foreach</code> å­å¥çš„ç»“å°¾ã€‚</p></li><li><p>separatorï¼šä¸åŒå…ƒç´ ä¸­é—´çš„åˆ†éš”ç¬¦ã€‚</p></li></ul><h2 id="bind-æ ‡ç­¾"><a href="#bind-æ ‡ç­¾" class="headerlink" title="bind æ ‡ç­¾"></a>bind æ ‡ç­¾</h2><p><code>&lt;bind&gt;</code> æ ‡ç­¾å¯ä»¥å°† OGNL è¡¨è¾¾å¼å€¼èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œè¿™æ ·ä¸‹æ–‡ä¸­çš„ SQL è¯­å¥å°±å¯ä»¥å¼•ç”¨è¯¥å˜é‡ã€‚</p><p>mapper æ–‡ä»¶ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bind</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pattern<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">'</span>%<span class="token punctuation">'</span> + user_name + <span class="token punctuation">'</span>%<span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    select    *    from user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name !<span class="token punctuation">=</span> null and user_name !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            user_name like #{pattern}        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">findUser</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1653235200000</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1653235200000</span><span class="token punctuation">,</span><span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"John"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>select æ“ä½œæ‰§è¡Œçš„ SQL è¯­å¥ä¸ºï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> user_name <span class="token operator">like</span> <span class="token string">'%John%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatis ç»“æœæ˜ å°„æ€»ç»“</title>
      <link href="/2022/036441.html"/>
      <url>/2022/036441.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç»“æœæ˜ å°„æŒ‡çš„æ˜¯å°†æ•°æ®è¡¨ä¸­çš„å­—æ®µä¸å®ä½“ç±»ä¸­çš„å±æ€§å…³è”èµ·æ¥ï¼Œè¿™æ · MyBatis å°±å¯ä»¥æ ¹æ®æŸ¥è¯¢åˆ°çš„æ•°æ®æ¥å¡«å……å®ä½“å¯¹è±¡çš„å±æ€§ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆèµ‹å€¼æ“ä½œã€‚å…¶å® MyBatis çš„å®˜æ–¹æ–‡æ¡£å¯¹æ˜ å°„è§„åˆ™çš„è®²è§£è¿˜æ˜¯éå¸¸æ¸…æ¥šçš„ï¼Œä½†è€ƒè™‘åˆ°è‡ªå·±é©¬ä¸Šå°±ä¼šæˆä¸ºä¸€å SQL Boyï¼Œä»¥åå…ä¸äº†ç»å¸¸è·Ÿ SQL æ‰“äº¤é“ï¼ˆå…¬å¸ä½¿ç”¨çš„ä¹Ÿæ˜¯ MyBatisï¼‰ï¼Œæ‰€ä»¥å¸Œæœ›ç”¨æ›´åŠ é€šä¿—çš„è¯­è¨€å¯¹å®˜æ–¹æ–‡æ¡£æ‰€ä»‹ç»çš„å¸¸ç”¨æ˜ å°„è§„åˆ™åšä¸€ä¸ªæ€»ç»“ï¼Œæ—¢ä¸ºåˆšå…¥é—¨çš„åŒå­¦æä¾›ä¸€ä¸ªå‚è€ƒï¼Œä¹Ÿæ–¹ä¾¿è‡ªå·±ä»¥åæŸ¥é˜…ã€‚æœ¬æ–‡ä¼šç»“åˆä¸€äº›å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼Œå¹¶é€šè¿‡ç®€å•çš„ç¤ºä¾‹æ¥ä»‹ç»ä¸åŒçš„æ˜ å°„æ–¹æ³•ã€‚å¦‚æœ‰ç†è§£é”™è¯¯ï¼Œè¿˜è¯·å¤§å®¶æ‰¹è¯„æŒ‡æ­£ï¼</p><h2 id="ç®€å•å­—æ®µæ˜ å°„"><a href="#ç®€å•å­—æ®µæ˜ å°„" class="headerlink" title="ç®€å•å­—æ®µæ˜ å°„"></a>ç®€å•å­—æ®µæ˜ å°„</h2><p>MyBatis ä¸­çš„ resultType å’Œ resultMap å‡æ”¯æŒç»“æœæ˜ å°„ï¼Œå¯¹äºä¸€äº›ç®€å•çš„æ˜ å°„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ resultType æ¥å®Œæˆã€‚ä½†å¦‚æœå®ä½“ç±»ä¸­çš„å±æ€§ä¸ºå¤æ‚ç±»å‹ï¼Œæˆ–è€…å±æ€§åå’Œå­—æ®µåæ— æ³•å¯¹åº”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ resultMap æ¥åˆ›å»ºè‡ªå®šä¹‰çš„æ˜ å°„å…³ç³»ã€‚ä¸‹é¢ç”¨ä¸€ä¸ªç¤ºä¾‹æ¥æ¼”ç¤º resultType å’Œ resultMap çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><p>é¦–å…ˆåˆ›å»ºå®ä½“ç±» Userï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String address<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååˆ›å»º user è¡¨ï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>user_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€å‘ user è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/user%E8%A1%A8%E6%95%B0%E6%8D%AE.jpg" alt></p><p>é…ç½® MyBatisï¼Œå¯ç”¨åˆ«åå’Œé©¼å³°å¼å‘½åæ˜ å°„ï¼š</p><pre class="line-numbers language-yml"><code class="language-yml">#application.yamlmybatis:  mapper-locations: classpath:mapper/*  # æŒ‡å®š mapper.xml æ–‡ä»¶çš„è·¯å¾„ï¼Œè¯¥æ–‡ä»¶ç”¨äºç¼–å†™ SQL è¯­å¥  type-aliases-package: com.example.entity # è®¾ç½®åˆ«åï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰ MyBatis éœ€è¦è®¾ç½®åˆ«åçš„å®ä½“ç±»çš„æ‰€åœ¨çš„åŒ…ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMyBatis ä¼šä½¿ç”¨å®ä½“ç±»çš„éé™å®šç±»åæ¥ä½œä¸ºå®ƒçš„åˆ«åï¼Œå¦‚å°† com.example.entity.User çš„åˆ«åè®¾ç½®ä¸º User æˆ– userï¼ˆåˆ«åä¸åŒºåˆ†å¤§å°å†™ï¼‰  configuration:    map-underscore-to-camel-case: true # å¼€å¯é©¼å³°å‘½åè‡ªåŠ¨æ˜ å°„ï¼Œå¦‚å°†æ•°æ®è¡¨ä¸­çš„å­—æ®µ user_name æ˜ å°„åˆ°å®ä½“å¯¹è±¡çš„å±æ€§ userName<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»º mapper æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    id,    user_name,    age,    address,    gmt_create,    gmt_modified    from user    where id = #{id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ resultMap æ¥æŒ‡å®š SQL è¯­å¥çš„å‡ºå‚ç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ•°æ®è¡¨çš„å­—æ®µåä¸å®ä½“ç±»çš„å±æ€§åå®Œå…¨ç›¸åŒï¼ˆå¦‚ id å¯¹åº” idï¼‰ï¼Œæˆ–è€…äºŒè€…ç¬¦åˆé©¼å³°å¼å‘½åæ˜ å°„çš„è§„åˆ™ï¼ˆå¦‚ user_name å¯¹åº” userNameï¼‰ï¼Œé‚£ä¹ˆ MyBatis å¯ä»¥ç›´æ¥å®Œæˆèµ‹å€¼æ“ä½œã€‚ä½† gmt_create å’Œ gmt_modified ä¸ä¼šæ˜ å°„ä¸º createTime å’Œ updateTimeï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>resultMap</code> æ¥åˆ›å»ºæ–°çš„æ˜ å°„å…³ç³»ã€‚å¦‚æœå°† user è¡¨çš„å­—æ®µ gmt_create å’Œ gmt_modified åˆ†åˆ«æ”¹ä¸º create_time å’Œ update_timeï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ <code>resulType=&quot;User&quot;</code> æˆ– <code>resulType=&quot;user&quot;</code> æ¥æ›¿æ¢ <code>resultMap=&quot;UserMap&quot;</code>ã€‚</p><p>è°ƒç”¨ findUserByIdï¼ˆå‚æ•° id ç­‰äº 1ï¼‰æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¯å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span>    <span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span>    <span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span>    <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span>    <span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ©ç”¨-constructor-æŒ‡å®šæ„é€ æ–¹æ³•"><a href="#åˆ©ç”¨-constructor-æŒ‡å®šæ„é€ æ–¹æ³•" class="headerlink" title="åˆ©ç”¨ constructor æŒ‡å®šæ„é€ æ–¹æ³•"></a>åˆ©ç”¨ <code>constructor</code> æŒ‡å®šæ„é€ æ–¹æ³•</h2><p>MyBatis æŸ¥è¯¢å‡ºæ•°æ®åï¼Œä¼šè°ƒç”¨å®ä½“ç±»çš„æ— å‚æ„é€ æ–¹æ³•åˆ›å»ºå®ä½“å¯¹è±¡ï¼Œç„¶åä¸ºè¯¥å¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¼šåœ¨å®ä½“ç±»ä¸­é‡è½½å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨ä¸åŒçš„æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œä¸åŒçš„åˆå§‹åŒ–æ“ä½œï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¸Œæœ› MyBatis èƒ½å¤Ÿè°ƒç”¨æŒ‡å®šçš„æ„é€ æ–¹æ³•æ¥åˆå§‹åŒ–å¯¹è±¡ã€‚æ­¤å¤–ï¼Œå¦‚æœå®ä½“ç±»ä¸­ä»…æœ‰å¸¦å‚çš„æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦é€šçŸ¥ MyBatis è°ƒç”¨æŒ‡å®šçš„æ„é€ æ–¹æ³•ã€‚å¯¹äºè¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MyBatis æä¾›çš„ <code>constructor</code> å…ƒç´ æ¥è§£å†³ã€‚</p><blockquote><p>MyBatis å®˜æ–¹æ–‡æ¡£åœ¨ä»‹ç» <code>constructor</code> æ—¶æœ‰æåˆ°ï¼Œ<code>constructor</code> å…è®¸æˆ‘ä»¬åœ¨å§‹åŒ–å¯¹è±¡æ—¶å°±ä¸ºå¯¹è±¡çš„å±æ€§èµ‹å€¼ï¼Œè¿™æ ·å¯ä»¥ä¸ç”¨æš´éœ²å‡ºå…¬æœ‰æ–¹æ³•ã€‚</p></blockquote><p>é¦–å…ˆåœ¨ User ç±»ä¸­æ·»åŠ å¸¦å‚çš„æ„é€ æ–¹æ³•ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>String userName<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå°† mapper æ–‡ä»¶ä¿®æ”¹ä¸ºï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_int<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    id,    user_name,    age,    address,    gmt_create,    gmt_modified    from user    where id = #{id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„ï¼Œ<code>&lt;arg&gt;</code> æ ‡ç­¾çš„å®šä¹‰é¡ºåºå¿…é¡»ä¸æ„é€ æ–¹æ³•ä¸­çš„å‚æ•°é¡ºåºç›¸åŒï¼Œå› ä¸º MyBatis æ˜¯æ ¹æ® <code>&lt;constructor&gt;</code> æ ‡ç­¾ä¸­çš„å‚æ•°ç±»å‹åˆ—è¡¨æ¥åŒ¹é…å®ä½“ç±»çš„æ„é€ æ–¹æ³•çš„ï¼Œä¾‹å¦‚åœ¨æœ¬ä¾‹ä¸­ï¼ŒåŒ¹é…çš„æ„é€ æ–¹æ³•ä¸º <code>User.&lt;init&gt;(java.lang.String, int)</code>ã€‚å¦‚æœå°† xml æ–‡ä»¶ä¸­çš„ä¸¤ä¸ª <code>&lt;arg&gt;</code> æ ‡ç­¾äº’æ¢ä½ç½®ï¼Œé‚£ä¹ˆ User å¯¹è±¡å°†ä¸ä¼šè¢«å®ä¾‹åŒ–æˆåŠŸï¼Œå› ä¸º User ç±»ä¸­å¹¶æ²¡æœ‰å‚æ•°ç±»å‹åˆ—è¡¨ä¸º <code>(int, java.lang.String)</code> çš„æ„é€ æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬ä¸æŒ‡å®š <code>javaType</code> å±æ€§çš„å€¼ï¼Œé‚£ä¹ˆ MyBatis é»˜è®¤å°†å…¶ç½®ä¸º Objectï¼Œæ­¤æ—¶æ„é€ æ–¹æ³•ä¸­å¯¹åº”çš„å‚æ•°ç±»å‹ä¹Ÿå¿…é¡»ä¸º Objectã€‚</p><blockquote><p>MyBatis ä¸­çš„ _int ç±»å‹å¯¹åº” Java ä¸­çš„ int ç±»å‹ï¼Œint ç±»å‹å¯¹åº” Integer ç±»å‹ã€‚</p></blockquote><p>ç»è¿‡ä¸Šè¿°é…ç½®ï¼ŒMyBatis åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™å°±ä¼šè°ƒç”¨æˆ‘ä»¬æŒ‡å®šçš„æ„é€ æ–¹æ³•ã€‚å¦å¤–ï¼ŒMyBatis ä¹Ÿæ”¯æŒè·Ÿæ®å‚æ•°åç§°æ¥åŒ¹é…æ„é€ æ–¹æ³•ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_int<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&lt;arg&gt;</code> æ ‡ç­¾ä¸­çš„ <code>name</code> å±æ€§ç”¨äºè®¾ç½®æ„é€ æ–¹æ³•çš„å‚æ•°åç§°ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº† <code>name</code> çš„å€¼ï¼Œé‚£ä¹ˆ MyBatis ä¼šæ ¹æ®è¯¥å±æ€§åŒ¹é…å¯¹åº”çš„æ„é€ æ–¹æ³•ï¼Œä¸” <code>&lt;arg&gt;</code> æ ‡ç­¾çš„ä½ç½®å¯ä»¥éšæ„æ”¾ç½®ã€‚ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ª <code>&lt;arg&gt;</code> æ ‡ç­¾äº’æ¢ä½ç½®ï¼Œç„¶åè°ƒç”¨ findUserByIdï¼Œä»ç„¶å¯ä»¥æŸ¥è¯¢å‡ºç”¨æˆ·çš„ä¿¡æ¯ã€‚</p><h2 id="åˆ©ç”¨-association-å…³è”ä¸€ä¸ªå¤æ‚ç±»å‹"><a href="#åˆ©ç”¨-association-å…³è”ä¸€ä¸ªå¤æ‚ç±»å‹" class="headerlink" title="åˆ©ç”¨ association å…³è”ä¸€ä¸ªå¤æ‚ç±»å‹"></a>åˆ©ç”¨ <code>association</code> å…³è”ä¸€ä¸ªå¤æ‚ç±»å‹</h2><p>åšå®¢ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æ‹…ä»»ç€æŸç§è§’è‰²ï¼Œå¦‚æ™®é€šç”¨æˆ·ã€ç®¡ç†å‘˜ã€ç‰ˆä¸»ç­‰ã€‚ä¸ºäº†æ›´å¥½åœ°æè¿°ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸º User ç±»æ·»åŠ ä¸€ä¸ª Role ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œè®°å½•å½“å‰ç”¨æˆ·æ‰€å±çš„è§’è‰²ã€‚ä½† Role ç±»å‹ä¸ Stringã€int ç­‰ç±»å‹ä¸åŒï¼ŒRole å¯¹è±¡æœ¬èº«ä¹Ÿå­˜å‚¨äº†ä¸€äº›ç‰¹å®šçš„å±æ€§ï¼Œå¦‚ idã€roleName ç­‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ MyBatis æ— æ³•ä¸ºè¿™äº›å±æ€§èµ‹å€¼ã€‚ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®åˆå§‹åŒ– Role å˜é‡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>association</code> å…ƒç´ å°†æŸ¥è¯¢åˆ°çš„ç»“æœä¸ Role å¯¹è±¡çš„å±æ€§å…³è”èµ·æ¥ã€‚</p><p>é¦–å…ˆä¿®æ”¹ User ç±»/åˆ›å»º Role ç±»ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†å±æ€§</span>    <span class="token keyword">private</span> Role role<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Role</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String roleName<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååˆ›å»º role è¡¨ï¼ˆå­˜å‚¨è§’è‰²ä¿¡æ¯ï¼‰å’Œ user_roles è¡¨ï¼ˆå­˜å‚¨ç”¨æˆ·å’Œè§’è‰²çš„å…³è”ä¿¡æ¯ï¼‰ï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true"># åˆ›å»º `role` è¡¨</span><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span class="token comment" spellcheck="true"># åˆ›å»º `user_roles` è¡¨</span><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>role_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€å‘ role è¡¨å’Œ user_roles è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/role%E5%92%8Cuser_roles%E8%A1%A8%E6%95%B0%E6%8D%AE.jpg" alt></p><p>MyBatis ä¸ºæˆ‘ä»¬æä¾›äº†ä¸‰ç§å¤„ç†å­å¯¹è±¡ï¼ˆå¦‚ Role å¯¹è±¡ï¼‰çš„æ–¹å¼ï¼Œåˆ†åˆ«ä¸º <code>åµŒå¥—ç»“æœæ˜ å°„</code>ã€<code>åµŒå¥—æŸ¥è¯¢</code> å’Œ <code>å…³è”å¤šä¸ªç»“æœé›†</code>ã€‚</p><h3 id="1-åµŒå¥—ç»“æœæ˜ å°„"><a href="#1-åµŒå¥—ç»“æœæ˜ å°„" class="headerlink" title="1. åµŒå¥—ç»“æœæ˜ å°„"></a>1. åµŒå¥—ç»“æœæ˜ å°„</h3><p><code>åµŒå¥—ç»“æœæ˜ å°„</code> æŒ‡çš„æ˜¯åœ¨ resultMap ä¸­åµŒå¥—ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œmapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roleName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    u.id,    u.user_name,    u.age,    u.address,    u.gmt_create,    u.gmt_modified,    r.id as 'role_id',    r.role_name    from user as u    left join user_roles as ur on ur.user_id = u.id    left join role as r on ur.role_id = r.id    where u.id = #{id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†æŸ¥è¯¢åˆ°çš„ role_id å’Œ role_name åˆ†åˆ«æ˜ å°„åˆ° Role å¯¹è±¡ï¼ˆUser å¯¹è±¡çš„å±æ€§ï¼‰çš„ id å’Œ roleNameã€‚</p><p>è°ƒç”¨ findUserById æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¯å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span>    <span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span>    <span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span>    <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"role"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"roleName"</span><span class="token operator">:</span><span class="token string">"ç®¡ç†å‘˜"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span>    <span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å°† <code>association</code> ä¸­çš„æ˜ å°„å…³ç³»ç‹¬ç«‹å‡ºæ¥ï¼Œæ”¹å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼Œæ–¹ä¾¿å¤ç”¨ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_id<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RoleMap<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RoleMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roleName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-åµŒå¥—æŸ¥è¯¢"><a href="#2-åµŒå¥—æŸ¥è¯¢" class="headerlink" title="2. åµŒå¥—æŸ¥è¯¢"></a>2. åµŒå¥—æŸ¥è¯¢</h3><p><code>åµŒå¥—æŸ¥è¯¢</code> æŒ‡çš„æ˜¯åœ¨ <code>resultMap</code> ä¸­åµŒå¥—ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œmapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{user_id<span class="token punctuation">=</span>id}<span class="token punctuation">"</span></span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectUserRole<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectUserRole<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        select        r.id,        r.role_name        from user_roles as ur        left join role as r on ur.role_id = r.id        where ur.user_id = #{user_id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        select        id,        user_name,        age,        address,        gmt_create,        gmt_modified        from user        where id = #{id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resultMap ä¸­åµŒå¥—äº†ä¸€ä¸ªå­æŸ¥è¯¢ <code>selectUserRole</code>ï¼ŒMyBatis é¦–å…ˆä» user è¡¨ä¸­æŸ¥è¯¢å‡º idã€user_name ç­‰ä¿¡æ¯ï¼Œç„¶åå°† user_id ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>selectUserRole</code>ï¼Œ<code>selectUserRole</code> è´Ÿè´£ä» role è¡¨å’Œ user_roles è¡¨ä¸­æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ã€‚<code>column=&quot;{user_id=id}&quot;</code> æŒ‡çš„æ˜¯å°†æŸ¥è¯¢åˆ°çš„ id èµ‹å€¼ç»™å˜é‡ user_idï¼Œç„¶åå°† user_id ä½œä¸ºå­æŸ¥è¯¢çš„å…¥å‚ï¼ˆå¦‚æœç›´æ¥å°† id ä½œä¸ºå…¥å‚ï¼Œé‚£ä¹ˆ User å¯¹è±¡çš„ id å±æ€§å°†ä¸ä¼šè¢«èµ‹å€¼ï¼‰ï¼Œå¦‚æœéœ€è¦ä¼ å…¥å¤šä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¤åˆå±æ€§ï¼Œå¦‚ <code>column=&quot;{param1=value1, param2=value2}&quot;</code>ã€‚æ³¨æ„ï¼ŒåµŒå¥—å­æŸ¥è¯¢æ—¶ï¼Œå­æŸ¥è¯¢ä¸­çš„ parameterType å¿…é¡»è®¾ç½®ä¸º <code>Map</code> æˆ–çœç•¥ä¸å†™ã€‚</p><h3 id="3-å…³è”å¤šä¸ªç»“æœé›†"><a href="#3-å…³è”å¤šä¸ªç»“æœé›†" class="headerlink" title="3. å…³è”å¤šä¸ªç»“æœé›†"></a>3. å…³è”å¤šä¸ªç»“æœé›†</h3><p><code>å…³è”å¤šä¸ªç»“æœé›†</code> æŒ‡çš„æ˜¯ä¸€æ¬¡æ€§æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢è¯­å¥ï¼Œå¹¶å¾—åˆ°å¤šä¸ªç»“æœé›†ï¼Œç„¶ååˆ©ç”¨æŸä¸ªç»“æœé›†çš„æ•°æ®æ¥å¡«å……å¯¹è±¡çš„å±æ€§ã€‚</p><p>é¦–å…ˆåœ¨ MySQL æ•°æ®åº“ä¸­åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ findUserAndRoleï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- å°†ç»“æŸæ ‡å¿—ç¬¦æ›´æ”¹ä¸º $$</span><span class="token keyword">delimiter</span> $$<span class="token keyword">create</span> <span class="token keyword">procedure</span> findUserAndRole<span class="token punctuation">(</span><span class="token operator">in</span> user_id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">begin</span>    <span class="token keyword">select</span>    id<span class="token punctuation">,</span>    user_name<span class="token punctuation">,</span>    age<span class="token punctuation">,</span>    address<span class="token punctuation">,</span>    gmt_create<span class="token punctuation">,</span>    gmt_modified    <span class="token keyword">from</span> <span class="token keyword">user</span>    <span class="token keyword">where</span> id <span class="token operator">=</span> user_id<span class="token punctuation">;</span>    <span class="token keyword">select</span>     r<span class="token punctuation">.</span>id <span class="token keyword">as</span> role_id<span class="token punctuation">,</span>     r<span class="token punctuation">.</span>role_name <span class="token keyword">as</span> role_name<span class="token punctuation">,</span>     ur<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> user_id     <span class="token keyword">from</span> user_roles <span class="token keyword">as</span> ur     <span class="token keyword">left</span> <span class="token keyword">join</span> role <span class="token keyword">as</span> r     <span class="token keyword">on</span> ur<span class="token punctuation">.</span>role_id <span class="token operator">=</span> r<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span class="token keyword">end</span> $$<span class="token comment" spellcheck="true">-- å°†ç»“æŸæ ‡å¿—ç¬¦æ”¹å› ;</span><span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åä¿®æ”¹ mapper æ–‡ä»¶çš„å†…å®¹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span> <span class="token attr-name">resultSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">foreignColumn</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roleName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultSets</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user,role<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">statementType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CALLABLE<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        {call findUserAndRole(#{user_id,jdbcType=INTEGER,mode=IN})}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£é‡Šä¸€ä¸‹ä¸Šè¿°æ“ä½œçš„å«ä¹‰ï¼Œæˆ‘ä»¬åœ¨å­˜å‚¨è¿‡ç¨‹ findUserAndRole ä¸­å®šä¹‰äº†ä¸¤æ¡ SQL è¯­å¥ï¼Œç¬¬ä¸€æ¡çš„æ‰§è¡Œé€»è¾‘æ˜¯åˆ©ç”¨ user_id ä» user è¡¨ä¸­æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·çš„ idï¼Œuser_name ç­‰ä¿¡æ¯ï¼›ç¬¬äºŒæ¡çš„æ‰§è¡Œé€»è¾‘æ˜¯åˆ©ç”¨å…³è”æŸ¥è¯¢ä» role è¡¨å’Œ user_roles è¡¨ä¸­æŸ¥è¯¢å‡º user_idã€role_id ä»¥åŠ role_name ç­‰ä¿¡æ¯ã€‚æˆ‘ä»¬å°†ä¸¤æ¬¡æŸ¥è¯¢å¾—åˆ°çš„ç»“æœé›†åˆ†åˆ«è¡¨ç¤ºä¸º user å’Œ roleï¼Œå³ <code>resultSets=&quot;user,role&quot;</code>ï¼Œç„¶åé€šè¿‡ <code>association</code> å°†ç»“æœé›† role ä¸­çš„ role_id å’Œ role_name åˆ†åˆ«æ˜ å°„åˆ° Role å¯¹è±¡çš„ id å’Œ roleName å±æ€§ã€‚<code>column=&quot;id&quot; foreignColumn=&quot;user_id&quot;</code> ç”¨äºå…³è”ä¸¤ä¸ªç»“æœé›†ä¸­çš„æ•°æ®ï¼Œå› ä¸ºç»“æœé›† role ä¸­åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ï¼ˆè™½ç„¶æœ¬ä¾‹ä¸­æˆ‘ä»¬åªè®¾ç½®äº†ä¸€ä¸ªç”¨æˆ·ï¼Œä½†å®é™…ä¸Šç»“æœé›† role ä¸­åŒ…å«ç€æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯ï¼‰ï¼Œå› æ­¤åœ¨è¿›è¡Œå±æ€§å¡«å……ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡æ˜åˆ©ç”¨å“ªä¸€ä¸ªè§’è‰²ä¿¡æ¯è¿›è¡Œå±æ€§å¡«å……ï¼Œ<code>column=&quot;id&quot; foreignColumn=&quot;user_id&quot;</code> çš„ä½œç”¨å°±æ˜¯ä»ç»“æœé›† role ä¸­ç­›é€‰å‡º user_id ä¸º id çš„è§’è‰²ä¿¡æ¯ã€‚</p><blockquote><p>resultSets ä¸­ä¸åŒçš„ç»“æœé›†ä¹‹é—´ç”¨é€—å·åˆ†éš”ï¼Œä¸­é—´åƒä¸‡ä¸èƒ½åŠ ç©ºæ ¼ï¼</p></blockquote><h2 id="åˆ©ç”¨-collection-å…³è”å¤šä¸ªå¤æ‚ç±»å‹"><a href="#åˆ©ç”¨-collection-å…³è”å¤šä¸ªå¤æ‚ç±»å‹" class="headerlink" title="åˆ©ç”¨ collection å…³è”å¤šä¸ªå¤æ‚ç±»å‹"></a>åˆ©ç”¨ <code>collection</code> å…³è”å¤šä¸ªå¤æ‚ç±»å‹</h2><p>ä¸Šæ–‡ä¸­æˆ‘ä»¬åˆ†æäº†ä¸€ä¸ªç”¨æˆ·æ‹…ä»»ä¸€ç§è§’è‰²çš„æƒ…å†µï¼Œç„¶è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æœ‰å¯èƒ½åŒæ—¶æ‹…ä»»å¤šç§è§’è‰²ï¼Œä¾‹å¦‚ â€œJohnåŒå­¦â€ æ—¢å¯ä»¥æ˜¯ç®¡ç†å‘˜ï¼Œåˆå¯ä»¥æ˜¯ç‰ˆä¸»ã€‚æ­¤æ—¶ä½¿ç”¨ <code>association</code> æ— æ³•æ­£ç¡®æŸ¥è¯¢å‡ºç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ï¼Œå› ä¸º <code>association</code> å¤„ç†çš„æ˜¯ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ã€‚å½“éœ€è¦å…³è”å¤šä¸ªå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>collection</code> å…ƒç´ ã€‚</p><p>é¦–å…ˆä¿®æ”¹å®ä½“ç±»ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†å±æ€§</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Role<span class="token operator">></span> roles<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ user_roles è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/user_roles%E8%A1%A8%E6%95%B0%E6%8D%AE2.jpg" alt></p><p><code>collection</code> çš„ä½¿ç”¨æ–¹æ³•å’Œ <code>association</code> éå¸¸ç›¸ä¼¼ï¼Œåœ¨ä¸Šæ–‡ä¸­ä»‹ç»çš„ä¸‰ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åšä¸€äº›ç®€å•çš„ä¿®æ”¹ï¼Œå°±å¯ä»¥æŸ¥è¯¢å‡ºç”¨æˆ·çš„æ‰€æœ‰è§’è‰²ä¿¡æ¯ã€‚</p><h3 id="1-åµŒå¥—ç»“æœæ˜ å°„-1"><a href="#1-åµŒå¥—ç»“æœæ˜ å°„-1" class="headerlink" title="1. åµŒå¥—ç»“æœæ˜ å°„"></a>1. åµŒå¥—ç»“æœæ˜ å°„</h3><p>mapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roles<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roleName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    u.id,    u.user_name,    u.age,    u.address,    u.gmt_create,    u.gmt_modified,    r.id as 'role_id',    r.role_name    from user as u    left join user_roles as ur on ur.user_id = u.id    left join role as r on ur.role_id = r.id    where u.id = #{id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ä¸Šæ–‡ä¸­ä½¿ç”¨ <code>association</code> åµŒå¥—ç»“æœæ˜ å°„çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬å°† javaType æ›¿æ¢ä¸ºäº† ofTypeï¼Œä»¥æ­¤æ¥æŒ‡å®š Java é›†åˆä¸­çš„æ³›å‹ç±»å‹ã€‚</p><p>è°ƒç”¨ findUserById æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¯å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"BUPT"</span><span class="token punctuation">,</span>    <span class="token property">"age"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span>    <span class="token property">"createTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span>    <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"roles"</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"roleName"</span><span class="token operator">:</span><span class="token string">"ç®¡ç†å‘˜"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>            <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>            <span class="token property">"roleName"</span><span class="token operator">:</span><span class="token string">"ç‰ˆä¸»"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"updateTime"</span><span class="token operator">:</span><span class="token number">1637164800000</span><span class="token punctuation">,</span>    <span class="token property">"userName"</span><span class="token operator">:</span><span class="token string">"JohnåŒå­¦"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-åµŒå¥—æŸ¥è¯¢-1"><a href="#2-åµŒå¥—æŸ¥è¯¢-1" class="headerlink" title="2. åµŒå¥—æŸ¥è¯¢"></a>2. åµŒå¥—æŸ¥è¯¢</h3><p>mapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roles<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id<span class="token punctuation">=</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectUserRole<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectUserRole<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        select        r.id,        r.role_name        from user_roles as ur        left join role as r on ur.role_id = r.id        where ur.user_id = #{user_id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        select        id,        user_name,        age,        address,        gmt_create,        gmt_modified        from user        where id = #{id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬å°† javaType æ”¹ä¸º ofTypeã€‚</p><h3 id="3-å…³è”å¤šä¸ªç»“æœé›†-1"><a href="#3-å…³è”å¤šä¸ªç»“æœé›†-1" class="headerlink" title="3. å…³è”å¤šä¸ªç»“æœé›†"></a>3. å…³è”å¤šä¸ªç»“æœé›†</h3><p>mapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_create<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gmt_modified<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATE<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roles<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Role<span class="token punctuation">"</span></span> <span class="token attr-name">resultSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roles<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">foreignColumn</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>role_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roleName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findUserById<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token attr-name">resultSets</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user,roles<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserMap<span class="token punctuation">"</span></span> <span class="token attr-name">statementType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CALLABLE<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        {call findUserAndRole(#{user_id,jdbcType=INTEGER,mode=IN})}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒç†ï¼Œå­˜å‚¨è¿‡ç¨‹ä¸­çš„æ‰§è¡Œé€»è¾‘ä¿æŒä¸å˜ï¼Œåªéœ€å°† javaType æ”¹ä¸º ofTypeã€‚</p><blockquote><p>æ”¹ç”¨ <code>collection</code> åï¼Œè¿˜è¦æ³¨æ„å°† property ç”± role æ”¹ä¸º rolesã€‚å½“ç„¶ï¼Œè¿™ä¸ªåç§°å¯è‡ªç”±å®šä¹‰ã€‚</p></blockquote><h2 id="æŸ¥è¯¢å…·æœ‰æ ‘å½¢ç»“æ„çš„æ•°æ®"><a href="#æŸ¥è¯¢å…·æœ‰æ ‘å½¢ç»“æ„çš„æ•°æ®" class="headerlink" title="æŸ¥è¯¢å…·æœ‰æ ‘å½¢ç»“æ„çš„æ•°æ®"></a>æŸ¥è¯¢å…·æœ‰æ ‘å½¢ç»“æ„çš„æ•°æ®</h2><p>æ ‘å½¢ç»“æ„æ•°æ®åœ¨å®é™…å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯èœå•è¡¨ï¼Œæ¯ä¸ªçˆ¶èœå•éƒ½å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­èœå•ï¼Œè€Œæ¯ä¸ªå­èœå•ä¹Ÿå¯èƒ½åŒ…å«å­™å­èœå•ã€‚æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æŸ¥è¯¢å‡ºæŸä¸ªèœå•ä¸‹çš„æ‰€æœ‰å­èœå•ï¼Œå¹¶åˆ†çº§å±•ç¤ºï¼Œè¿™ç§æƒ…å†µåº”è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå…¶å®ä¸Šæ–‡ä¸­ä»‹ç»çš„ä¸‰ç§æ–¹æ³•å‡æ”¯æŒå¤šçº§ç»“æœæ˜ å°„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ mapper æ–‡ä»¶ä¸­åšä¸€äº›ç®€å•çš„å¤„ç†ã€‚</p><p>é¦–å…ˆåˆ›å»º Menu ç±»ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Menu</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> parentId<span class="token punctuation">;</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Menu<span class="token operator">></span> childMenus<span class="token punctuation">;</span>   <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>   <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååˆ›å»º menu è¡¨ï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>menu<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>menu<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>parent_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€å‘ menu è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/menu%E8%A1%A8%E6%95%B0%E6%8D%AE.jpg" alt></p><p>ä¸ºäº†æ›´ç›´è§‚åœ°å±•ç¤ºå„å±‚çº§èœå•ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬å°†æ•°æ®æ•´ç†åœ¨ä¸‹é¢çš„è¡¨æ ¼ä¸­ï¼š</p><table><thead><tr><th align="center">id <div style="width:100px"></div></th><th align="center">name <div style="width:100px"></div></th><th align="center">parent_id <div style="width:100px"></div></th></tr></thead><tbody><tr><td align="center">1</td><td align="center">æ–‡ç« </td><td align="center">0</td></tr><tr><td align="center">11</td><td align="center">æ‰€æœ‰æ–‡ç« </td><td align="center">1</td></tr><tr><td align="center">12</td><td align="center">å†™æ–‡ç« </td><td align="center">1</td></tr><tr><td align="center">121</td><td align="center">è½½å…¥è‰ç¨¿</td><td align="center">12</td></tr><tr><td align="center">2</td><td align="center">ç”¨æˆ·</td><td align="center">0</td></tr><tr><td align="center">21</td><td align="center">ä¸ªäººèµ„æ–™</td><td align="center">2</td></tr><tr><td align="center">3</td><td align="center">é™„ä»¶</td><td align="center">0</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°ï¼Œèœå•è¡¨æ€»å…±æœ‰ä¸‰ä¸ªå±‚çº§ï¼ˆä¸åŒ…å«ç¬¬ 0 çº§ï¼‰ï¼Œç¬¬ä¸€çº§çš„ â€œæ‰€æœ‰æ–‡ç« â€ ä¸‹æœ‰å­èœå• â€œå†™æ–‡ç« â€ï¼Œç¬¬äºŒçº§çš„ â€œå†™æ–‡ç« â€ ä¸‹æœ‰å­èœå• â€œè½½å…¥è‰ç¨¿â€ã€‚æ¯ä¸ªå±‚çº§çš„èœå•éƒ½å¯èƒ½æœ‰é›¶ä¸ªã€ä¸€ä¸ªæˆ–å¤šä¸ªå­èœå•ï¼Œä¸ºäº†å°†æ‰€æœ‰çš„èœå•æŸ¥è¯¢å‡ºæ¥ï¼Œæˆ‘ä»¬æ—¢è¦ä¿®æ”¹ SQL è¯­å¥ï¼Œåˆè¦ä¿®æ”¹ <code>resultMap</code> ä¸­çš„æ˜ å°„å…³ç³»ï¼Œä¸‹é¢ä»‹ç»ä¸‰ç§æŸ¥è¯¢æ–¹å¼ã€‚</p><h3 id="1-åµŒå¥—ç»“æœæ˜ å°„-2"><a href="#1-åµŒå¥—ç»“æœæ˜ å°„-2" class="headerlink" title="1. åµŒå¥—ç»“æœæ˜ å°„"></a>1. åµŒå¥—ç»“æœæ˜ å°„</h3><p>mapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menuMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childMenus<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id2<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name2<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id2<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childMenus<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id3<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name3<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id3<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findMenus<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menuMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    m1.id as id,    m1.name as name,    m1.parent_id as parent_id,    m2.id as id2,    m2.name as name2,    m2.parent_id as parent_id2,    m3.id as id3,    m3.name as name3,    m3.parent_id as parent_id3    from    menu as m1    left join menu as m2 on m1.id = m2.parent_id    left join menu as m3 on m2.id = m3.parent_id    where m1.parent_id = #{menu_id}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºèœå•è¡¨ä¸­æœ€å¤šæœ‰ä¸‰ä¸ªå±‚çº§ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ SQL è¯­å¥ä¸­ä½¿ç”¨äº†ä¸‰è¡¨è”æŸ¥ï¼Œåˆ†åˆ«ä»è¡¨ m1ã€m2ã€m3ï¼ˆå‡ä¸º menu è¡¨ï¼‰ä¸­æŸ¥è¯¢å‡ºå„ä¸ªçº§åˆ«ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰çš„èœå•ï¼Œç„¶ååœ¨ <code>collection</code> ä¸­æ–°å¢ä¸€ä¸ªåµŒå¥—ï¼Œè¡¨ m2 å’Œè¡¨ m3 ä¸­æŸ¥å‡ºçš„æ•°æ®å‡ç”¨äºå¡«å……å‰ä¸€çº§åˆ«çš„ childMenus å±æ€§ã€‚</p><p>è°ƒç”¨ findMenusï¼ˆå‚æ•° menu_id ç­‰äº 0ï¼‰æŸ¥è¯¢èœå•ä¿¡æ¯ï¼Œå¯å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span>    <span class="token punctuation">{</span>        <span class="token property">"childMenus"</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"childMenus"</span><span class="token operator">:</span><span class="token punctuation">[</span>                    <span class="token punctuation">{</span>                        <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">121</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"è½½å…¥è‰ç¨¿"</span><span class="token punctuation">,</span>                        <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">12</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"å†™æ–‡ç« "</span><span class="token punctuation">,</span>                <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">1</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                <span class="token property">"childMenus"</span><span class="token operator">:</span><span class="token punctuation">[</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"æ‰€æœ‰æ–‡ç« "</span><span class="token punctuation">,</span>                <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">1</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"æ–‡ç« "</span><span class="token punctuation">,</span>        <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        <span class="token property">"childMenus"</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"childMenus"</span><span class="token operator">:</span><span class="token punctuation">[</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"ä¸ªäººèµ„æ–™"</span><span class="token punctuation">,</span>                <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">2</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>        <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"ç”¨æˆ·"</span><span class="token punctuation">,</span>        <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        <span class="token property">"childMenus"</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>        <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"é™„ä»¶"</span><span class="token punctuation">,</span>        <span class="token property">"parentId"</span><span class="token operator">:</span><span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„ï¼Œ<code>åµŒå¥—ç»“æœæ˜ å°„</code> çš„æ–¹å¼ä¸å…·å¤‡é€šç”¨æ€§ï¼Œå› ä¸ºèœå•è¡¨çš„ç»“æ„å¯èƒ½ä¸æ­¢ä¸‰å±‚ã€‚å¦‚æœæœ‰å¤šä¸ªå±‚çº§çš„èœå•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»§ç»­ä¿®æ”¹ SQL è¯­å¥å¹¶æ–°å¢åµŒå¥—ã€‚</p><h3 id="2-åµŒå¥—æŸ¥è¯¢-2"><a href="#2-åµŒå¥—æŸ¥è¯¢-2" class="headerlink" title="2. åµŒå¥—æŸ¥è¯¢"></a>2. åµŒå¥—æŸ¥è¯¢</h3><p>mapper æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menuMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{menu_id<span class="token punctuation">=</span>id}<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childMenus<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findMenus<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findMenus<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menuMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select    id,    name,    parent_id    from    menu    where parent_id = #{menu_id} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†åµŒå¥—çš„å­æŸ¥è¯¢è®¾ç½®ä¸º findMenus æœ¬èº«ï¼ŒMyBatis é¦–å…ˆè°ƒç”¨ findMenus æŸ¥è¯¢å‡º parent_id ä¸º menu_id çš„èœå•ï¼Œç„¶åå°†æŸ¥è¯¢å‡ºçš„èœå•çš„ id èµ‹å€¼ç»™ menu_idï¼Œç»§ç»­è°ƒç”¨ findMenus æŸ¥è¯¢å‡ºä¸‹ä¸€å±‚çº§çš„èœå•ã€‚æ­¤ç§æ–¹å¼å¯ä»¥é€’å½’çš„æŸ¥è¯¢å‡ºæ‰€æœ‰èœå•ï¼Œæ— è®ºèœå•è¡¨æœ‰å¤šå°‘ä¸ªå±‚çº§ã€‚</p><h3 id="3-å…³è”å¤šä¸ªç»“æœé›†-2"><a href="#3-å…³è”å¤šä¸ªç»“æœé›†-2" class="headerlink" title="3. å…³è”å¤šä¸ªç»“æœé›†"></a>3. å…³è”å¤šä¸ªç»“æœé›†</h3><p>é¦–å…ˆåˆ›å»ºå­˜å‚¨è¿‡ç¨‹ findMenuï¼š</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">delimiter</span> $$<span class="token keyword">create</span> <span class="token keyword">procedure</span> findMenu<span class="token punctuation">(</span><span class="token operator">in</span> menu_id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">begin</span>    <span class="token keyword">select</span>    id <span class="token keyword">as</span> id1<span class="token punctuation">,</span>    name <span class="token keyword">as</span> name1<span class="token punctuation">,</span>    parent_id <span class="token keyword">as</span> parent_id1    <span class="token keyword">from</span> menu    <span class="token keyword">where</span> parent_id <span class="token operator">=</span> menu_id<span class="token punctuation">;</span>    <span class="token keyword">select</span>    id <span class="token keyword">as</span> id2<span class="token punctuation">,</span>    name <span class="token keyword">as</span> name2<span class="token punctuation">,</span>    parent_id <span class="token keyword">as</span> parent_id2    <span class="token keyword">from</span> menu<span class="token punctuation">;</span>    <span class="token keyword">select</span>    id <span class="token keyword">as</span> id3<span class="token punctuation">,</span>    name <span class="token keyword">as</span> name3<span class="token punctuation">,</span>    parent_id <span class="token keyword">as</span> parent_id3    <span class="token keyword">from</span> menu<span class="token punctuation">;</span><span class="token keyword">end</span> $$<span class="token comment" spellcheck="true">-- å°†ç»“æŸæ ‡å¿—ç¬¦æ”¹å› ;</span><span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå°† mapper æ–‡ä»¶çš„å†…å®¹ä¿®æ”¹ä¸ºï¼š</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MenuMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id1<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name1<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id1<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childMenus<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span> <span class="token attr-name">resultSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menu2<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id1<span class="token punctuation">"</span></span> <span class="token attr-name">foreignColumn</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id2<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name2<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id2<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childMenus<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Menu<span class="token punctuation">"</span></span> <span class="token attr-name">resultSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menu3<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id2<span class="token punctuation">"</span></span> <span class="token attr-name">foreignColumn</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id3<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name3<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent_id3<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parentId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findMenus<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">resultSets</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>menu1,menu2,menu3<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MenuMap<span class="token punctuation">"</span></span> <span class="token attr-name">statementType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CALLABLE<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        {call findMenu(#{menu_id,jdbcType=INTEGER,mode=IN})}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>findMenu ä¸­å®šä¹‰äº†ä¸‰æ¡ SQL è¯­å¥ï¼Œç¬¬ä¸€æ¡çš„æ‰§è¡Œé€»è¾‘æ˜¯ä» menu è¡¨ä¸­æŸ¥è¯¢å‡º parent_id ä¸º menu_id çš„èœå•ï¼Œå…¶å®ƒä¸¤æ¡çš„æ‰§è¡Œé€»è¾‘æ˜¯ä» menu è¡¨ä¸­æŸ¥è¯¢å‡ºæ‰€æœ‰çš„èœå•ã€‚æˆ‘ä»¬å°†ä¸‰æ¡æŸ¥è¯¢è¿”å›çš„ç»“æœé›†åˆ†åˆ«è¡¨ç¤ºä¸º menu1ã€menu2 å’Œ menu3ï¼Œç„¶ååˆ©ç”¨ menu2 å’Œ menu3 ä¸­çš„æ•°æ®åˆ†åˆ«å¡«å……å­èœå•å’Œå­™å­èœå•çš„å±æ€§ã€‚</p><p><code>å…³è”å¤šä¸ªç»“æœé›†</code> å’Œ <code>åµŒå¥—ç»“æœæ˜ å°„</code> ä¸€æ ·ï¼Œåœ¨æŸ¥è¯¢æ ‘å½¢ç»“æ„æ•°æ®æ—¶ä¸å…·å¤‡é€šç”¨æ€§ã€‚è‹¥èœå•è¡¨çš„å±‚çº§å¤§äº 3ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹å­˜å‚¨è¿‡ç¨‹å’Œæ˜ å°„å…³ç³»ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://mybatis.net.cn/sqlmap-xml.html#Auto-mapping" target="_blank" rel="noopener">MyBatis å®˜æ–¹æ–‡æ¡£</a><br><a href="https://juejin.cn/post/6844903858477481992" target="_blank" rel="noopener">Mybatis ä¸­å¼ºå¤§çš„ resultMap</a></p>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot æ•´åˆ MyBatis</title>
      <link href="/2022/0340561.html"/>
      <url>/2022/0340561.html</url>
      
        <content type="html"><![CDATA[<h2 id="MyBatis-ç®€ä»‹"><a href="#MyBatis-ç®€ä»‹" class="headerlink" title="MyBatis ç®€ä»‹"></a>MyBatis ç®€ä»‹</h2><p>MyBatis æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå®ƒæ”¯æŒè‡ªå®šä¹‰ SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„ã€‚MyBatis å…é™¤äº†å‡ ä¹æ‰€æœ‰çš„ JDBC ä»£ç ä»¥åŠè®¾ç½®å‚æ•°å’Œè·å–ç»“æœé›†çš„å·¥ä½œã€‚MyBatis å¯ä»¥é€šè¿‡ç®€å•çš„ XML æˆ–æ³¨è§£æ¥é…ç½®å’Œæ˜ å°„åŸå§‹ç±»å‹ã€æ¥å£å’Œ Java POJOï¼ˆPlain Ordinary Java Objectsï¼Œç®€å• Java å¯¹è±¡ï¼‰ä¸ºæ•°æ®åº“ä¸­çš„è®°å½•ã€‚</p><blockquote><p>å‚è€ƒè‡ª MyBatis çš„å®˜æ–¹ç®€ä»‹ã€‚</p></blockquote><p>MyBatis ä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ol><li><p>å°å·§å¹¶ä¸”ç®€å•æ˜“å­¦ã€‚</p></li><li><p>ç›¸æ¯”äº JDBC å‡å°‘äº†å¤§é‡å†—ä½™çš„ä»£ç ã€‚</p></li><li><p>å°† SQL è¯­å¥ä¸ç¨‹åºä»£ç è¿›è¡Œåˆ†ç¦»ï¼Œé™ä½äº†è€¦åˆï¼Œä¾¿äºç®¡ç†ã€‚</p></li><li><p>æä¾› XML æ ‡ç­¾ï¼Œæ”¯æŒç¼–å†™åŠ¨æ€ SQL è¯­å¥ã€‚</p></li><li><p>æä¾›æ˜ å°„æ ‡ç­¾ï¼Œæ”¯æŒ Java å¯¹è±¡ä¸æ•°æ®åº“ ORM å­—æ®µçš„æ˜ å°„å…³ç³»ã€‚</p></li></ol><!-- MyBatis çš„ç¼ºç‚¹1. SQL è¯­å¥ç¼–å†™å·¥ä½œé‡è¾ƒå¤§ï¼Œå°¤å…¶æ˜¯å­—æ®µå’Œå…³è”è¡¨æ¯”è¾ƒå¤šæ—¶ã€‚2. SQL è¯­å¥ä¾èµ–äºæ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“ç§»æ¤æ€§å·®ï¼Œä¸èƒ½éšæ„æ›´æ¢æ•°æ®åº“ã€‚ --><h2 id="MyBatis-å®è·µ"><a href="#MyBatis-å®è·µ" class="headerlink" title="MyBatis å®è·µ"></a>MyBatis å®è·µ</h2><p>ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Spring Boot é¡¹ç›®ï¼Œæ•´åˆ MyBatisï¼Œå®ç°ç®€å•çš„ CRUD åŠŸèƒ½ã€‚</p><p><strong>1. å¼•å…¥ä¾èµ–</strong></p><p>POM æ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-XML"><code class="language-XML"><?xml version="1.0" encoding="UTF-8"?><project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">    <modelVersion>4.0.0</modelVersion>    <parent>        <groupId>org.springframework.boot</groupId>        <artifactId>spring-boot-starter-parent</artifactId>        <version>2.5.6</version>        <relativePath/> <!-- lookup parent from repository -->    </parent>    <groupId>com.example</groupId>    <artifactId>springboot-mybatis</artifactId>    <version>0.0.1-SNAPSHOT</version>    <name>springboot-mybatis</name>    <description>Demo project for Spring Boot</description>    <properties>        <java.version>1.8</java.version>    </properties>    <dependencies>        <dependency>            <groupId>org.springframework.boot</groupId>            <artifactId>spring-boot-starter-web</artifactId>        </dependency>        <dependency>            <groupId>mysql</groupId>            <artifactId>mysql-connector-java</artifactId>            <scope>runtime</scope>        </dependency>        <dependency>            <groupId>org.mybatis.spring.boot</groupId>            <artifactId>mybatis-spring-boot-starter</artifactId>            <version>2.2.0</version>        </dependency>        <dependency>            <groupId>org.springframework.boot</groupId>            <artifactId>spring-boot-starter-jdbc</artifactId>        </dependency>        <dependency>            <groupId>org.springframework.boot</groupId>            <artifactId>spring-boot-devtools</artifactId>            <scope>runtime</scope>            <optional>true</optional>        </dependency>        <dependency>            <groupId>org.projectlombok</groupId>            <artifactId>lombok</artifactId>            <optional>true</optional>        </dependency>        <dependency>            <groupId>org.springframework.boot</groupId>            <artifactId>spring-boot-starter-test</artifactId>            <scope>test</scope>        </dependency>    </dependencies>    <build>        <plugins>            <plugin>                <groupId>org.springframework.boot</groupId>                <artifactId>spring-boot-maven-plugin</artifactId>                <configuration>                    <excludes>                        <exclude>                            <groupId>org.projectlombok</groupId>                            <artifactId>lombok</artifactId>                        </exclude>                    </excludes>                </configuration>            </plugin>        </plugins>    </build></project><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2. é…ç½® MySQL å’Œ MyBatis</strong></p><p>é…ç½®æ–‡ä»¶ application.yml çš„å†…å®¹å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-yml"><code class="language-yml"># é…ç½® MySQLspring:  datasource:    url: jdbc:mysql://localhost:3306/test?serverTimezone=UTC    username: root    password: 123456    driver-class-name: com.mysql.cj.jdbc.Driver# é…ç½® MyBatismybatis:  mapper-locations: classpath:mapper/*  type-aliases-package: com.example.entity  configuration:    map-underscore-to-camel-case: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>MyBatis çš„é…ç½®é¡¹ä¸­ï¼š</p><ul><li><p><code>mapper-locations</code>ï¼šç”¨æ¥æŒ‡å®š mapper.xml æ–‡ä»¶çš„è·¯å¾„ï¼Œè¯¥æ–‡ä»¶ç”¨äºç¼–å†™ SQL è¯­å¥ã€‚</p></li><li><p><code>type-aliases-package</code>ï¼šç”¨æ¥è®¾ç½®åˆ«åï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰ MyBatis éœ€è¦è®¾ç½®åˆ«åçš„å®ä½“ç±»çš„æ‰€åœ¨çš„åŒ…ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMyBatis ä¼šä½¿ç”¨å®ä½“ç±»çš„éé™å®šç±»åæ¥ä½œä¸ºå®ƒçš„åˆ«åï¼Œå¦‚å°† <code>com.example.entity.User</code> çš„åˆ«åè®¾ç½®ä¸º <code>User</code> æˆ– <code>user</code>ï¼ˆåˆ«åä¸åŒºåˆ†å¤§å°å†™ï¼‰ã€‚å½“ç„¶ï¼ŒMyBatis ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åˆ«åï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨åæ–‡ä¸­å†èŠã€‚</p></li><li><p><code>map-underscore-to-camel-case</code>ï¼šç”¨æ¥å¼€å¯é©¼å³°å‘½åè‡ªåŠ¨æ˜ å°„ï¼Œå¦‚å°†æ•°æ®è¡¨ä¸­çš„å­—æ®µ user_name æ˜ å°„åˆ°å®ä½“å¯¹è±¡çš„å±æ€§ userNameã€‚</p><!-- è¿™æ ·åœ¨ mapper.xml æ–‡ä»¶ä¸­å°±å¯ä»¥ç›´æ¥ä½¿ç”¨éé™å®šç±»åæ¥ä½œä¸ºå®ƒçš„åˆ«åï¼Œå¦‚ "com.example.entity.User" å¯ä½¿ç”¨åˆ«å "User" ä»£æ›¿ --></li></ul><p><strong>3. å®ä½“ç±»</strong></p><p>ç¼–å†™ç®€å•çš„ User ç±»ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>entity<span class="token punctuation">;</span><span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Author john * @Date 2021/11/14 */</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String address<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>User ç±»ä¸­å°è£…äº†ç”¨æˆ·çš„ idã€å§“åã€å¹´é¾„ã€åœ°å€ã€åˆ›å»ºæ—¶é—´ä»¥åŠä¿®æ”¹æ—¶é—´ç­‰ä¿¡æ¯ã€‚</p><p><strong>4. åˆ›å»º user è¡¨</strong></p><p>user è¡¨çš„å­—æ®µè®¾è®¡å¦‚ä¸‹ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/user_table.png" alt></p><p><strong>5. ç¼–å†™ Mapper æ¥å£å’Œ mapper æ–‡ä»¶</strong></p><p>é¦–å…ˆç¼–å†™ UserMapper æ¥å£ï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">package com.example.mapper;import com.example.entity.User;/** * @Author john * @Date 2021/11/16 */public interface UserMapper {    void insertUser(User user);    User findUserById(long id);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥å£ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼ŒinsertUser ç”¨æ¥å‘æ•°æ®è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼ŒfindUserById ç”¨æ¥é€šè¿‡ id æŸ¥è¯¢ Userã€‚</p><p>ä¸Šè¿°æ“ä½œå®Œæˆåï¼Œæˆ‘ä»¬åœ¨ resources æ–‡ä»¶å¤¹ä¸­åˆ›å»º mapper/user-mapper.xml æ–‡ä»¶ï¼ˆæ–‡ä»¶è·¯å¾„åœ¨é…ç½®æ–‡ä»¶ application.yml ä¸­è®¾ç½®ï¼‰ã€‚user-mapper.xml æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-XML"><code class="language-XML"><?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><mapper namespace="com.example.mapper.UserMapper">    <sql id="insertFields">        user_name, age, address, gmt_create, gmt_modified    </sql>    <sql id="selectFields">        id, user_name, age, address, gmt_create, gmt_modified    </sql>    <resultMap id="UserMap" type="User">        <id column="id" jdbcType="INTEGER" property="id"/>        <result column="user_name" jdbcType="VARCHAR" property="userName"/>        <result column="age" jdbcType="INTEGER" property="age"/>        <result column="address" jdbcType="VARCHAR" property="address"/>        <result column="gmt_create" jdbcType="DATE" property="createTime" />        <result column="gmt_modified" jdbcType="DATE" property="updateTime" />    </resultMap>    <select id="findUserById" parameterType="Long" resultMap="UserMap">        select        <include refid="selectFields"/>        from user        where id = #{id}    </select>    <insert id="insertUser" parameterType="User" keyProperty="id">        insert into user (<include refid="insertFields"/>)        values(#{userName}, #{age}, #{address}, UTC_TIMESTAMP(), UTC_TIMESTAMP())    </insert></mapper><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒMapper æ¥å£ä¸­å®šä¹‰çš„æ˜¯ CRUD ç›¸å…³çš„æ–¹æ³•ï¼Œmapper.xml æ–‡ä»¶ä¸­å®šä¹‰çš„æ˜¯å…·ä½“çš„ SQL è¯­å¥ã€‚MyBatis å…è®¸æˆ‘ä»¬å°† Mapper æ¥å£ä¸ mapper.xml æ–‡ä»¶å…³è”åœ¨ä¸€èµ·ï¼Œè¿™æ ·å½“è°ƒç”¨ Mapper æ¥å£ä¸­çš„æ–¹æ³•æ—¶ï¼Œå®é™…çš„å¤„ç†é€»è¾‘ä¸ºæ‰§è¡Œ mapper.xml æ–‡ä»¶ä¸­å¯¹åº”çš„ SQL è¯­å¥ã€‚å…³è” Mapper æ¥å£å’Œ mapper.xml æ–‡ä»¶æ—¶éœ€è¦ä¿è¯ï¼š</p><ul><li><p>Mapper æ¥å£çš„å…¨é™å®šåå¯¹åº” mapper.xml æ–‡ä»¶çš„ namespace å€¼ã€‚</p></li><li><p>Mapper æ¥å£çš„æ–¹æ³•åå¯¹åº” statementï¼ˆæ¯ä¸€ä¸ª SQL å°±æ˜¯ä¸€ä¸ª statementï¼‰çš„ id å€¼ã€‚</p></li><li><p>Mapper æ¥å£ä¸­æ–¹æ³•æ¥æ”¶çš„å‚æ•°å¯¹åº” statement çš„å…¥å‚ã€‚</p></li><li><p>Mapper æ¥å£ä¸­æ–¹æ³•çš„è¿”å›å€¼å¯¹åº” statement çš„å‡ºå‚ã€‚</p></li></ul><p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹ mapper.xml æ–‡ä»¶ä¸­å‡ ä¸ªé‡è¦æ ‡ç­¾çš„å«ä¹‰ï¼š</p><ul><li><p><code>&lt;sql&gt;</code> æ ‡ç­¾ï¼šç”¨äºå®šä¹‰å¤ç”¨çš„ SQL ç‰‡æ®µï¼Œå¦‚æœå¤šä¸ª SQL éœ€è¦æ“ä½œç›¸åŒçš„å­—æ®µé›†ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ <code>&lt;sql&gt;</code> æ ‡ç­¾å°†è¿™äº›å­—æ®µæå–å‡ºæ¥ï¼Œç„¶ååœ¨ SQL è¯­å¥ä¸­ç›´æ¥å¼•ç”¨å³å¯ã€‚å¼•ç”¨çš„è¯­æ³•ä¸º <code>&lt;include refid=&quot; &quot;/&gt;</code>ï¼Œå…¶ä¸­ refid çš„å€¼å°±æ˜¯ <code>&lt;sql&gt;</code> çš„ id å€¼ã€‚</p></li><li><p><code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼šç”¨äºåˆ›å»ºæ•°æ®è¡¨å­—æ®µä¸å®ä½“å±æ€§çš„æ˜ å°„å…³ç³»ï¼Œåœ¨æŸ¥è¯¢æ“ä½œä¸­ï¼ŒMyBatis ä¼šæ ¹æ®æŸ¥è¯¢åˆ°çš„å­—æ®µåæ‰¾åˆ° POJO å¯¹åº”çš„å±æ€§åï¼Œç„¶åè°ƒç”¨è¯¥å±æ€§çš„ setter æ–¹æ³•è¿›è¡Œèµ‹å€¼ã€‚å¦‚æœæ•°æ®è¡¨çš„å­—æ®µåä¸å®ä½“ç±»çš„å±æ€§åå®Œå…¨ç›¸åŒï¼Œæˆ–è€…ç¬¦åˆé©¼å³°å¼å‘½åæ˜ å°„çš„è§„åˆ™ï¼Œé‚£ä¹ˆ MyBatis å¯ä»¥ç›´æ¥å®Œæˆèµ‹å€¼æ“ä½œã€‚å¦åˆ™çš„è¯ï¼Œå°±éœ€è¦æˆ‘ä»¬ä½¿ç”¨ <code>&lt;resultMap&gt;</code> æ ‡ç­¾åˆ›å»ºè‡ªå®šä¹‰çš„æ˜ å°„è§„åˆ™ï¼Œå‘Šè¯‰ MyBatis å­—æ®µå’Œå±æ€§ä¹‹é—´åº”è¯¥å¦‚ä½•æ˜ å°„ã€‚æœ¬å®éªŒä¸­ï¼Œuser è¡¨çš„ id ä¼šè‡ªåŠ¨æ˜ å°„ä¸º User å¯¹è±¡çš„ idï¼Œuser è¡¨çš„ user_name ä¹Ÿä¼šè‡ªåŠ¨æ˜ å°„ä¸º User å¯¹è±¡çš„ userNameã€‚ä½†æ˜¯ gmt_create å’Œ gmt_modified ä¸ä¼šæ˜ å°„ä¸º createTime å’Œ updateTimeï¼Œå› ä¸ºå­—æ®µåå’Œå±æ€§åæ—¢ä¸å®Œå…¨ä¸€è‡´ï¼Œä¹Ÿä¸ç¬¦åˆé©¼å³°å¼å‘½åæ˜ å°„çš„è§„åˆ™ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>&lt;resultMap&gt;</code> æ¥åˆ›å»ºæ–°çš„æ˜ å°„å…³ç³»ï¼Œå…¶ä¸­å±æ€§ id ç”¨äºæŒ‡æ˜è¯¥ resultMap çš„æ ‡å¿—ï¼Œå±æ€§ type ç”¨äºæŒ‡æ˜æ˜ å°„çš„å®ä½“ç±»ã€‚</p></li><li><p><code>&lt;select&gt;</code> æ ‡ç­¾ï¼šç”¨äºæ‰§è¡ŒæŸ¥è¯¢æ“ä½œã€‚ </p></li><li><p><code>&lt;insert&gt;</code> æ ‡ç­¾ï¼šç”¨äºæ‰§è¡Œæ’å…¥æ“ä½œã€‚</p></li></ul><blockquote><p>å®é™…ä¸Šï¼ŒMyBatis èµ‹å€¼æ—¶ä¸ä¸€å®šä¼šè°ƒç”¨å®ä½“ç±»å±æ€§çš„ setter æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç¼–ç æ—¶å¯èƒ½å¹¶æ²¡æœ‰æ·»åŠ è¯¥æ–¹æ³•ã€‚ä»¥ User ç±»çš„å±æ€§ id ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æ·»åŠ äº† setId æ–¹æ³•ï¼Œé‚£ä¹ˆ MyBatis ä¼šé€šè¿‡åå°„è·å–åˆ° setId å¯¹åº”çš„ MethodInvokerï¼Œç„¶åè°ƒç”¨ setId æ–¹æ³•ä¸º id èµ‹å€¼ï¼›å¦‚æœæœªè®¾ç½® setId æ–¹æ³•ï¼Œé‚£ä¹ˆ MyBatis ä¼šè·å–å±æ€§ id å¯¹åº”çš„ SetFieldInvokerï¼Œç„¶åä¸ºå±æ€§èµ‹å€¼ã€‚è¯¦è§ MetaObject ç±»çš„ setValue æ–¹æ³•ã€‚</p></blockquote><p>æ¥ä¸‹æ¥ä»‹ç» SQL è¯­å¥ä¸­å‡ ä¸ªé‡è¦å±æ€§çš„å«ä¹‰ï¼š</p><ul><li><p>parameterTypeï¼šç”¨äºæŒ‡å®š SQL è¯­å¥çš„å…¥å‚ç±»å‹ï¼ˆå¯ä»¥æ˜¯åŸºæœ¬æ•°æ®ç±»å‹æˆ–è€… JavaBeanï¼‰ï¼Œè¯¥ç±»å‹éœ€è¦ä¸å¯¹åº”çš„æ¥å£æ–¹æ³•çš„å…¥å‚ç±»å‹ä¸€è‡´ã€‚å¦‚æœæˆ‘ä»¬è®¾ç½®äº†åˆ«åï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«åä½œä¸ºå‚æ•°ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>User</code> æˆ– <code>user</code> ä»£æ›¿ <code>com.example.entity.User</code>ã€‚</p></li><li><p>resultMapï¼šç”¨äºæŒ‡å®š SQL è¯­å¥çš„å‡ºå‚ç±»å‹ï¼Œä»¥ insertUser æ–¹æ³•ä¸ºä¾‹ï¼Œåœ¨ Mapper æ¥å£ä¸­ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸º User ç±»å‹ï¼Œæ‰€ä»¥å¯¹åº”çš„ SQL è¯­å¥çš„è¿”å›å€¼ä¹Ÿåº”ä¸º User ç±»å‹ï¼Œç”±äº User å¯¹è±¡éœ€è¦ä½¿ç”¨ <code>&lt;resultMap&gt;</code> è¿›è¡Œå±æ€§æ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è‡ªå®šä¹‰çš„ <code>UserMap</code> æ¥ä½œä¸º SQL è¯­å¥çš„è¿”å›å€¼ç±»å‹ã€‚</p></li><li><p>keyPropertyï¼šç”¨äºæŒ‡å®šä¸»é”®åœ¨ POJO ä¸­å¯¹åº”çš„å±æ€§åï¼Œéœ€è¦é…åˆæ•°æ®åº“çš„è‡ªå¢ä¸»é”®æ¥ä½¿ç”¨ã€‚ä»¥ user è¡¨ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨å»ºè¡¨çš„æ—¶å€™å°†è¡¨çš„ä¸»é”® id è®¾ç½®ä¸ºäº†æ•°æ®åº“è‡ªå¢ idï¼Œå› æ­¤åœ¨å°† User å¯¹è±¡æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¹‹å‰ä¸éœ€è¦ä¸ºå±æ€§ id è®¾ç½®åˆå§‹å€¼ï¼ŒMySQL ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬èµ‹å€¼ï¼ŒkeyProperty çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ MyBatis å“ªä¸ªå±æ€§æ˜¯ä¸»é”®ã€‚</p></li></ul><!-- parameterType å’Œ resultTypeï¼ˆæœ¬å®éªŒä¸­æœªä½¿ç”¨ï¼‰åˆ†åˆ«ç”¨æ¥æŒ‡å®šå‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨äº†åˆ«åï¼Œæ‰€ä»¥ parameterType å’Œ resultType å¯ä»¥ç›´æ¥è®¾ç½®ä¸º "User" æˆ– "user"ï¼Œè€Œéå…¨é™å®šå "com.example.entity.User"ã€‚ --><!-- mapper æ–‡ä»¶ä¸­è¿˜æœ‰ä¸€ä¸ªå…³é”®æ ‡ç­¾ resultMapï¼ŒresultMap ä¸»è¦ç”¨æ¥åˆ›å»ºè‡ªå®šä¹‰çš„æ˜ å°„å…³ç³»ã€‚ä»¥æŸ¥è¯¢ä¸ºä¾‹ï¼ŒMyBatis çš„æ˜ å°„è§„åˆ™æ˜¯ï¼šæ ¹æ®æŸ¥è¯¢åˆ°çš„å­—æ®µåæ‰¾åˆ° POJO å¯¹åº”çš„å±æ€§åï¼Œç„¶åè°ƒç”¨è¯¥å±æ€§çš„ setter æ–¹æ³•è¿›è¡Œèµ‹å€¼ã€‚æœ¬å®éªŒä¸­ï¼Œuser è¡¨çš„ id ä¼šè‡ªåŠ¨æ˜ å°„ä¸º User å¯¹è±¡çš„ idï¼Œå› ä¸ºå­—æ®µåå’Œå±æ€§åæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼›user è¡¨çš„ user_name ä¹Ÿä¼šè‡ªåŠ¨æ˜ å°„ä¸º User å¯¹è±¡çš„ userNameï¼Œå› ä¸ºæˆ‘ä»¬å¼€å¯äº†é©¼å³°å¼å‘½åæ˜ å°„ã€‚ä½†æ˜¯ gmt_create ä¸ä¼šæ˜ å°„åˆ° createTimeï¼Œå› ä¸ºå­—æ®µåå’Œå±æ€§åæ—¢ä¸å®Œå…¨ä¸€è‡´ï¼Œä¹Ÿä¸ç¬¦åˆé©¼å³°å¼å‘½åæ˜ å°„çš„è§„åˆ™ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ resultMap æ¥åˆ›å»ºæ–°çš„æ˜ å°„å…³ç³»ï¼Œå°† gmt_create å’Œ gmt_modified åˆ†åˆ«æ˜ å°„åˆ° createTime å’Œ updateTimeï¼Œç„¶åå†å°† resultType æ›¿æ¢ä¸º resultMapï¼ˆå¦‚æœä¸éœ€è¦è‡ªå®šä¹‰æ˜ å°„ï¼Œæœ¬å®éªŒä¸­çš„ resultMap='UserMap' å¯æ›¿æ¢ä¸º resultType='User'ï¼‰ã€‚ --><p>é™¤äº† resultMap å¤–ï¼ŒresultType å±æ€§ä¹Ÿå¯ç”¨äºæŒ‡å®šå‡ºå‚ç±»å‹ã€‚å¦‚æœæˆ‘ä»¬å°† user è¡¨ä¸­çš„å­—æ®µ gmt_create å’Œ gmt_modified åˆ†åˆ«æ”¹ä¸º create_time å’Œ update_timeï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ä½¿ç”¨ <code>&lt;resultMap&gt;</code> æ ‡ç­¾æ¥é…ç½®æ˜ å°„è§„åˆ™ï¼Œå› ä¸º user è¡¨çš„æ‰€æœ‰å­—æ®µéƒ½å¯ä»¥å’Œ User å¯¹è±¡çš„å±æ€§ä¸€ä¸€å¯¹åº”ï¼Œè¿™æ ·åœ¨ SQL è¯­å¥ä¸­ï¼Œå°±å¯ä»¥å°† <code>resultMap=&quot;UserMap&quot;</code> æ›¿æ¢ä¸º <code>resulType=&quot;User&quot;</code> æˆ– <code>resulType=&quot;user&quot;</code>ã€‚å¦å¤–ï¼Œåœ¨æœ¬å®éªŒä¸­ï¼ŒresultMap æ ‡ç­¾ä¹Ÿå¯ä»¥å®šä¹‰ä¸ºï¼š</p><pre class="line-numbers language-XML"><code class="language-XML"><resultMap id="UserMap" type="User">    <result column="gmt_create" jdbcType="DATE" property="createTime" />    <result column="gmt_modified" jdbcType="DATE" property="updateTime" /></resultMap><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºå…¶ä»–å­—æ®µä¼šè‡ªåŠ¨æ˜ å°„ï¼Œä¸éœ€è¦é¢å¤–ä¹¦å†™ã€‚</p><p><strong>6. ç¼–å†™ Service</strong></p><p>åˆ›å»º UserServiceï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">package com.example.service;import com.example.entity.User;import com.example.mapper.UserMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;/** * @Author john * @Date 2021/11/16 */@Servicepublic class UserService {    @Autowired    private UserMapper userMapper;    public void insertUser(User user) {        userMapper.insertUser(user);    }    public User findUserById(long id) {        return userMapper.findUserById(id);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ UserService ä¸­æ³¨å…¥ UserMapper å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ç›¸å…³æ–¹æ³•æ¥æ·»åŠ /æŸ¥è¯¢ Userã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿæ­£å¸¸æ³¨å…¥ UserMapper å¯¹è±¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†å¯åŠ¨ç±»ä¸Šæ·»åŠ  @MapperScan æ³¨è§£ï¼Œå¹¶æŒ‡å®š Mapper æ¥å£æ‰€åœ¨çš„åŒ…ï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">package com.example;import org.mybatis.spring.annotation.MapperScan;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;@SpringBootApplication@MapperScan("com.example.mapper")public class SpringbootMybatisApplication {    public static void main(String[] args) {        SpringApplication.run(SpringbootMybatisApplication.class, args);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>com.example.mapper</code> åŒ…ä¸‹çš„æ‰€æœ‰ Mapper æ¥å£éƒ½ä¼šè¢« Spring æ‰«æã€‚</p><p>é™¤äº†åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  @MapperScan æ³¨è§£å¤–ï¼Œè¿˜å¯ä»¥åœ¨ Mapper æ¥å£ä¸Šç›´æ¥æ·»åŠ  @Mapper æ³¨è§£ï¼Œè¿™ç§æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºå®é™…ä¸­æˆ‘ä»¬å¯èƒ½ä¼šæœ‰å¤šä¸ª Mapper æ¥å£ï¼Œè¿™æ ·å°±éœ€è¦æ·»åŠ å¤šä¸ªæ³¨è§£ã€‚</p><p><strong>7. æµ‹è¯•</strong></p><p>ç¼–å†™æµ‹è¯•æ¥å£ï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">package com.example;import com.example.entity.User;import com.example.service.UserService;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;@SpringBootTestclass SpringbootMybatisApplicationTests {    @Autowired    private UserService service;    @Test    public void addUser(){        User user = new User();        user.setUserName("John");        user.setAge(24);        user.setAddress("BUPT");        service.insertUser(user);    }    @Test    public void findUser(){        System.out.println(service.findUserById(1));    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆæ‰§è¡Œ addUser() æ–¹æ³•ï¼Œæ‰§è¡ŒæˆåŠŸåæŸ¥è¯¢æ•°æ®è¡¨ï¼Œå¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/select.png" alt></p><p>ç„¶åæ‰§è¡Œ findUser() æ–¹æ³•ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/technology/MyBatis/select_test.png" alt></p><p>è‡³æ­¤ï¼ŒSpringBoot æ•´åˆ MyBatis æµ‹è¯•æˆåŠŸï¼</p><h2 id="MyBatis-è®¾ç½®åˆ«åçš„æ–¹å¼"><a href="#MyBatis-è®¾ç½®åˆ«åçš„æ–¹å¼" class="headerlink" title="MyBatis è®¾ç½®åˆ«åçš„æ–¹å¼"></a>MyBatis è®¾ç½®åˆ«åçš„æ–¹å¼</h2><p><strong>æ–¹å¼ä¸€</strong>ï¼šåœ¨é…ç½®æ–‡ä»¶ application.yml ä¸­æ·»åŠ é…ç½®ã€‚</p><p>yml æ–‡ä»¶çš„é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yml"><code class="language-yml">mybatis:  type-aliases-package: com.example.entity<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æœ¬å®éªŒé‡‡ç”¨æ­¤ç§æ–¹å¼è®¾ç½®åˆ«åï¼Œé»˜è®¤æƒ…å†µä¸‹å®ä½“ç±»çš„åˆ«åä¸ºå…¶ç±»åï¼Œä¸¥æ ¼æ¥è¯´æ˜¯é¦–å­—æ¯å°å†™çš„éé™å®šç±»åï¼Œç”±äºåˆ«åä¸åŒºåˆ†å¤§å°å†™ï¼Œæ‰€ä»¥ <code>User</code>ã€<code>user</code>ã€<code>uSer</code> çš„æ•ˆæœéƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>MyBatis ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åˆ«åï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å®ä½“ç±»ä¸Šæ·»åŠ  @Alias æ³¨è§£ï¼Œå°±å¯ä»¥ä¸ºå…¶è®¾ç½®åˆ«åï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>entity<span class="token punctuation">;</span><span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>type<span class="token punctuation">.</span>Alias<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Author john * @Date 2021/11/14 */</span><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@Alias</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String address<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°† User ç±»çš„åˆ«åè®¾ç½®ä¸ºäº† <code>hello</code>ã€‚æ³¨æ„ï¼Œè‹¥è¦ä½¿ @Alias æ³¨è§£ç”Ÿæ•ˆï¼Œå¿…é¡»é…ç½® <code>type-aliases-package</code> æ¥æŒ‡å®šå®ä½“ç±»çš„åŒ…è·¯å¾„ã€‚å¦å¤–ï¼Œ@Alias ä¼šä½¿é»˜è®¤çš„åˆ«åå˜å¾—æ— æ•ˆï¼Œä¾‹å¦‚åœ¨æœ¬å®éªŒä¸­ï¼ŒUser ç±»çš„åˆ«ååªèƒ½æ˜¯ <code>hello</code>ï¼Œè€Œä¸èƒ½æ˜¯ <code>User</code> æˆ– <code>user</code> ç­‰ã€‚ </p><p><strong>æ–¹å¼äºŒ</strong>ï¼šä½¿ç”¨ MyBatis çš„é…ç½®æ–‡ä»¶ filename.xmlã€‚</p><p>é¦–å…ˆåœ¨ yml æ–‡ä»¶ä¸­è®¾ç½® MyBatis é…ç½®æ–‡ä»¶ filename.xmlï¼ˆfilename æ˜¯é…ç½®æ–‡ä»¶çš„åç§°ï¼‰çš„è·¯å¾„ï¼š</p><pre class="line-numbers language-YML"><code class="language-YML"># é…ç½®MyBatismybatis:  mapper-locations: classpath:mapper/*  config-location: classpath:mybatis/mybatis-config.xml #MyBatisé…ç½®æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ resource æ–‡ä»¶å¤¹ä¸‹åˆ›å»º MyBatis çš„é…ç½®æ–‡ä»¶ mapper/mybatis-config.xmlï¼ˆè·¯å¾„å’Œæ–‡ä»¶ååœ¨ config-location ä¸­è®¾ç½®ï¼‰ï¼Œé…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-XML"><code class="language-XML"><?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE configuration        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"        "http://mybatis.org/dtd/mybatis-3-config.dtd"><configuration>    <settings>        <setting name="mapUnderscoreToCamelCase" value="true"/>    </settings>    <typeAliases>        <package name="com.example.entity"/>    </typeAliases></configuration><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡ ä¸ªé‡è¦æ ‡ç­¾çš„å«ä¹‰ä¸ºï¼š</p><ul><li><p><code>&lt;setting&gt;</code> æ ‡ç­¾ï¼šç”¨äºå¼€å¯é©¼å³°å‘½åæ˜ å°„ï¼Œå…¶æ•ˆæœä¸åœ¨ yml æ–‡ä»¶ä¸­é…ç½® <code>map-underscore-to-camel-case: true</code> æ˜¯ç›¸åŒçš„ã€‚</p></li><li><p><code>&lt;typeAliases&gt;</code> æ ‡ç­¾ï¼šç”¨äºé…ç½®åˆ«åï¼Œå­æ ‡ç­¾ <code>&lt;package&gt;</code> å¯ä»¥è®© MyBatis æ‰«ææŒ‡å®šåŒ…ä¸‹çš„å®ä½“ç±»ï¼Œå…¶æ•ˆæœä¸åœ¨ yml æ–‡ä»¶ä¸­é…ç½® <code>type-aliases-package: com.example.entity</code> æ˜¯ç›¸åŒçš„ã€‚</p></li></ul><p>åœ¨æ–¹å¼ä¸€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ @Alias æ³¨è§£è‡ªå®šä¹‰åˆ«åï¼Œè€Œåœ¨æ–¹å¼äºŒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>&lt;typeAliases&gt;</code> çš„å­æ ‡ç­¾ <code>&lt;typeAlias&gt;</code> æ¥è®¾ç½®åˆ«åï¼š</p><pre class="line-numbers language-XML"><code class="language-XML"><?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE configuration        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"        "http://mybatis.org/dtd/mybatis-3-config.dtd"><configuration>    <settings>        <setting name="mapUnderscoreToCamelCase" value="true"/>    </settings>    <typeAliases>        <typeAlias type="com.example.entity.User" alias="hello"/>    </typeAliases></configuration><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&lt;typeAlias&gt;</code> æ ‡ç­¾ä¸éœ€è¦é…ç½® <code>type-aliases-package</code> å°±å¯ä»¥ç”Ÿæ•ˆï¼Œä¸”è¯¥æ ‡ç­¾ä¸ <code>&lt;package&gt;</code> æ ‡ç­¾å¹¶ä¸å†²çªï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ·»åŠ äº† <code>&lt;package name=&quot;com.example.entity&quot;/&gt;</code>ï¼Œé‚£ä¹ˆ User ç±»çš„åˆ«åæ—¢å¯ä»¥æ˜¯ <code>hello</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯ <code>User</code> æˆ– <code>user</code> ç­‰ã€‚å½“ç„¶ï¼Œæ–¹å¼äºŒä¸­ä¹Ÿå¯ä»¥æ·»åŠ  @Alias æ³¨è§£ï¼Œä½†æ·»åŠ äº†è¯¥æ³¨è§£åï¼ŒUser ç±»çš„åˆ«ååªèƒ½ä¸º <code>hello</code> æˆ– @Alias æ³¨è§£æŒ‡å®šçš„åˆ«åã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git å¸¸ç”¨æŒ‡ä»¤ï¼ˆæŒç»­æ›´æ–°ï¼‰</title>
      <link href="/2020/0632512.html"/>
      <url>/2020/0632512.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>Git æ˜¯ç›®å‰æœ€æµè¡Œçš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œç†Ÿç»ƒä½¿ç”¨ Git æ˜¯æ¯ä¸ªç¨‹åºå‘˜å¿…å¤‡çš„æŠ€èƒ½ã€‚å¥ˆä½•è‡ªå·±éç§‘ç­å‡ºèº«ï¼Œå¯¹ Git çš„ä½¿ç”¨å°‘ä¹‹åˆå°‘ï¼Œå› æ­¤æ’°å†™æœ¬ç¯‡åšæ–‡æ¥è®°å½•å¸¸ç”¨çš„ Git æŒ‡ä»¤ï¼Œä»¥ä½œå¤‡å¿˜ã€‚</p><h2 id="æŸ¥çœ‹åˆ†æ”¯"><a href="#æŸ¥çœ‹åˆ†æ”¯" class="headerlink" title="æŸ¥çœ‹åˆ†æ”¯"></a>æŸ¥çœ‹åˆ†æ”¯</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># æŸ¥çœ‹å½“å‰åˆ†æ”¯</span><span class="token function">git</span> branch<span class="token comment" spellcheck="true"># æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯</span><span class="token function">git</span> branch -r<span class="token comment" spellcheck="true"># æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯</span><span class="token function">git</span> branch -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ–°å»ºåˆ†æ”¯"><a href="#æ–°å»ºåˆ†æ”¯" class="headerlink" title="æ–°å»ºåˆ†æ”¯"></a>æ–°å»ºåˆ†æ”¯</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. æ–°å»ºæœ¬åœ°åˆ†æ”¯ï¼Œä½†ä¸ä¼šåˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ï¼Œå¦‚æœåœ¨ xxx åˆ†æ”¯ä¸‹æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œé‚£ä¹ˆ new_branch åˆ†æ”¯çš„ä»£ç ä¸ xxx åˆ†æ”¯ç›¸åŒ</span><span class="token function">git</span> branch new_branch<span class="token comment" spellcheck="true"># 2. åˆ‡æ¢åˆ†æ”¯</span><span class="token function">git</span> checkout new_branch<span class="token comment" spellcheck="true"># 3. ä¸Šè¿°ä¸¤æ¡å‘½ä»¤ç­‰æ•ˆäºå¦‚ä¸‹å‘½ä»¤ï¼ˆæ–°å»ºæœ¬åœ°åˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ï¼‰</span><span class="token function">git</span> checkout -b new_branch<span class="token comment" spellcheck="true"># 4. åŸºäº master åˆ†æ”¯çš„ä»£ç åˆ›å»ºæ–°åˆ†æ”¯ new_branchï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯</span><span class="token function">git</span> checkout master<span class="token function">git</span> checkout -b new_branch<span class="token comment" spellcheck="true"># 5. åŸºäºè¿œç¨‹åˆ†æ”¯ remote_branch çš„ä»£ç åˆ›å»ºæ–°åˆ†æ”¯ new_branchï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯</span><span class="token comment" spellcheck="true"># æ³•ä¸€ï¼šå…ˆåˆ›å»ºå†æ‹‰å–</span><span class="token function">git</span> checkout -b new_branch<span class="token function">git</span> push origin remote_branch<span class="token comment" spellcheck="true"># æ³•äºŒï¼šä¸Šè¿°ä¸¤æ¡å‘½ä»¤ç­‰æ•ˆäºå¦‚ä¸‹å‘½ä»¤</span><span class="token function">git</span> checkout -b new_branch origin/remote_branch<span class="token comment" spellcheck="true"># 6. è¿œç¨‹ä»“åº“åˆ›å»ºäº†æ–°çš„åˆ†æ”¯ï¼Œä½†æœ¬åœ°ä»“åº“å¹¶æœªåŒæ­¥åˆ°ï¼ˆä½¿ç”¨ git branch -a è·å–ä¸åˆ°æ–°åˆ›å»ºçš„åˆ†æ”¯ï¼‰ï¼Œå¯å…ˆæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç„¶åå°±èƒ½çœ‹åˆ°æ–°çš„åˆ†æ”¯äº†</span><span class="token function">git</span> fetch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æŸ¥çœ‹å…³è”ä¿¡æ¯"><a href="#æŸ¥çœ‹å…³è”ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹å…³è”ä¿¡æ¯"></a>æŸ¥çœ‹å…³è”ä¿¡æ¯</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åˆ†æ”¯çš„å¯¹åº”å…³ç³»ï¼ˆä½¿ç”¨ä¸‹é¢ä¸‰æ¡å‘½ä»¤ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼‰</span><span class="token function">git</span> branch -vv<span class="token function">git</span> remote show origin<span class="token function">cat</span> .git/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æäº¤ä»£ç "><a href="#æäº¤ä»£ç " class="headerlink" title="æäº¤ä»£ç "></a>æäº¤ä»£ç </h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. æäº¤ä»£ç åˆ°æœ¬åœ°ç¼“å†²åŒº</span><span class="token comment" spellcheck="true"># 1.1 é€ä¸ªæ·»åŠ è¢«ä¿®æ”¹çš„æ–‡ä»¶</span><span class="token function">git</span> add file1.java file2.java file3.xml<span class="token comment" spellcheck="true"># 1.2 æ·»åŠ æ‰€æœ‰è¢«ä¿®æ”¹çš„æ–‡ä»¶</span><span class="token function">git</span> add <span class="token keyword">.</span><span class="token comment" spellcheck="true"># 2. æäº¤ä»£ç å¹¶æ·»åŠ ä¿®æ”¹è¯´æ˜</span><span class="token function">git</span> commit -m <span class="token string">'ä¿®æ”¹è¯´æ˜'</span><span class="token comment" spellcheck="true"># 3. ç¡®ä¿å½“å‰åˆ†æ”¯ current_branch ä¸Šçš„ä»£ç æ˜¯æœ€æ–°çš„ï¼Œå³æ‹‰å–æœ€æ–°çš„ä»£ç ï¼ˆå¯çœç•¥è¯¥æ­¥éª¤ï¼Œè‹¥ä¸æ˜¯æœ€æ–°çš„ä»£ç ï¼Œgit ä¼šè¿”å›æç¤ºä¿¡æ¯ï¼‰</span><span class="token function">git</span> pull<span class="token comment" spellcheck="true"># 4. å°†ä»£ç æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯</span><span class="token function">git</span> push origin current_branch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆå¹¶åˆ†æ”¯"><a href="#åˆå¹¶åˆ†æ”¯" class="headerlink" title="åˆå¹¶åˆ†æ”¯"></a>åˆå¹¶åˆ†æ”¯</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># å°†å½“å‰åˆ†æ”¯ current_branch åˆå¹¶åˆ° master</span><span class="token function">git</span> checkout master<span class="token function">git</span> merge current_branch <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="åˆ é™¤åˆ†æ”¯"><a href="#åˆ é™¤åˆ†æ”¯" class="headerlink" title="åˆ é™¤åˆ†æ”¯"></a>åˆ é™¤åˆ†æ”¯</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. åˆ é™¤æœ¬åœ°åˆ†æ”¯ current_branchï¼ˆä¸èƒ½å¤„äºå³å°†è¢«åˆ é™¤çš„åˆ†æ”¯ï¼Œéœ€è¦åˆ‡æ¢åˆ°å…¶å®ƒåˆ†æ”¯ï¼‰</span><span class="token function">git</span> branch -d current_branch<span class="token comment" spellcheck="true"># 2. åˆ é™¤è¿œç¨‹åˆ†æ”¯ remote_branch</span><span class="token function">git</span> push origin -d remote_branch <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ä¿®æ”¹åˆ†æ”¯åç§°"><a href="#ä¿®æ”¹åˆ†æ”¯åç§°" class="headerlink" title="ä¿®æ”¹åˆ†æ”¯åç§°"></a>ä¿®æ”¹åˆ†æ”¯åç§°</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. å°†æœ¬åœ°åˆ†æ”¯ old_branch å’Œè¿œç¨‹åˆ†æ”¯ old_branch çš„åç§°å‡ä¿®æ”¹ä¸º new_branch</span><span class="token comment" spellcheck="true"># 1.1 åˆ‡æ¢åˆ° old_branch åˆ†æ”¯ä¸‹</span><span class="token function">git</span> checkout old_branch<span class="token comment" spellcheck="true"># 1.2 ç¡®ä¿æœ¬åœ°åˆ†æ”¯çš„ä»£ç æ˜¯æœ€æ–°çš„</span><span class="token function">git</span> pull origin old_branch<span class="token comment" spellcheck="true"># 1.3 ä¿®æ”¹æœ¬åœ°åˆ†æ”¯çš„åç§°</span><span class="token function">git</span> branch -m old_branch new_branch<span class="token comment" spellcheck="true"># 1.4 åˆ é™¤è¿œç¨‹åˆ†æ”¯</span><span class="token function">git</span> push origin --d old_branch<span class="token comment" spellcheck="true"># 1.5 å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“</span><span class="token function">git</span> push origin new_branch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://mp.weixin.qq.com/s/swnwBiuyVmhs5iPqv3H6BQ" target="_blank" rel="noopener">Gitæ“ä½œä¸å‘½ä»¤çœ‹è¿™ç¯‡è¶³çŸ£</a></p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·ä½¿ç”¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åç«¯å¼€å‘çŸ¥è¯†ç‚¹åˆé›†</title>
      <link href="/2020/0637666.html"/>
      <url>/2020/0637666.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä»“åº“ç®€ä»‹"><a href="#ä»“åº“ç®€ä»‹" class="headerlink" title="ä»“åº“ç®€ä»‹"></a>ä»“åº“ç®€ä»‹</h2><p>ğŸ“æœ¬äººæ¯•ä¸šäº<a href="https://www.bupt.edu.cn/" target="_blank" rel="noopener">åŒ—äº¬é‚®ç”µå¤§å­¦</a>ä¿¡æ¯ä¸é€šä¿¡å·¥ç¨‹å­¦é™¢ï¼Œç ”äºŒä¸‹åŠå­¦æœŸè‡ªå­¦è½¬ç ï¼Œä½œä¸º â€œåŠè·¯å‡ºå®¶â€ çš„éç§‘ç­ç¨‹åºå‘˜ï¼Œæˆ‘æ·±åˆ‡ä½“ä¼šåˆ°äº†æ‰å®åŸºç¡€çš„é‡è¦æ€§ï¼Œæ•…æ‰“ç®—åˆ©ç”¨ç©ºé—²æ—¶é—´ç»´æŠ¤ä¸€ä¸ª Git ä»“åº“æ¥è®°å½•åç«¯å¼€å‘çš„å¸¸ç”¨çŸ¥è¯†ç‚¹ï¼Œè¯¥ä»“åº“æ¶µç›–äº† Java ç¼–ç¨‹ã€è®¡ç½‘ã€æ“ä½œç³»ç»Ÿã€æ•°æ®åº“ã€æ¡†æ¶ã€ä¸­é—´ä»¶ã€æ•°æ®ç»“æ„ä¸ç®—æ³•ç­‰ç›¸å…³å†…å®¹ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p><h2 id="ä»“åº“åœ°å€"><a href="#ä»“åº“åœ°å€" class="headerlink" title="ä»“åº“åœ°å€"></a>ä»“åº“åœ°å€</h2><p>ğŸ˜æ¬¢è¿è®¿é—®ï¼š<a href="https://JavaerJohn.github.io/" target="_blank" rel="noopener">JohnLearning</a>ğŸ“šã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®€å•çŸ¥è¯†ç‚¹å¤‡å¿˜</title>
      <link href="/2019/0660486.html"/>
      <url>/2019/0660486.html</url>
      
        <content type="html"><![CDATA[<h2 id="å¸¦å®½çš„å•ä½æ˜¯-Hz-è¿˜æ˜¯-bps"><a href="#å¸¦å®½çš„å•ä½æ˜¯-Hz-è¿˜æ˜¯-bps" class="headerlink" title="å¸¦å®½çš„å•ä½æ˜¯ Hz è¿˜æ˜¯ bps"></a>å¸¦å®½çš„å•ä½æ˜¯ Hz è¿˜æ˜¯ bps</h2><p> ä¸¥æ ¼æ¥è®²å¸¦å®½çš„å•ä½ç¡®å®æ˜¯ Hzï¼Œå¸¦å®½æŒ‡çš„æ˜¯ä»‹è´¨èƒ½å¤Ÿä¼ è¾“çš„ä¿¡å·çš„é¢‘å¸¦èŒƒå›´ï¼Œæ‰€ä»¥å…¶å•ä½ä¸ºèµ«å…¹ï¼ˆHzï¼‰ï¼ŒHz é€šå¸¸åœ¨æ¨¡æ‹Ÿé€šä¿¡ç³»ç»Ÿä¸­ï¼ˆä¼ è¾“æ³¢å½¢ä¿¡å·ï¼‰ä½¿ç”¨ã€‚å®é™…åº”ç”¨ä¸­ï¼Œä»‹è´¨çš„å¸¦å®½å€¼å’Œå•ä½æ—¶é—´å†…ä¼ è¾“çš„æ•°æ®é‡ï¼ˆå³é€Ÿç‡ï¼Œbpsï¼‰æ˜¯æœ‰ä¸€å®šæ¯”ä¾‹å…³ç³»çš„ï¼Œå°±åƒé©¬è·¯çš„å®½åº¦å’Œé€šè¿‡çš„è½¦çš„æ•°é‡æœ‰å…³ç³»ä¸€æ ·ï¼Œbps é€šå¸¸åœ¨æ•°å­—é€šä¿¡ç³»ç»Ÿä¸­ï¼ˆä¼ è¾“æ•°å­—ä¿¡å·ï¼‰ä½¿ç”¨ã€‚å¦å¤–ï¼Œç°åœ¨çš„æ¨¡æ‹Ÿç³»ç»Ÿé€šè¿‡è°ƒåˆ¶æŠ€æœ¯ä¹Ÿå¯ä»¥ä¼ è¾“æ•°å­—ä¿¡å·ï¼Œå› æ­¤ç°åœ¨åŸºæœ¬ä¸Šéƒ½æ˜¯ç”¨ bps æ¥æè¿°å¸¦å®½ï¼Œä»¥æ­¤æ¥è¡¨æ˜ä¿¡é“çš„æ•°æ®çš„ä¼ è¾“èƒ½åŠ›ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç«¯ </tag>
            
            <tag> çŸ¥è¯†ç‚¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠ¨æ€è§„åˆ’ç®—æ³•é¢˜è§£</title>
      <link href="/2019/0663066.html"/>
      <url>/2019/0663066.html</url>
      
        <content type="html"><![CDATA[<h2 id="926-å°†å­—ç¬¦ä¸²ç¿»è½¬åˆ°å•è°ƒé€’å¢ï¼ˆMediumï¼‰"><a href="#926-å°†å­—ç¬¦ä¸²ç¿»è½¬åˆ°å•è°ƒé€’å¢ï¼ˆMediumï¼‰" class="headerlink" title="926. å°†å­—ç¬¦ä¸²ç¿»è½¬åˆ°å•è°ƒé€’å¢ï¼ˆMediumï¼‰"></a>926. å°†å­—ç¬¦ä¸²ç¿»è½¬åˆ°å•è°ƒé€’å¢ï¼ˆMediumï¼‰</h2><p><a href="https://leetcode.com/problems/flip-string-to-monotone-increasing/" target="_blank" rel="noopener">Leetcode</a> / <a href="https://leetcode.cn/problems/flip-string-to-monotone-increasing/" target="_blank" rel="noopener">åŠ›æ‰£</a></p><p>é¢˜ç›®æè¿°ï¼šå¦‚æœä¸€ä¸ªäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œæ˜¯ä»¥ä¸€äº› <code>0</code>ï¼ˆå¯èƒ½æ²¡æœ‰ <code>0</code>ï¼‰åé¢è·Ÿç€ä¸€äº› <code>1</code>ï¼ˆä¹Ÿå¯èƒ½æ²¡æœ‰ <code>1</code>ï¼‰çš„å½¢å¼ç»„æˆçš„ï¼Œé‚£ä¹ˆè¯¥å­—ç¬¦ä¸²æ˜¯ <code>å•è°ƒé€’å¢</code> çš„ã€‚ç»™ä½ ä¸€ä¸ªäºŒè¿›åˆ¶å­—ç¬¦ä¸² <code>s</code>ï¼Œä½ å¯ä»¥å°†ä»»ä½• <code>0</code> ç¿»è½¬ä¸º <code>1</code> æˆ–è€…å°† <code>1</code> ç¿»è½¬ä¸º <code>0</code>ï¼Œè¿”å›ä½¿ <code>s</code> å•è°ƒé€’å¢çš„æœ€å°ç¿»è½¬æ¬¡æ•°ã€‚</p><pre class="line-numbers language-html"><code class="language-html">Inputï¼šs = "00110"Outputï¼š1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è§£æ³•ä¸€ï¼ˆæ¨¡æ‹Ÿï¼‰ï¼šå‡è®¾ä¸‹æ ‡ <code>i</code> ä¸ºé€’å¢å­—ç¬¦ä¸²ä¸­å­—ç¬¦ <code>0</code> å’Œå­—ç¬¦ <code>1</code> çš„åˆ†ç•Œçº¿ï¼Œå³ä¸‹æ ‡ä½äº <code>[0, i - 1]</code> çš„æ‰€æœ‰å­—ç¬¦å‡ä¸º <code>0</code>ï¼Œä¹‹åçš„æ‰€æœ‰å­—ç¬¦å‡ä¸º <code>1</code>ï¼Œ<code>i</code> å¯èƒ½æ˜¯ <code>0</code> åˆ° <code>s.length() - 1</code> çš„ä»»ä½•å€¼ã€‚åœ¨å­—ç¬¦ä¸² <code>s</code> ä¸­ï¼Œè®¡ç®—ä»ä¸‹æ ‡ <code>0</code> åˆ°ä¸‹æ ‡ <code>i - 1</code> çš„æ‰€æœ‰å­—ç¬¦ <code>0</code> çš„ä¸ªæ•°ï¼Œè®°ä¸º <code>count0</code>ï¼›è®¡ç®—ä»ä¸‹æ ‡ <code>i</code> åˆ°ä¸‹æ ‡ <code>s.length() - 1</code> çš„æ‰€æœ‰å­—ç¬¦ <code>1</code> çš„ä¸ªæ•°ï¼Œè®°ä¸º <code>count1</code>ã€‚<code>s.length() - count0 - count1</code> å°±æ˜¯éœ€è¦ç¿»è½¬çš„æ¬¡æ•°ï¼Œé€šè¿‡æ¯”è¾ƒ <code>i</code> å–ä¸åŒå€¼æ—¶çš„æ¬¡æ•°ä¾¿å¯å¾—å‡ºç­”æ¡ˆã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">minFlipsMonoIncr</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> chars<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> countsZero <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> countsOne <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> count0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>chars<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            count0<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>chars<span class="token punctuation">[</span>n <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            count1<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        countsZero<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> count0<span class="token punctuation">;</span>        countsOne<span class="token punctuation">[</span>n <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> count1<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> ans <span class="token operator">=</span> n<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ans <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> n <span class="token operator">-</span> countsZero<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> countsOne<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> ans<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ—¶é—´å¤æ‚åº¦ï¼š<code>O(n)</code>ï¼Œç©ºé—´å¤æ‚åº¦ï¼š<code>O(n)</code>ã€‚</p><p>è§£æ³•äºŒï¼ˆåŠ¨æ€è§„åˆ’ï¼‰ï¼šä»¤ <code>dp[i]</code> è¡¨ç¤ºå°†å­ä¸² <code>s[0 : i]</code>è½¬åŒ–ä¸ºé€’å¢å­ä¸²æ‰€éœ€çš„ç¿»è½¬æ¬¡æ•°ï¼Œå¦‚æœ <code>s[i]</code> ä¸º <code>1</code>ï¼Œé‚£ä¹ˆè¯¥å­—ç¬¦ä¸ä¼šå½±å“ç¿»è½¬æ¬¡æ•°ï¼Œå³ <code>dp[i] = dp[i - 1]</code>ã€‚è‹¥ <code>s[i]</code> ä¸º <code>0</code>ï¼Œåˆ™éœ€è¦åˆ†ä¸¤ç§æƒ…å†µï¼š</p><ol><li><p>å°† <code>s[i]</code> ç”± <code>0</code> ç¿»è½¬åˆ° <code>1</code>ã€‚</p></li><li><p>å°†å­ä¸² <code>s[0 : i - 1]</code> ä¸­çš„æ‰€æœ‰ <code>1</code> ç¿»è½¬åˆ° <code>0</code>ã€‚</p></li></ol><p><code>dp[i]</code> ä¸ºä¸¤ç§æƒ…å†µå–è¾ƒå°å€¼ï¼Œæ•…æœ‰ <code>dp[i] = min{dp[i - 1] + 1, oneCount}</code>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è®°å½•å­—ç¬¦ <code>1</code> çš„æ•°é‡ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">minFlipsMonoIncr</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> dp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token operator">++</span>cnt<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            dp <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>dp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> dp<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ—¶é—´å¤æ‚åº¦ï¼š<code>O(n)</code>ï¼Œç©ºé—´å¤æ‚åº¦ï¼š<code>O(1)</code>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
