<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Java 语言实现简易版扫码登录, 每天进步一点点！">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="基本介绍相信大家对二维码都不陌生，生活中到处充斥着扫码登录的场景，如登录网页版微信、支付宝等。最近学习了一下扫码登录的原理，感觉蛮有趣的，于是自己实现了一个简易版扫码登录的 Demo，以此记录一下学习过程。

实际上是面试的时候被问到了 ￣">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Java 语言实现简易版扫码登录 | John&#39;s Blog</title>

    <!-- <link rel="icon" href="#">  --> 
    <link rel="icon" type="image/png" href="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/hexo/favicon.png">


    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?4d1d73af45a62734730491a6b6c41da4";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
   </script>


  
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

    <meta name="baidu-site-verification" content>




<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">John's Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fas fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fas fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fas fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fas fa-user-circle"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fas fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fas fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">John's Blog</div>
        <div class="logo-desc">
            
            一名正在努力的程序员
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fas fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fas fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fas fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fas fa-user-circle"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fas fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fas fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JavaerJohn" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JavaerJohn" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<!-- <div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/59.jpg')"> -->
<div class="bg-cover pd-header post-cover">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="center-align post-title">
                        Java 语言实现简易版扫码登录
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/后端/" target="_blank">
                            <span class="chip bg-color">后端</span>
                        </a>
                        
                        <a href="/tags/Java/" target="_blank">
                            <span class="chip bg-color">Java</span>
                        </a>
                        
                        <a href="/tags/Spring-Boot/" target="_blank">
                            <span class="chip bg-color">Spring Boot</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/系统设计/" class="post-category" target="_blank">
                            系统设计
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-10
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    John同学
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    20 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>相信大家对二维码都不陌生，生活中到处充斥着扫码登录的场景，如登录网页版微信、支付宝等。最近学习了一下扫码登录的原理，感觉蛮有趣的，于是自己实现了一个简易版扫码登录的 Demo，以此记录一下学习过程。</p>
<blockquote>
<p>实际上是面试的时候被问到了 ￣△￣！</p>
</blockquote>
<h2 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h2><p><strong>1. 身份认证机制</strong></p>
<p>在介绍扫码登录的原理之前，我们先聊一聊服务端的身份认证机制。以普通的 <code>账号 + 密码</code> 登录方式为例，服务端收到用户的登录请求后，首先验证账号、密码的合法性。如果验证通过，那么服务端会为用户分配一个 token，该 token 与用户的身份信息相关联，可作为用户的登录凭证。之后 PC 端再次发送请求时，需要在请求的 Header 或者 Query 参数中携带 token，服务端根据 token 便可识别出当前用户。token 的优点是更加方便、安全，它降低了账号密码被劫持的风险，而且用户不需要重复地输入账号和密码。PC 端通过账号和密码登录的过程如下：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/PC%E7%AB%AF%E9%AA%8C%E8%AF%81.jpg" alt></p>
<p>扫码登录本质上也是一种身份认证方式，<code>账号 + 密码</code> 登录与扫码登录的区别在于，前者是利用 PC 端的账号和密码为 PC 端申请一个 token，后者是利用 <code>手机端的 token + 设备信息</code> 为 PC 端申请一个 token。这两种登录方式的目的相同，都是为了使 PC 端获得服务端的 “授权”，在为 PC 端申请 token 之前，二者都需要向服务端证明自己的身份，也就是必须让服务端知道当前用户是谁，这样服务端才能为其生成 PC 端 token。由于扫码前手机端一定是处于已登录状态的，因此手机端本身已经保存了一个 token，该 token 可用于服务端的身份识别。那么为什么手机端在验证身份时还需要设备信息呢？实际上，手机端的身份认证和 PC 端略有不同：</p>
<ol>
<li><p>手机端在登录前也需要输入账号和密码，但登录请求中除了账号密码外还包含着设备信息，例如设备类型、设备 id 等。</p>
</li>
<li><p>接收到登录请求后，服务端会验证账号和密码，验证通过后，将用户信息与设备信息关联起来，也就是将它们存储在一个数据结构 structure 中。</p>
</li>
<li><p>服务端为手机端生成一个 token，并将 token 与用户信息、设备信息关联起来，即以 token 为 key，structure 为 value，将该键值对持久化保存到本地，之后将 token 返回给手机端。</p>
</li>
<li><p>手机端发送请求，携带 token 和设备信息，服务端根据 token 查询出 structure，并验证 structure 中的设备信息和手机端的设备信息是否相同，以此判断用户的有效性。</p>
</li>
</ol>
<p>我们在 PC 端登录成功后，可以短时间内正常浏览网页，但之后访问网站时就要重新登陆了，这是因为 token 是有过期时间的，较长的有效时间会增大 token 被劫持的风险。但是，手机端好像很少有这种问题，例如微信登录成功后可以一直使用，即使关闭微信或重启手机。这是因为设备信息具有唯一性，即使 token 被劫持了，由于设备信息不同，攻击者也无法向服务端证明自己的身份，这样大大提高了安全系数，因此 token 可以长久使用。手机端通过账号密码登录的过程如下：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E6%89%8B%E6%9C%BA%E7%AB%AF%E9%AA%8C%E8%AF%81.jpg" alt></p>
<p><strong>2. 流程概述</strong></p>
<p>了解了服务端的身份认证机制后，我们再聊一聊扫码登录的整个流程。以网页版微信为例，我们在 PC 端点击二维码登录后，浏览器页面会弹出二维码图片，此时打开手机微信扫描二维码，PC 端随即显示 “正在扫码”，手机端点击确认登录后，PC 端就会显示 “登陆成功” 了。</p>
<p>上述过程中，服务端可以根据手机端的操作来响应 PC 端，那么服务端是如何将二者关联起来的呢？答案就是通过 “二维码”，严格来说是通过二维码中的内容。使用二维码解码器扫描网页版微信的二维码，可以得到如下内容：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E4%BA%8C%E7%BB%B4%E7%A0%81%E8%A7%A3%E7%A0%81.png" alt></p>
<p>由上图我们得知，二维码中包含的其实是一个网址，手机扫描二维码后，会根据该网址向服务端发送请求。接着，我们打开 PC 端浏览器的开发者工具：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E5%BE%AE%E4%BF%A1%E8%BD%AE%E8%AF%A2.png" alt></p>
<p>可见，在显示出二维码之后，PC 端一直都没有 “闲着”，它通过轮询的方式不断向服务端发送请求，以获知手机端操作的结果。这里我们注意到，PC 端发送的 URL 中有一个参数 uuid，值为 “Adv-NP1FYw==”，该 uuid 也存在于二维码包含的网址中。由此我们可以推断，服务端在生成二维码之前会先生成一个二维码 id，二维码 id 与二维码的状态、过期时间等信息绑定在一起，一同存储在服务端。手机端可以根据二维码 id 操作服务端二维码的状态，PC 端可以根据二维码 id 向服务端询问二维码的状态。</p>
<p>二维码最初为 “待扫描” 状态，手机端扫码后服务端将其状态改为 “待确认” 状态，此时 PC 端的轮询请求到达，服务端向其返回 “待确认” 的响应。手机端确认登录后，二维码变成 “已确认” 状态，服务端为 PC 端生成用于身份认证的 token，PC 端再次询问时，就可以得到这个 token。整个扫码登录的流程如下图所示：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt></p>
<ol>
<li><p>PC 端发送 “扫码登录” 请求，服务端生成二维码 id，并存储二维码的过期时间、状态等信息。</p>
</li>
<li><p>PC 端获取二维码并显示。</p>
</li>
<li><p>PC 端开始轮询检查二维码的状态，二维码最初为 “待扫描” 状态。</p>
</li>
<li><p>手机端扫描二维码，获取二维码 id。</p>
</li>
<li><p>手机端向服务端发送 “扫码” 请求，请求中携带二维码 id、手机端 token 以及设备信息。</p>
</li>
<li><p>服务端验证手机端用户的合法性，验证通过后将二维码状态置为 “待确认”，并将用户信息与二维码关联在一起，之后为手机端生成一个一次性 token，该 token 用作确认登录的凭证。</p>
</li>
<li><p>PC 端轮询时检测到二维码状态为 “待确认”。</p>
</li>
<li><p>手机端向服务端发送 “确认登录” 请求，请求中携带着二维码 id、一次性 token 以及设备信息。</p>
</li>
<li><p>服务端验证一次性 token，验证通过后将二维码状态置为 “已确认”，并为 PC 端生成 PC 端 token。</p>
</li>
<li><p>PC 端轮询时检测到二维码状态为 “已确认”，并获取到了 PC 端 token，之后 PC 端不再轮询。</p>
</li>
<li><p>PC 端通过 PC 端 token 访问服务端。</p>
</li>
</ol>
<p>上述过程中，我们注意到，手机端扫码后服务端会返回一个一次性 token，该 token 也是一种身份凭证，但它只能使用一次。一次性 token 的作用是确保 “扫码请求” 与 “确认登录” 请求由同一个手机端发出，也就是说，手机端用户不能 “帮其他用户确认登录”。</p>
<blockquote>
<p>关于一次性 token 的知识本人也不是很了解，但可以推测，在服务端的缓存中，一次性 token 映射的 value 应该包含 “扫码” 请求传入的二维码信息、设备信息以及用户信息。</p>
</blockquote>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p><strong>1. 环境准备</strong></p>
<ul>
<li><p>JDK 1.8：项目使用 Java 语言编写。</p>
</li>
<li><p>Maven：依赖管理。</p>
</li>
<li><p>Redis：Redis 既作为数据库存储用户的身份信息（为了简化操作未使用 MySQL），也作为缓存存储二维码信息、token 信息等。</p>
</li>
</ul>
<p><strong>2. 主要依赖</strong></p>
<ul>
<li><p>SpringBoot：项目基本环境。</p>
</li>
<li><p>Hutool：开源工具类，其中的 QrCodeUtil 可用于生成二维码图片。</p>
</li>
<li><p>Thymeleaf：模板引擎，用于页面渲染。</p>
</li>
</ul>
<p><strong>3. 生成二维码</strong></p>
<p>二维码的生成以及二维码状态的保存逻辑如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/getQrCodeImg"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token keyword">public</span> String <span class="token function">createQrCodeImg</span><span class="token punctuation">(</span>Model model<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   String uuid <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">createQrImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   String qrCode <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>QrCodeUtil<span class="token punctuation">.</span><span class="token function">generatePng</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8080/login/uuid="</span> <span class="token operator">+</span> uuid<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"QrCode"</span><span class="token punctuation">,</span> qrCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PC 端访问 “登录” 请求时，服务端调用 createQrImg 方法，生成一个 uuid 和一个 LoginTicket 对象，LoginTicket 对象中封装了用户的 userId 和二维码的状态。然后服务端将 uuid 作为 key，LoginTicket 对象作为 value 存入到 Redis 服务器中，并设置有效时间为 5 分钟（二维码的有效时间），createQrImg 方法的逻辑如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">createQrImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// uuid</span>
   String uuid <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   LoginTicket loginTicket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">// 二维码最初为 WAITING 状态</span>
   loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>QrCodeStatusEnum<span class="token punctuation">.</span>WAITING<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true">// 存入 redis</span>
   String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">,</span> loginTicket<span class="token punctuation">,</span> LoginConstant<span class="token punctuation">.</span>WAIT_EXPIRED_SECONDS<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> uuid<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们在前一节中提到，手机端的操作主要影响二维码的状态，PC 端轮询时也是查看二维码的状态，那么为什么还要在 LoginTicket 对象中封装 userId 呢？这样做是为了将二维码与用户进行关联，想象一下我们登录网页版微信的场景，手机端扫码后，PC 端就会显示用户的头像，虽然手机端并未确认登录，但 PC 端轮询时已经获取到了当前扫码的用户（仅头像信息）。因此手机端扫码后，需要将二维码与用户绑定在一起，使用 LoginTicket 对象只是一种实现方式。二维码生成后，我们将其状态置为 “待扫描” 状态，userId 不做处理，默认为 null。</p>
<p><strong>4. 扫描二维码</strong></p>
<p>手机端发送 “扫码” 请求时，Query 参数中携带着 uuid，服务端接收到请求后，调用 scanQrCodeImg 方法，根据 uuid 查询出二维码并将其状态置为 “待确认” 状态，操作完成后服务端向手机端返回 “扫码成功” 或 “二维码已失效” 的信息：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/scan"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> Response <span class="token function">scanQrCodeImg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   JSONObject data <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">scanQrCodeImg</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"valid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createResponse</span><span class="token punctuation">(</span><span class="token string">"扫码成功"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createErrorResponse</span><span class="token punctuation">(</span><span class="token string">"二维码已失效"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>scanQrCodeImg 方法的主要逻辑如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> JSONObject <span class="token function">scanQrCodeImg</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// 避免多个移动端同时扫描同一个二维码</span>
   lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   JSONObject data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      LoginTicket loginTicket <span class="token operator">=</span> <span class="token punctuation">(</span>LoginTicket<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// redis 中 key 过期后也可能不会立即删除</span>
      Long expired <span class="token operator">=</span> cacheStore<span class="token punctuation">.</span><span class="token function">getExpireForSeconds</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> valid <span class="token operator">=</span> loginTicket <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
               QrCodeStatusEnum<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>WAITING <span class="token operator">&amp;&amp;</span>
               expired <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
               expired <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            User user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户未登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 修改扫码状态</span>
            loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>QrCodeStatusEnum<span class="token punctuation">.</span>SCANNED<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Condition condition <span class="token operator">=</span> CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 将二维码与用户进行关联</span>
            loginTicket<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">,</span> loginTicket<span class="token punctuation">,</span> expired<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 生成一次性 token, 用于之后的确认请求</span>
            String onceToken <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildOnceTokenKey</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> LoginConstant<span class="token punctuation">.</span>ONCE_TOKEN_EXPIRE_TIME<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"once_token"</span><span class="token punctuation">,</span> onceToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"valid"</span><span class="token punctuation">,</span> valid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> data<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li><p>首先根据 uuid 查询 Redis 中存储的 LoginTicket 对象，然后检查二维码的状态是否为 “待扫描” 状态，如果是，那么将二维码的状态改为 “待确认” 状态。如果不是，那么该二维码已被扫描过，服务端提示用户 “二维码已失效”。我们规定，只允许第一个手机端能够扫描成功，加锁的目的是为了保证 <code>查询 + 修改</code> 操作的原子性，避免两个手机端同时扫码，且同时检测到二维码的状态为 “待扫描”。 </p>
</li>
<li><p>上一步操作成功后，服务端将 LoginTicket 对象中的 userId 置为当前用户（扫码用户）的 userId，也就是将二维码与用户信息绑定在一起。由于<strong>扫码请求是由手机端发送的</strong>，因此该请求一定来自于一个有效的用户，我们在项目中配置一个拦截器（也可以是过滤器），当拦截到 “扫码” 请求后，根据请求中的 token（手机端发送请求时一定会携带 token）查询出用户信息，并将其存储到 ThreadLocal 容器（hostHolder）中，之后绑定信息时就可以从 ThreadLocal 容器将用户信息提取出来。注意，这里的 token 指的手机端 token，实际中应该还有设备信息，但为了简化操作，我们忽略掉设备信息。</p>
</li>
<li><p>用户信息与二维码信息关联在一起后，服务端为手机端生成一个一次性 token，并存储到 Redis 服务器，其中 key 为一次性 token 的值，value 为 uuid。一次性 token 会返回给手机端，作为 “确认登录” 请求的凭证。</p>
</li>
</ol>
<!-- 用户下次发送 "确认登录" 的请求时，需要携带一次性 token，拦截器拦截到 `/login/confirm` 请求后，检查一次性 token 对应的 uuid 与 Query 参数中的 uuid 是否相同，以确保扫码和确认操作来自于同一个手机端。 -->


<!-- 关于一次性 token 的知识我也不太了解，一次性 token 对应的 value 应该设置成什么我也不清楚，这里选择将 uuid 作为 value，是为了确保 "扫码" 请求与 "确认登录" 请求来自于同一个手机端。 -->



<!-- 4. 请求的 URI（包含请求的参数信息，例如 /login/confirm?uuid=uuid）。-->

<!-- 用户下次发送 "确认登录" 的请求时需要携带一次性 token -->

<!-- 一次性 token 用作确认登录的凭证   -->

<p>上述代码中，当二维码的状态被修改后，我们唤醒了在 condition 中阻塞的线程，这一步的目的是为了实现长轮询操作，下文中会介绍长轮询的设计思路。</p>
<p><strong>5. 确认登录</strong></p>
<p>手机端发送 “确认登录” 请求时，Query 参数中携带着 uuid，且 Header 中携带着一次性 token，服务端接收到请求后，首先验证一次性 token 的有效性，即检查一次性 token 对应的 uuid 与 Query 参数中的 uuid 是否相同，以确保扫码操作和确认操作来自于同一个手机端，该验证过程可在拦截器中配置。验证通过后，服务端调用 confirmLogin 方法，将二维码的状态置为 “已确认”：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/confirm"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> Response <span class="token function">confirmLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">boolean</span> logged <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">confirmLogin</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   String msg <span class="token operator">=</span> logged <span class="token operator">?</span> <span class="token string">"登录成功!"</span> <span class="token operator">:</span> <span class="token string">"二维码已失效!"</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createResponse</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> logged<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>confirmLogin 方法的主要逻辑如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">confirmLogin</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   LoginTicket loginTicket <span class="token operator">=</span> <span class="token punctuation">(</span>LoginTicket<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> logged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   Long expired <span class="token operator">=</span> cacheStore<span class="token punctuation">.</span><span class="token function">getExpireForSeconds</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket <span class="token operator">==</span> null <span class="token operator">||</span> expired <span class="token operator">==</span> null <span class="token operator">||</span> expired <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
            loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>QrCodeStatusEnum<span class="token punctuation">.</span>CONFIRMED<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Condition condition <span class="token operator">=</span> CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">,</span> loginTicket<span class="token punctuation">,</span> expired<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> logged<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法会根据 uuid 查询二维码是否已经过期，如果未过期，那么就修改二维码的状态。</p>
<p><strong>6. PC 端轮询</strong></p>
<p>轮询操作指的是前端重复多次向后端发送相同的请求，以获知数据的变化。轮询分为长轮询和短轮询：</p>
<ul>
<li><p>长轮询：服务端收到请求后，如果有数据，那么就立即返回，否则线程进入等待状态，直到有数据到达或超时，浏览器收到响应后立即重新发送相同的请求。</p>
</li>
<li><p>短轮询：服务端收到请求后无论是否有数据都立即返回，浏览器收到响应后间隔一段时间后重新发送相同的请求。</p>
</li>
</ul>
<p>由于长轮询相比短轮询能够得到实时的响应，且更加节约资源，因此项目中我们考虑使用 ReentrantLock 来实现长轮询。轮询的目的是为了查看二维码状态的变化：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/getQrCodeStatus"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> Response <span class="token function">getQrCodeStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String uuid<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
   JSONObject data <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">getQrCodeStatus</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">createResponse</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>getQrCodeStatus 方法的主要逻辑如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> JSONObject <span class="token function">getQrCodeStatus</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">,</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
   lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      JSONObject data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      String ticketKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildTicketKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      LoginTicket loginTicket <span class="token operator">=</span> <span class="token punctuation">(</span>LoginTicket<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

      QrCodeStatusEnum statusEnum <span class="token operator">=</span> loginTicket <span class="token operator">==</span> null <span class="token operator">||</span> QrCodeStatusEnum<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>INVALID <span class="token operator">?</span>
               QrCodeStatusEnum<span class="token punctuation">.</span>INVALID <span class="token operator">:</span> QrCodeStatusEnum<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStatus <span class="token operator">==</span> statusEnum<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Condition condition <span class="token operator">=</span> CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               CONDITION_CONTAINER<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>LoginConstant<span class="token punctuation">.</span>POLL_WAIT_TIME<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">// 用户扫码后向 PC 端返回头像信息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statusEnum <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>SCANNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"avatar"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// 用户确认后为 PC 端生成 access_token</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statusEnum <span class="token operator">==</span> QrCodeStatusEnum<span class="token punctuation">.</span>CONFIRMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String accessToken <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildAccessTokenKey</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">,</span> loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LoginConstant<span class="token punctuation">.</span>ACCESS_TOKEN_EXPIRE_TIME<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span> statusEnum<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> statusEnum<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> data<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法接收两个参数，即 uuid 和 currentStatus，其中 uuid 用于查询二维码，currentStatus 用于确认二维码状态是否发生了变化，如果是，那么需要立即向 PC 端反馈。我们规定 PC 端在轮询时，请求的参数中需要携带二维码当前的状态。</p>
<ol>
<li><p>首先根据 uuid 查询出二维码的最新状态，并比较其是否与 currentStatus 相同。如果相同，那么当前线程进入阻塞状态，直到被唤醒或者超时。</p>
</li>
<li><p>如果二维码状态为 “待确认”，那么服务端向 PC 端返回扫码用户的头像信息（处于 “待确认” 状态时，二维码已与用户信息绑定在一起，因此可以查询出用户的头像）。</p>
</li>
<li><p>如果二维码状态为 “已确认”，那么服务端为 PC 端生成一个 token，在之后的请求中，PC 端可通过该 token 表明自己的身份。</p>
</li>
</ol>
<p>上述代码中的加锁操作是为了能够令当前处理请求的线程进入阻塞状态，当二维码的状态发生变化时，我们再将其唤醒，因此上文中的扫码操作和确认登录操作完成后，还会有一个唤醒线程的过程。</p>
<!-- >加锁可以确保二维码状态改变后，PC 端可以立即得到通知。因为加锁操作在查询操作之前，也就是说，二维码状态的修改和查询是串行执行的，这里的查询不仅包含从 Redis 中获取 LoginTicket，还包括比较二维码状态的比较。如果先修改再查，那么查询时可以发现二维码的最新状态发生了改变，线程就不会进入阻塞。如果先查再修改，那么线程会进入阻塞，但二维码状态修改完成后，线程也可以立即被唤醒。如果加锁操作在查询操作之后，那么查询操作查出来的二维码状态可能不是最新的，因为扫码或确认操作可能在查询结束后立即修改二维码的状态，这样 PC 端就不会得到及时响应。 -->

<p>实际上，加锁操作设计得不太合理，因为我们只设置了一把锁。因此对不同二维码的查询或修改操作都会抢占同一把锁。按理来说，不同二维码的操作之间应该是相互独立的，即使加锁，也应该是为每个二维码均配一把锁，但这样做代码会更加复杂，或许有其它更好的实现长轮询的方式？或者干脆直接短轮询。当然，也可以使用 WebSocket 实现长连接。</p>
<p><strong>7. 拦截器配置</strong></p>
<p>项目中配置了两个拦截器，一个用于确认用户的身份，即验证 token 是否有效：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> HostHolder hostHolder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> CacheStore cacheStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

        String accessToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// access_token 存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String userId <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildAccessTokenKey</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hostHolder<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> Exception ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        hostHolder<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果 token 有效，那么服务端根据 token 获取用户的信息，并将用户信息存储到 ThreadLocal 容器。手机端和 PC 端的请求都由该拦截器处理，如 PC 端的 “查询用户信息” 请求，手机端的 “扫码” 请求。由于我们忽略了手机端验证时所需要的的设备信息，因此 PC 端和手机端 token 可以使用同一套验证逻辑。</p>
<p>另一个拦截器用于拦截 “确认登录” 请求，即验证一次性 token 是否有效：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> CacheStore cacheStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        String onceToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"once_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNoneEmpty</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String onceTokenKey <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">buildOnceTokenKey</span><span class="token punctuation">(</span>onceToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String uuidFromCache <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> cacheStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>onceTokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String uuidFromRequest <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidFromCache<span class="token punctuation">,</span> uuidFromRequest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"非法的一次性 token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 一次性 token 检查完成后将其删除</span>
            cacheStore<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>onceTokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该拦截器主要拦截 “确认登录” 请求，需要注意的是，一次性 token 验证通过后要立即将其删除。</p>
<blockquote>
<p>编码过程中，我们简化了许多操作，例如：1. 忽略掉了手机端的设备信息；2. 手机端确认登录后并没有直接为用户生成 PC 端 token，而是在轮询时生成。</p>
</blockquote>
<h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><p><strong>1. 工具准备</strong></p>
<ul>
<li><p>浏览器：PC 端操作</p>
</li>
<li><p>Postman：模仿手机端操作。</p>
</li>
</ul>
<p><strong>2. 数据准备</strong></p>
<p>由于我们没有实现真实的手机端扫码的功能，因此使用 Postman 模仿手机端向服务端发送请求。首先我们需要确保服务端存储着用户的信息，即在 Test 类中执行如下代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   user<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"John同学"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   user<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span><span class="token string">"/avatar.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user:1"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>手机端发送请求时需要携带手机端 token，这里我们为 useId 为 “1” 的用户生成一个 token（手机端 token）：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">loginByPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   String accessToken <span class="token operator">=</span> CommonUtil<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
   cacheStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CommonUtil<span class="token punctuation">.</span><span class="token function">buildAccessTokenKey</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>手机端 token（accessToken）为 “aae466837d0246d486f644a3bcfaa9e1”（随机值），之后发送 “扫码” 请求时需要携带这个 token。</p>
<p><strong>3. 扫码登录流程展示</strong></p>
<p>启动项目，访问 <code>localhost:8080/index</code>：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/index.jpg" alt></p>
<p>点击登录，并在开发者工具中找到二维码 id（uuid）：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/uuid.jpg" alt></p>
<p>打开 Postman，发送 <code>localhost:8080/login/scan</code> 请求，Query 参数中携带 uuid，Header 中携带手机端 token：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E6%89%AB%E7%A0%81%E8%AF%B7%E6%B1%82.jpg" alt></p>
<p>上述请求返回 “扫码成功” 的响应，同时还返回了一次性 token。此时 PC 端显示出扫码用户的头像：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E5%BE%85%E7%A1%AE%E8%AE%A4.jpg" alt></p>
<p>在 Postman 中发送 <code>localhost:8080/login/confirm</code> 请求，Query 参数中携带 uuid，Header 中携带一次性 token：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E7%A1%AE%E8%AE%A4%E8%AF%B7%E6%B1%82.jpg" alt></p>
<p>“确认登录” 请求发送完成后，PC 端随即获取到 PC 端 token，并成功查询用户信息：</p>
<p><img src="https://johnlearning.oss-cn-beijing.aliyuncs.com/blog/demo/loginByQrCode/%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F.jpg" alt></p>
<p><strong>结语</strong></p>
<p>本文主要介绍了扫码登录的原理，并实现了一个简易版扫码登录的 Demo。关于原理部分的理解错误以及代码中的不足之处欢迎大家批评指正（⌒.－），源码见<a href="https://github.com/JavaerJohn/loginByQrCode" target="_blank" rel="noopener">扫码登录</a>，如果觉得有收获的话给个 Star 吧~。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://juejin.cn/post/6940976355097985032#heading-1" target="_blank" rel="noopener">二维码扫码登录是什么原理 </a><br><a href="https://juejin.cn/post/6844904111398191117?utm_source=gold_browser_extension" target="_blank" rel="noopener">聊一聊二维码扫描登录原理 </a></p>
<!-- ### 流程简述

1. PC 端打开二维码登录页面 login.html;

2. login.html 调用后端接口 createQrCodeImg，该接口生成一个随机的 uuid，uuid 可看做是本页面的唯一标识，同时该接口还会创建一个 LoginTicket 对象，该对象中封装了如下信息：

   - uuid：页面的唯一标识；

   - userId：用户 id；

   - status：扫码状态，0 表示等待扫码，1 表示等待确认，2 表示已确认。 

3. 将上述 uuid 作为 key、LoginTicket 对象作为 value 存储在 Redis 服务器中（或其他数据库），设置其过期时间为 5 分钟，表示 5 分钟后二维码失效。
4. 生成二维码图片，二维码中封装的信息为一个 URL，类似于 `http://localhost:8080/login/scan/uuid=1be1cf4a5ceb4d73a8f2104ffe5fba0c`。
5. PC 端显示二维码； 
6. PC 端页面不断轮询（多久轮询一次自行设置）检查扫码的进度，即 LoginTicket 对象的状态。如果为 0 或为 1，继续轮询；如果为 2，停止轮询（已确认登录）；
7. 手机端扫描二维码；
8. 手机端（携带用户的 token，该 token 为手机端 token）访问二维码中的目标网址，手机端服务器首先验证 token 是否有效，如果有效则将 LoginTicket 对象的 status 更新为 1；
9. 手机端服务器询问用户是否确认登录；
10. 用户选择确认登录，手机端服务器将 LoginTicket 对象的 status 更新为 2，并将 userId 设置为当前用户的 id；
11. PC 端检测到用户确认登录后，为用户生成 token（此 token 为 PC 端的 token），并将 token 返回给前端；
12. 前端获取到 token 后就可以执行其他操作。

### 流程图
总体流程如下：
![扫码登录流程图](./QrCodeLogin.jpg) -->

<!-- ## 实现 -->

<!-- ### 环境准备
1. JDK 1.8；
2. maven 3.3.6；
3. Springboot 2.xx；
4. Redis。

### 实体对象
LoginTicket 类定义如下：
```Java
@Data
public class LoginTicket {

   private String userId;

   private String uuid;

   private int status;
}
```
User 类简单封装用户的 id 和 name：

```Java
@Data
public class User {

   private String userId;

   private String userName;
}
```
### 登录接口

1. 获取二维码
```Java
@RequestMapping(path = "/getQrCodeImg", method = RequestMethod.GET)
public String createQrCodeImg(Model model) {
   // 生成uuid和loginTicket对象并存入Redis
   String uuid = loginService.createQrImg();
   // 使用QrCodeUtil生成二维码
   String QrCode = Base64.encodeBase64String(QrCodeUtil.generatePng(loginURL + uuid, 300, 300));
   // 返回uuid和二维码
   model.addAttribute("uuid", uuid);
   model.addAttribute("QrCode", QrCode);
   return "login";
}
```
当访问 "localhost:8080/login/getQrCodeImg" 时，PC 端服务器会生成一个 uuid 和一个 LoginTicket 对象，然后将 uuid 作为 key，LoginTicket 对象作为 value 存入到 Redis 服务器中（设置其过期时间为 5 分钟）。接着将该 uuid 拼接到 URL 中（此 URL 即为手机端扫码后所访问的网址），并使用开源工具类 Hutool 中的 QrCodeUtil 生成二维码图片。

>关于 Hutool 的使用可以参考 https://hutool.cn/ 。 -->

<!-- 2. 扫描二维码
```Java
@RequestMapping(path = "/scan/{uuid}/{userId}", method = RequestMethod.GET)
public String scanQrCodeImg(Model model, @PathVariable("uuid") String uuid, @PathVariable("userId") String userId) {
   // 判断用户是否成功扫码
   boolean scanned = loginService.scanQrCodeImg(uuid, userId);
   // 返回扫码信息
   model.addAttribute("scanned", scanned);
   model.addAttribute("uuid", uuid);
   model.addAttribute("userId", userId);
   return "scan";
}
```
二维码中封装的信息是一个 URL，手机端扫描二维码时，会访问该 URL 所代表的的网址。此时请求中会携带手机端用户的 token 和 uuid，token 用来确认用户的身份。在上述代码中，我们简化手机端的操作，直接传入 userId，利用 userId 代替 token 来识别用户。服务器（此处为手机端服务器，但我们使用 PC 端服务器模拟手机端服务器）首先根据 userId 查询用户是否已经登录，如果 Redis 中存在该用户的信息，则表示用户已经登录。如果用户未登录或二维码已经过期，则扫码失败，返回 false；否则将 LoginTicket 对象的状态设置为 1，表示已经扫码，等待确认。

3. 确认登录
```Java
@RequestMapping(path = "/confirm/{uuid}/{userId}", method = RequestMethod.GET)
@ResponseBody
public Response confirmLogin(@PathVariable("uuid") String uuid, @PathVariable("userId") String userId) {
   // 判断用户是否成功确认
   boolean logged = loginService.confirmLogin(uuid, userId);
   String msg = logged ? "登录成功!" : "二维码已过期!";
   return Response.createResponse(msg, logged);
}
```
同扫码请求一样，确认登录时也使用 userId 代替 token 进行身份识别。手机端（在浏览器中模拟手机端操作）发送确认请求时，服务器首先检查二维码是否过期（按理来说扫码后再确认，二维码应该不会过期）。如果确认成功，那么将 LoginTicket 对象的状态设置为 2，并将 userId 置为当前用户的 id（或许 userId 在 scan 在扫码请求就应该设置为用户 id？）。

4. 轮询
```Java
@RequestMapping(path = "/getQrCodeState/{uuid}", method = RequestMethod.GET)
@ResponseBody
public Response getQrCodeState(@PathVariable("uuid") String uuid) throws InterruptedException {
   JSONObject data = new JSONObject();
   // 检查二维码是否过期
   String redisKey = CommonUtil.getTicketKey(uuid);
   LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);
   if (loginTicket == null) {
      data.put("status", -1);
      return Response.createResponse("二维码已过期!", data);
   }
   // 检查status
   int status = loginTicket.getStatus();
   data.put("status", status);
   if (status == 2) {
      // 用户已确认登录
      String userId = loginTicket.getUserId();
      User user = userService.getLoggedUser(userId);
      if (user != null) {
         // 生成token
         String token = TokenUtil.buildToken(userId, user.getUserName());
         data.put("token", token);
         return Response.createResponse(null, data);
      }
      return Response.createErrorResponse("无用户信息!");
   }
   // 2s轮询一次
   Thread.sleep(2000);
   String msg = status == 0 ? null : "已扫描, 等待确认";
   return Response.createResponse(msg, data);
}
```
轮询的逻辑其实就是根据 uuid 检查 LoginTicket 对象的状态，如果 LoginTicket 对象为空，表示二维码已经过期；如果 status 为 0，表示等待扫码；如果 status 为 1，表示已扫码，等待确认；如果 status 为 2，表示已确认登录。当检测到用户确认登录后，服务器为用户生成 token（此 token 用于 PC 端服务器识别用户身份），然后将 token 返回给前端。注意，上述代码生成 token 之前，调用了 UserService 中的 getLoggedUser 方法来查询用户的身份信息，在此 demo 中，为了简化操作，凡是需要获取用户信息的地方我们都使用该方法去获取，如前面手机端服务器（其实也是在 PC 端模拟）根据 token （为了简化，实际上为 userId）查询用户信息时也调用了该方法。还有一点需要注意，最后一步的 token 也可以使用 cookie 来代替，这样也许会更加简单，因为想学习一下 JWT，所以采用 token（使用 token 访问时，token 应该怎样保存呢，苦恼!!!!!+10086）。getLoggedUser 方法其实就是检测 Redis 中有无用户的身份信息，代码如下：
```Java
public User getLoggedUser(String userId) {
   String redisKey = CommonUtil.getUserKey(userId);
   return (User) redisTemplate.opsForValue().get(redisKey);
}
```
### Service 层
Service 层对应的代码如下：
```Java
@Service
public class LoginService {

   private final int WAIT_EXPIRED_SECONDS = 60 * 5;

   private final int LOGIN_EXPIRED_SECONDS = 3600 * 24;

   @Autowired
   private RedisTemplate redisTemplate;

   public String createQrImg() {
      // 生成loginTicket
      String uuid = CommonUtil.generateUUID();
      LoginTicket loginTicket = new LoginTicket();
      loginTicket.setUuid(uuid);
      loginTicket.setStatus(0);
      // 存入redis
      String redisKey = CommonUtil.getTicketKey(loginTicket.getUuid());
      redisTemplate.opsForValue().set(redisKey, loginTicket, WAIT_EXPIRED_SECONDS, TimeUnit.SECONDS);
      return uuid;
   }

   public boolean scanQrCodeImg(String uuid, String userId) {
      String ticketKey = CommonUtil.getTicketKey(uuid);
      String userKey = CommonUtil.getUserKey(userId);
      LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(ticketKey);
      User user = (User) redisTemplate.opsForValue().get(userKey);
      // 检测用户是否登录以及二维码是否过期
      if (user == null || loginTicket == null) {
         return false;
      } else {
         // 将status置为1
         loginTicket.setStatus(1);
         redisTemplate.opsForValue().set(ticketKey, loginTicket, redisTemplate.getExpire(ticketKey, TimeUnit.SECONDS), TimeUnit.SECONDS);
      }
      return true;
   }

   public boolean confirmLogin(String uuid, String userId) {
      String redisKey = CommonUtil.getTicketKey(uuid);
      LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);
      boolean logged = true;
      if (loginTicket == null) {
         logged = false;
      } else {
         // 将userId置为用户id, 并将status置为2
         loginTicket.setUserId(userId);
         loginTicket.setStatus(2);
         redisTemplate.opsForValue().set(redisKey, loginTicket, LOGIN_EXPIRED_SECONDS, TimeUnit.SECONDS);
      }
      return logged;
   }
}
```
前端的几个 xx.html 文件的代码写得不太好，大家直接看源码吧，源码我会放在文末。 -->

<!-- ## 效果演示
执行程序前，我们需要在 Redis 中存储当前用户的信息，表示用户在手机端已经登录，其中 key 的格式为 user:userId，value 为 User 对象。比如在演示前，我们在 Redis 中存储了 userId 为 "1" 的用户 "Join同学"。

演示动图如下：
![扫码登录演示图](./loginByQrCode.gif) -->

<!-- 1. 启动项目，打开浏览器，访问 localhost:8080/index，显示 '首页'；
2. 点击 '登录'，进入二维码登录界面；
3. 使用开发者工具获取生成的 uuid；
4. 模仿手机端，在另外一个页面中访问 localhost:8080/login/scan/uuid/userId，注意 uuid 为步骤 3 中获取的 uuid，userId 所对应的 User 需要存储在 Redis 中（表示手机端用户已登录，Redis 中的 key 为 userId，value 为 User 对象）。
5. 弹出确认登录窗口；
6. 此时首页上显示等待确认；
7. 点解确认登录
8. 登陆成功；
9. 首页上显示登录用户的信息。 -->

<!-- ## 待改进
1. 整个流程应该存在手机端服务器和 PC 端服务器，但为了简化操作，我们利用 PC 端模拟手机端，比如扫码和确认请求应该由手机端服务器处理，而程序中我们直接在 PC 端访问对应的 Controller；
2. 检查扫码状态时采用了轮询的方式，或许可以采用 Websocket；
3. "手机端" 验证 "token" 时，我们使用 userId 来简化操作；
4. 最后一步我们将 token 返回给了前端，前端发送请求时，需要在 header 中存放 token，但问题是 token 应该如何保存呢？之后需要解决此问题；
5. 未学习过前端，所以代码不怎么规范。

### **欢迎批评指正，源码见** -->
            </div>
            <hr />

            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #e6c5c4;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }

    img[src=""],img:not([src]){
        opacity:0;
    }
</style>



    <!-- <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Java 语言实现简易版扫码登录》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/java-yu-yan-shi-xian-jian-yi-sao-ma-deng-lu.html" property="cc:attributionName"
               rel="cc:attributionURL">
                John同学
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div> -->

    <div class="reprint" id="reprint-statement">
        
        <div class="reprint__author">
            <span class="reprint-meta">
                <i class="fa fa-user" style="font-weight: bold;">
                    作者:
                </i>
            </span>
            <span class="reprint-info">
                本文由
                <a href="https://mrjohnzh.github.io" rel="external nofollow noreferrer">John同学</a>
                创作。
            </span>
        </div>
        <!-- <div class="reprint__type">
            <span class="reprint-meta" style="font-weight: bold;">
                <i class="fa fa-link">
                    文章链接:
                </i>
            </span>
            <span class="reprint-info">
                <a href="https://javaguide.cn/2019/08/21/java/java%E5%9F%BA%E7%A1%80/BIO,NIO,AIO%20%E6%80%BB%E7%BB%93/">https://javaguide.cn/2019/08/21/java/java%E5%9F%BA%E7%A1%80/BIO,NIO,AIO%20%E6%80%BB%E7%BB%93/</a>
            </span>
        </div> -->
        <div class="reprint__notice">
            <span class="reprint-meta">
                <i class="fa fa-copyright" style="font-weight: bold;">
                    版权声明:
                </i>
            </span>
            <span class="reprint-info">
                本博客所有文章除特別声明外，均采用
                <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                许可协议，转载请注明来源！
            </span>
        </div>

        <div class="reprint__type">
            <span class="reprint-meta">
                <i class="fa fa-thumbs-up" style="font-weight: bold;">
                    <!-- 求打赏: -->
                    求关注: 
                </i>
            </span>
            <span class="reprint-info">
                <!-- 写作不易，客官能否打赏一杯奶茶 -->
                写作不易，客官能否点个关注
                <!-- <a href="#rewardModal" class="reward-link modal-trigger fa fa-coffee"></a> -->
                <a class="fa fa-heart" onmouseover="on()" onmouseout="off()"></a>
                支持一下。
            </span>

            <!-- Modal Structure -->
            <!-- <div id="rewardModal" class="modal">
                <div class="modal-content">
                    <a class="close modal-close"><i class="fa fa-close"></i></a>
                    <h4 class="reward-title"></h4>
                    <div class="reward-content">
                        <div class="reward-tabs">
                            <ul class="tabs row">
                                <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                                <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                            </ul>
                            <div id="alipay">
                                <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                            </div>
                            <div id="wechat">
                                <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>
        
        <!-- <div class="social-share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
            <div class="social-share" data-sites="twitter, facebook, qq, wechat" data-wechat-qrcode-helper=""></div>
        </div> -->
    </div>
    <body>
        <img id="s" src=""/>
    </body>


    <script>
        function on() {
            $("#s").attr("src", "https://cdn.jsdelivr.net/gh/mrjohnzh/Common@1.2/imgs/%E5%85%AC%E4%BC%97%E5%8F%B7JohnLearning.png");
            $(document).mousemove(function(e) {
                // $("#s").css("position", "absolute").css("left", e.pageX+1+"px").css("top", e.pageY+1+"px");
                $("#s").css("position", "absolute").css("left", e.pageX-285+"px").css("top", e.pageY-500+"px");
            })
        }
    
        /**
         * 关闭图片, 当鼠标移出时执行
         */
        function off() {
            $("#s").attr("src", "");
            $(document).mousemove(function(e) {
                $("#s").css("position", "absolute").css("left", "-400px").css("top", "-400px");
            })
        }
    </script>

    
    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
    <script src="/libs/share/js/social-share.min.js"></script>
    

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span style="font-family: KaiTi">复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller; font-family: KaiTi">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>

    <script>
        $(function () {
            $('.tabs').tabs();
        });
    </script>



        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC81NDY2NS8zMTEzNg==">
        <script type="text/javascript">
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
    })(document, 'script');
        </script>
    <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/mvc-he-san-ceng-jia-gou.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="MVC 和三层架构">
                        
                        <span class="card-title">MVC 和三层架构</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            MVC 和三层架构都是目前非常流行的开发模式，作为后端开发人员，很有必要了解一下二者的设计理念。为此，本文会对 MVC 和三层架构做一个简单的概述。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-05-02
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/技术学习/" class="post-category" target="_blank">
                                    技术学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/" target="_blank">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/Web/" target="_blank">
                        <span class="chip bg-color">Web</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/nginx-shi-xian-dong-jing-fen-chi.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/52.jpg" class="responsive-img" alt="利用 Nginx 实现动静分离">
                        
                        <span class="card-title">利用 Nginx 实现动静分离</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            动静分离指的是将动态请求和静态请求分隔开，然后分别路由到相应的后端服务器。通常用户的请求中，一部分需要后台程序处理，例如查询数据库或者进行一些数据运算，这类请求我们称之为动态请求；还有一部分不需要后台程序处理，如请求 css、html、js、图片等静态资源，这类请求我们称之为静态请求。Nginx 实现动静分离的基础是它可以根据配置对不同的请求做不同的转发，动静分离有利于提高整个服务器系统的性能。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-03-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/计算机网络/" class="post-category" target="_blank">
                                    计算机网络
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Nginx/" target="_blank">
                        <span class="chip bg-color">Nginx</span>
                    </a>
                    
                    <a href="/tags/计网/" target="_blank">
                        <span class="chip bg-color">计网</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
       <div class="Copy-right">
            &copy; 2021 John同学. All Rights Reserved.</br>

                    
           <!--<a href="/sitemap.xml" target="_blank">站点地图</a>丨-->
           <!-- 
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">34.4k
             丨             -->
          

            <span id="sitetime"></span>

            
            
             
            
            </br><span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-users"></i>
            总访问量: <span id="busuanzi_value_site_pv" class="red-color"></span>
            次</span>  &nbsp;|&nbsp;
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>&nbsp;<i class="fa fa-user"></i>
                总访问人数: <span id="busuanzi_value_site_uv" class="blue-color"></span>&nbsp;人
            </span>
            
            
        </div>        
    </div>
    <!-- <div class="container row center-align">
    <div class="github-badge">
      <a style="color: #fff" rel="license" href="https://hexo.io/" target="_blank" title="由 Hexo 强力驱动">
      <span class="badge-subject">Powered</span><span class="badge-value bg-blue">Hexo</span></a>
    </div> -->
    <!-- <div class="github-badge">
      <a style="color: #fff" rel="license" href="https://github.com/" target="_blank" title="静态网页托管于 GitHub Pages 和 Coding Pages">
      <span class="badge-subject">Hosted</span><span class="badge-value bg-brightgreen">GitHub & Coding</span></a>
    </div> -->
    <!-- <div class="github-badge">
      <a style="color: #fff" rel="license" href="https://www.cloud.tencent.com/" target="_blank" title="腾讯云提供域名相关服务">
      <span class="badge-subject">DNS</span><span class="badge-value bg-blueviolet">Tencent cloud</span></a>
    </div> -->
    <!-- <div class="github-badge">
      <a style="color: #fff" rel="license" href="https://www.jsdelivr.com/" target="_blank" title="jsDelivr 提供 CDN 加速服务">
      <span class="badge-subject">CDN</span><span class="badge-value bg-orange">jsDelivr</span></a>
    </div> -->
    <!-- <div class="github-badge">
        <a style="color: #fff" rel="license" href="https://github.com/blinkfox/hexo-theme-matery/" target="_blank" title="站点使用 Matery 主题">
      <span class="badge-subject">Theme</span><span class="badge-value bg-blue">Matery</span></a>
    </div> -->
    <!-- <div class="github-badge">
      <a style="color: #fff" rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="本站点采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可">
      <span class="badge-subject"><i class="fa fa-copyright"></i></span><span class="badge-value bg-lightgrey">BY-NC-SA 4.0</span></a>
    </div> -->
    <!-- <div class="github-badge">
      <a style="color: #fff" rel="license" href="https://996.icu/" target="_blank" title="支持 996.ICU">
      <span class="badge-subject">Link</span><span class="badge-value bg-red">996.ICU</span></a>
    </div> -->
    <!-- <div class="github-badge">
      <span class="badge-subject">UV</span><span class="badge-value bg-orange" id="busuanzi_value_site_uv"></span>
    </div> -->
    <!-- <div class="github-badge">
      <span class="badge-subject">PV</span><span class="badge-value bg-brightgreen" id="busuanzi_value_site_pv"></span>
    </div>
    <div class="github-badge">
      <span class="badge-subject">WordCount</span><span class="badge-value bg-blueviolet">34.4k</span>
    </div> -->
</footer>


<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 0;
        var uvcountOffset = 0;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 09, 17, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
// $(function () {
//     searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
// });
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- <script type="text/javascript"> 
    var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script> -->

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

   <!--单击显示文字-->
   <script type="text/javascript" src="/js/click_show_text.js"></script> 

   <!--动态线条背景-->
   <script type="text/javascript"
   color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
   </script>

   <!-- <script async src ="https://cdn.jsdelivr.net/npm/perfops-rom"> </script> -->

   <!--自定义看板娘-->
   <!-- <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
   <!-- <script src="/live2d-widget/autoload.js"></script> -->
   <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/> -->

</body>

</html>